<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }}</title>
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts - Inter for a modern, clean look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- D3.js for charts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        /* Define Color Palettes for Light and Dark Mode */
        :root {
            /* Light Mode Colors */
            --bg: #F7F8FA; /* Very light gray background */
            --card-bg: #FFFFFF; /* White card background */
            --text: #333333; /* Dark gray text */
            --secondary-text: #666666; /* Medium gray secondary text */
            --border: #E0E0E0; /* Light gray border */
            --primary: #4A90E2; /* Blue primary color */
            --primary-dark: #357ABD; /* Darker blue for hover */
            --accent: #FFC107; /* Amber accent */
            --success: #28A745; /* Green for success */
            --error: #DC3545; /* Red for error */
            --warning: #FFC107; /* Yellow for warning */
            --info: #17A2B8; /* Cyan for info */
            --shadow-light: rgba(0, 0, 0, 0.05); /* Light shadow */
            --input-bg: #F0F2F5; /* Light gray for input backgrounds */
            --input-border: #D1D5DA; /* Slightly darker gray for input borders */
            --hover-bg: #E9ECEF; /* Light gray for hover states */
            --active-bg: #DEE2E6; /* Even lighter gray for active states */

            /* Chart Colors */
            --chart-axis-text: #666666;
            --chart-color-booked: #4A90E2; /* Primary blue */
            --chart-color-cancelled: #DC3545; /* Error red */
            --chart-platform1: #4A90E2;
            --chart-platform2: #28A745;
            --chart-platform3: #FFC107;
            --chart-platform4: #17A2B8;
            --chart-platform5: #6F42C5; /* Purple */
            --chart-platform6: #FD7E14; /* Orange */
        }

        /* Dark Mode Colors */
        html[data-theme='dark'] {
            --bg: #1A202C; /* Dark blue-gray background */
            --card-bg: #2D3748; /* Darker blue-gray card background */
            --text: #E2E8F0; /* Light gray text */
            --secondary-text: #A0AEC0; /* Medium light gray secondary text */
            --border: #4A5568; /* Darker gray border */
            --primary: #63B3ED; /* Lighter blue primary color */
            --primary-dark: #4299E1; /* Darker blue for hover */
            --accent: #F6AD55; /* Orange accent */
            --success: #48BB78; /* Green for success */
            --error: #FC8181; /* Red for error */
            --warning: #F6AD55; /* Orange for warning */
            --info: #63B3ED; /* Light blue for info */
            --shadow-light: rgba(0, 0, 0, 0.3); /* Darker shadow */
            --input-bg: #4A5568; /* Dark gray for input backgrounds */
            --input-border: #6B7280; /* Slightly lighter gray for input borders */
            --hover-bg: #4A5568; /* Dark gray for hover states */
            --active-bg: #6B7280; /* Even darker gray for active states */

            /* Chart Colors for Dark Mode */
            --chart-axis-text: #A0AEC0;
            --chart-color-booked: #63B3ED;
            --chart-color-cancelled: #FC8181;
            --chart-platform1: #63B3ED;
            --chart-platform2: #48BB78;
            --chart-platform3: #F6AD55;
            --chart-platform4: #63B3ED;
            --chart-platform5: #9F7AEA; /* Purple */
            --chart-platform6: #FBD38D; /* Light orange */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            display: flex; /* Use flexbox for layout */
            min-height: 100vh; /* Full viewport height */
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .sidebar {
            width: 250px;
            background-color: var(--card-bg); /* Use card-bg for sidebar for consistency */
            padding: 20px;
            box-shadow: 2px 0 5px var(--shadow-light);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex-shrink: 0; /* Prevent sidebar from shrinking */
            transition: width 0.3s ease;
            position: fixed; /* Make sidebar fixed */
            height: 100vh; /* Full height */
            top: 0;
            left: 0;
            overflow-y: auto; /* Enable scrolling for sidebar content if it overflows */
            z-index: 999; /* Ensure sidebar is above main content but below modals */
        }

        .sidebar.collapsed {
            width: 80px; /* Collapsed width */
        }

        .sidebar h2 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 30px;
            font-weight: 700;
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden; /* Hide overflow when collapsed */
        }

        .sidebar.collapsed h2 {
            font-size: 1.2em; /* Smaller font when collapsed */
        }

        .sidebar nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar nav ul li {
            margin-bottom: 10px;
        }

        .sidebar nav ul li a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--secondary-text); /* Use secondary-text for links */
            text-decoration: none;
            border-radius: 8px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .sidebar nav ul li a i {
            margin-right: 10px;
            font-size: 1.1em;
            transition: margin-right 0.3s ease;
        }

        .sidebar.collapsed nav ul li a i {
            margin-right: 0; /* No margin when collapsed */
        }

        .sidebar nav ul li a span {
            opacity: 1;
            transition: opacity 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
        }

        .sidebar.collapsed nav ul li a span {
            opacity: 0; /* Hide text when collapsed */
            width: 0; /* Collapse text width */
        }

        .sidebar nav ul li a:hover {
            background-color: var(--hover-bg); /* Use hover-bg */
            color: var(--text); /* Darker text on hover */
        }

        .sidebar nav ul li a.active {
            background-color: var(--active-bg); /* Use active-bg */
            color: var(--primary); /* Primary color for active link */
            font-weight: 600;
        }

        .logout-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 15px;
            background-color: var(--input-bg); /* Use input-bg for logout button */
            color: var(--secondary-text);
            text-decoration: none;
            border-radius: 8px;
            transition: background-color 0.3s ease, color 0.3s ease;
            margin-top: 20px;
        }

        .logout-btn:hover {
            background-color: var(--hover-bg);
            color: var(--text);
        }

        .main-content {
            flex-grow: 1;
            padding: 20px;
            margin-left: 250px; /* Initial margin to offset fixed sidebar */
            transition: margin-left 0.3s ease; /* Adjust margin for sidebar collapse */
        }

        .main-content.sidebar-collapsed {
            margin-left: 80px; /* Adjust based on sidebar collapsed width */
        }

        .header-main {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-light);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        .header-main h1 {
            margin: 0;
            color: var(--primary);
            flex-grow: 1; /* Allow title to take space */
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: auto; /* Push controls to the right */
        }

        .header-controls span {
            font-weight: 500;
            color: var(--secondary-text);
        }

        .icon-button {
            background: none;
            border: none;
            color: var(--secondary-text);
            font-size: 1.2em;
            cursor: pointer;
            transition: color 0.3s ease;
            position: relative;
            padding: 5px; /* Add padding for easier clicking */
        }

        .icon-button:hover {
            color: var(--primary);
        }

        .notification-badge {
            position: absolute;
            top: 0px;
            right: 0px;
            background-color: var(--error);
            color: white;
            border-radius: 50%;
            padding: 3px 7px;
            font-size: 0.7em;
            font-weight: 700;
            display: none; /* Hidden by default */
        }

        .card {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-light);
            margin-bottom: 20px;
        }

        .card h2 {
            color: var(--primary);
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            background-color: var(--input-bg); /* Use input-bg for stat items */
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 1px 3px var(--shadow-light);
            display: flex; /* Flexbox for icon and text alignment */
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .stat-item .icon {
            font-size: 2.5em; /* Larger icon size */
            color: var(--primary); /* Primary color for icons */
            margin-bottom: 10px;
        }

        .stat-item h3 {
            margin-top: 0;
            color: var(--secondary-text);
            font-size: 1em;
            font-weight: 500;
        }

        .stat-item p {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0 0;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .chart-card {
            min-height: 300px; /* Ensure charts have height */
        }

        .chart-card svg {
            width: 100%;
            height: 100%;
        }

        /* D3 Chart specific styles */
        .axis path,
        .axis line {
            fill: none;
            stroke: var(--border);
            shape-rendering: crispEdges;
        }

        .grid path {
            stroke: var(--border);
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }

        .grid line {
            stroke: var(--border);
            stroke-opacity: 0.3;
            shape-rendering: crispEdges;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            text-align: left;
        }

        .data-table th {
            background-color: var(--input-bg);
            color: var(--secondary-text);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        .data-table tbody tr:hover {
            background-color: var(--hover-bg);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap; /* Prevent button text from wrapping */
        }
        .btn-primary {
            background-color: var(--primary);
            color: #fff;
            box-shadow: 0 2px 4px rgba(74, 144, 226, 0.3);
        }
        .btn-primary:hover {
            background-color: var(--primary-dark);
            box-shadow: 0 4px 8px rgba(74, 144, 226, 0.4);
        }
        .btn-info { /* For Assign button */
            background-color: var(--info);
            color: #fff;
        }
        .btn-info:hover {
            background-color: #138496; /* Darker info */
        }
        .btn-success {
            background-color: var(--success);
            color: #fff;
        }
        .btn-success:hover {
            background-color: #218838; /* Darker success */
        }
        .btn-danger {
            background-color: var(--error);
            color: #fff;
        }
        .btn-danger:hover {
            background-color: #C82333; /* Darker error */
        }
        .btn-secondary {
            background-color: var(--input-bg);
            color: var(--text);
        }
        .btn-secondary:hover {
            background-color: var(--hover-bg);
        }
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.85em;
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: capitalize;
        }
        .badge-pending { background-color: #FFECB3; color: #FF8F00; } /* Warning yellow */
        .badge-in_progress { background-color: #BBDEFB; color: #1976D2; } /* Info blue */
        .badge-completed { background-color: #C8E6C9; color: #388E3C; } /* Success green */
        .badge-cancelled { background-color: #FFCDD2; color: #D32F2F; } /* Error red */
        .badge-amenity_request { background-color: #E1BEE7; color: #6A1B9A; } /* Purple */
        .badge-maintenance { background-color: #FFCDD2; color: #C62828; } /* Dark Red */
        .badge-housekeeping { background-color: #C8E6C9; color: #2E7D32; } /* Dark Green */
        .badge-room_service { background-color: #FFF9C4; color: #FBC02D; } /* Dark Yellow */
        .badge-concierge { background-color: #BBDEFB; color: #1565C0; } /* Dark Blue */
        .badge-general_inquiry { background-color: #E0E0E0; color: #424242; } /* Grey */
        .badge-casual_chat { background-color: #CFD8DC; color: #546E7A; } /* Light Grey */


        /* Tab Navigation */
        .tab-nav {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
            overflow-x: auto; /* Allow horizontal scrolling for many tabs */
        }

        .tab-nav-item {
            padding: 10px 15px;
            cursor: pointer;
            color: var(--secondary-text);
            text-decoration: none;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            transition: border-color 0.3s ease, color 0.3s ease;
        }

        .tab-nav-item:hover {
            color: var(--primary);
        }

        .tab-nav-item.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        /* Sub-tab Navigation */
        .sub-tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow wrapping */
        }

        .sub-tab-nav-item {
            padding: 8px 12px;
            background-color: var(--input-bg);
            border-radius: 5px;
            color: var(--secondary-text);
            text-decoration: none;
            white-space: nowrap;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .sub-tab-nav-item:hover {
            background-color: var(--hover-bg);
        }

        .sub-tab-nav-item.active {
            background-color: var(--primary);
            color: white;
            font-weight: 500;
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--shadow-light);
            width: 90%;
            max-width: 600px; /* Increased max-width for better content display */
            position: relative;
            transform: translateY(-20px);
            opacity: 0;
            animation: modalFadeIn 0.3s forwards;
        }

        @keyframes modalFadeIn {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-close-button {
            color: var(--secondary-text);
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .modal-close-button:hover,
        .modal-close-button:focus {
            color: var(--text);
            text-decoration: none;
            cursor: pointer;
        }

        .modal-header {
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--primary);
        }

        .modal-footer {
            border-top: 1px solid var(--border);
            padding-top: 15px;
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--secondary-text);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            background-color: var(--input-bg);
            color: var(--text);
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
            outline: none;
        }

        .form-check-input {
            margin-right: 8px;
        }

        .error-message {
            color: var(--error);
            font-size: 0.85em;
            margin-top: 5px;
            display: block;
        }

        /* Message Box */
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 1001; /* Above modals */
        }

        .message-box.show {
            opacity: 1;
            transform: translateY(0);
        }

        .message-box.success { background-color: var(--success); }
        .message-box.error { background-color: var(--error); }
        .message-box.info { background-color: var(--info); }
        .message-box.warning { background-color: var(--warning); }

        /* Confirmation Modal */
        #confirmationModal .modal-content {
            max-width: 400px;
            text-align: center;
        }
        #confirmationModal .modal-footer {
            justify-content: center;
        }
        #confirmationModal p {
            margin-bottom: 20px;
            color: var(--text);
        }

        /* Chat History in Request Details Modal */
        .chat-history-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            background-color: var(--input-bg);
        }
        .chat-message {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 5px;
        }
        .chat-message.user {
            background-color: #e0f2f7; /* Light blue for user */
            text-align: right;
        }
        .chat-message.conci {
            background-color: #f0f0f0; /* Light gray for conci */
            text-align: left;
        }
        html[data-theme='dark'] .chat-message.user {
            background-color: #3182CE; /* Darker blue for user in dark mode */
            color: white;
        }
        html[data-theme='dark'] .chat-message.conci {
            background-color: #4A5568; /* Darker gray for conci in dark mode */
            color: #E2E8F0;
        }
        .chat-message strong {
            font-weight: 600;
            margin-right: 5px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                box-shadow: 0 2px 5px var(--shadow-light);
                position: relative; /* Make sidebar relative on mobile */
                overflow-y: visible; /* Allow content to push height */
            }
            .sidebar.collapsed {
                width: 100%;
                height: auto;
            }
            .sidebar nav ul {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }
            .sidebar nav ul li {
                margin: 5px;
            }
            .sidebar nav ul li a {
                padding: 8px 12px;
            }
            .sidebar nav ul li a i {
                margin-right: 5px;
            }
            .sidebar.collapsed nav ul li a span {
                opacity: 1; /* Always show text on mobile */
                width: auto;
            }
            .main-content {
                padding: 15px;
                margin-left: 0; /* No margin adjustment on mobile */
            }
            .header-main {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .header-controls {
                margin-left: 0;
                width: 100%;
                justify-content: space-between;
            }
            .stats-grid, .charts-container {
                grid-template-columns: 1fr;
            }
            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    {% csrf_token %} <!-- CSRF token for Django forms -->
    <div class="message-box" id="messageBox"></div>

    <div class="sidebar" id="sidebar">
        <div>
            <h2>ConciAI</h2>
            <nav>
                <ul>
                    <li><a href="{% url 'main:home_dashboard' %}" class="{% if current_main_tab == 'home' %}active{% endif %}"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
                    <li><a href="{% url 'main:guest_requests_dashboard' %}" class="{% if current_main_tab == 'requests' %}active{% endif %}"><i class="fas fa-bell"></i> <span>Guest Requests</span></a></li>
                    <li><a href="{% url 'main:guest_management' %}" class="{% if current_main_tab == 'guest_management' %}active{% endif %}"><i class="fas fa-users"></i> <span>Guest Management</span></a></li>
                    <li><a href="{% url 'main:amenity_management' %}" class="{% if current_main_tab == 'amenities' %}active{% endif %}"><i class="fas fa-concierge-bell"></i> <span>Amenity Management</span></a></li>
                    <!-- Add more navigation items as needed -->
                </ul>
            </nav>
        </div>
        <!-- Sidebar Toggle Button - Moved inside sidebar -->
        <button id="sidebarToggle" class="icon-button" style="position: absolute; bottom: 20px; right: 20px; background: var(--input-bg); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px var(--shadow-light);">
            <i class="fas fa-chevron-left"></i>
        </button>
        <a href="{% url 'logout' %}" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
        </a>
    </div>

    <div class="main-content" id="mainContent">
        <header class="header-main">
            <h1>{{ page_title }}</h1>
            <div class="header-controls">
                <button id="notificationBell" class="icon-button">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationBadge">0</span>
                </button>
                <button id="themeToggleButton" class="icon-button">
                    <i class="fas fa-moon"></i>
                </button>
                <span style="font-weight: 500;">Welcome, {{ request.user.username }}</span>
            </div>
        </header>

        {% if current_main_tab == 'home' %}
            <div class="card">
                <h2>Overview</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <i class="fas fa-hotel icon"></i>
                        <h3>Total Rooms</h3>
                        <p>{{ total_rooms }}</p>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-door-open icon"></i>
                        <h3>Occupied Rooms</h3>
                        <p>{{ occupied_rooms }}</p>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-bookmark icon"></i>
                        <h3>Reserved Rooms</h3>
                        <p>{{ reserved_rooms }}</p>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-bed icon"></i>
                        <h3>Available Rooms</h3>
                        <p>{{ available_rooms }}</p>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-ban icon"></i>
                        <h3>Rooms Not Ready</h3>
                        <p>{{ not_ready_rooms }}</p>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-calendar-plus icon"></i>
                        <h3>New Bookings Today</h3>
                        <p>{{ new_bookings_count }}</p>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-sign-in-alt icon"></i>
                        <h3>Check-ins Today</h3>
                        <p>{{ check_ins_today_count }}</p>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-sign-out-alt icon"></i>
                        <h3>Check-outs Today</h3>
                        <p>{{ check_outs_today_count }}</p>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-concierge-bell icon"></i>
                        <h3>Total Guest Requests</h3>
                        <p>{{ total_requests_count }}</p>
                    </div>
                </div>
            </div>

            <div class="charts-container">
                <div class="card chart-card">
                    <h2>Reservations (Last 7 Days)</h2>
                    <svg id="reservationsChart"></svg>
                </div>
                <div class="card chart-card">
                    <h2>Bookings by Platform</h2>
                    <svg id="bookingPlatformChart"></svg>
                </div>
            </div>

        {% elif current_main_tab == 'requests' %}
            <div class="card">
                <h2>Guest Requests</h2>
                <div class="tab-nav">
                    <a href="{% url 'main:active_requests' %}" class="tab-nav-item {% if current_sub_tab == 'active' %}active{% endif %}">Active Requests</a>
                    <a href="{% url 'main:archive_requests' %}" class="tab-nav-item {% if current_sub_tab == 'archive' %}active{% endif %}">Archived Requests</a>
                    <a href="{% url 'main:all_requests' %}" class="tab-nav-item {% if current_sub_tab == 'all' %}active{% endif %}">All Requests</a>
                </div>

                {% for group in grouped_requests %}
                    {% if group.requests %}
                        <h3>{{ group.display_name }}</h3>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Request ID</th>
                                        <th>Room</th>
                                        <th>Guest</th>
                                        <th>Description</th>
                                        <th>Status</th>
                                        <th>Assigned Staff</th>
                                        <th>Received At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in group.requests %}
                                        <tr>
                                            <td>{{ item.request.id }}</td>
                                            <td>{{ item.request.room_number }}</td>
                                            <td>{{ item.assignment.guest_names|default:"N/A" }}</td>
                                            <td>{{ item.request.raw_text|truncatechars:70 }}</td>
                                            <td><span class="badge badge-{{ item.request.status }}">{{ item.request.get_status_display }}</span></td>
                                            <td>{{ item.assigned_staff_name|default:"Unassigned" }}</td>
                                            <td>{{ item.request.timestamp|date:"M d, Y H:i" }}</td>
                                            <td>
                                                <button class="btn btn-primary btn-sm view-details" data-request-id="{{ item.request.id }}">View Details</button>
                                                <button class="btn btn-info btn-sm assign-request-button" data-request-id="{{ item.request.id }}" {% if item.request.assigned_staff %}disabled{% endif %}>
                                                    {% if item.request.assigned_staff %}Assigned{% else %}Assign{% endif %}
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                {% empty %}
                    <p class="text-center">No requests found for this category.</p>
                {% endfor %}
            </div>

        {% elif current_main_tab == 'guest_management' %}
            <div class="card">
                <h2>Guest Room Assignments</h2>
                <div class="btn-group">
                    <button class="btn btn-primary" id="addAssignmentButton">
                        <i class="fas fa-plus"></i> Add New Assignment
                    </button>
                </div>

                <!-- Filter Form -->
                <form method="GET" class="filter-form" style="margin-bottom: 20px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end;">
                        <div class="form-group" style="flex: 1 1 150px;">
                            <label for="room_number_filter">Room Number:</label>
                            <input type="text" id="room_number_filter" name="room_number" class="form-control" value="{{ filter_params.room_number|default:'' }}">
                        </div>
                        <div class="form-group" style="flex: 1 1 200px;">
                            <label for="guest_names_filter">Guest Names:</label>
                            <input type="text" id="guest_names_filter" name="guest_names" class="form-control" value="{{ filter_params.guest_names|default:'' }}">
                        </div>
                        <div class="form-group" style="flex: 1 1 150px;">
                            <label for="status_filter">Status:</label>
                            <select id="status_filter" name="status" class="form-control">
                                <option value="">All</option>
                                {% for value, label in assignment_status_choices %}
                                    <option value="{{ value }}" {% if filter_params.status == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1 1 150px;">
                            <label for="check_in_date_from_filter">Check-in From:</label>
                            <input type="date" id="check_in_date_from_filter" name="check_in_date_from" class="form-control" value="{{ filter_params.check_in_date_from|default:'' }}">
                        </div>
                        <div class="form-group" style="flex: 1 1 150px;">
                            <label for="check_in_date_to_filter">Check-in To:</label>
                            <input type="date" id="check_in_date_to_filter" name="check_in_date_to" class="form-control" value="{{ filter_params.check_in_date_to|default:'' }}">
                        </div>
                        <div class="form-group" style="flex: 1 1 150px;">
                            <label for="check_out_date_from_filter">Check-out From:</label>
                            <input type="date" id="check_out_date_from_filter" name="check_out_date_from" class="form-control" value="{{ filter_params.check_out_date_from|default:'' }}">
                        </div>
                        <div class="form-group" style="flex: 1 1 150px;">
                            <label for="check_out_date_to_filter">Check-out To:</label>
                            <input type="date" id="check_out_date_to_filter" name="check_out_date_to" class="form-control" value="{{ filter_params.check_out_date_to|default:'' }}">
                        </div>
                        <div style="flex: 1 1 auto; display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-primary">Apply Filters</button>
                            <a href="{% url 'main:guest_management' %}" class="btn btn-secondary">Clear Filters</a>
                        </div>
                    </div>
                </form>

                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Room No.</th>
                                <th>Guest Names</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>Status</th>
                                <th>Total Bill</th>
                                <th>Amount Paid</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in all_assignments %}
                                <tr>
                                    <td>{{ assignment.id }}</td>
                                    <td>{{ assignment.room_number }}</td>
                                    <td>{{ assignment.guest_names }}</td>
                                    <td>{{ assignment.check_in_time|date:"M d, Y H:i" }}</td>
                                    <td>{{ assignment.check_out_time|date:"M d, Y H:i" }}</td>
                                    <td><span class="badge badge-{{ assignment.status }}">{{ assignment.get_status_display }}</span></td>
                                    <td>${{ assignment.total_bill_amount|floatformat:2 }}</td>
                                    <td>${{ assignment.amount_paid|floatformat:2 }}</td>
                                    <td>
                                        <button class="btn btn-primary btn-sm edit-assignment-button" data-assignment-id="{{ assignment.id }}">Edit</button>
                                        <button class="btn btn-danger btn-sm delete-assignment-button" data-assignment-id="{{ assignment.id }}">Delete</button>
                                    </td>
                                </tr>
                            {% empty %}
                                <tr><td colspan="9" class="text-center">No guest assignments found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        {% elif current_main_tab == 'amenities' %}
            <div class="card">
                <h2>Amenity Management</h2>
                <div class="btn-group">
                    <button class="btn btn-primary" id="addAmenityButton">
                        <i class="fas fa-plus"></i> Add New Amenity
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Price</th>
                                <th>Available</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for amenity in amenities %}
                                <tr>
                                    <td>{{ amenity.name }}</td>
                                    <td>{{ amenity.description|default:"N/A" }}</td>
                                    <td>${{ amenity.price|floatformat:2 }}</td>
                                    <td>
                                        {% if amenity.is_available %}
                                            <span class="badge badge-success">Yes</span>
                                        {% else %}
                                            <span class="badge badge-cancelled">No</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-sm edit-amenity-button" data-amenity-id="{{ amenity.id }}">Edit</button>
                                        <button class="btn btn-danger btn-sm delete-amenity-button" data-amenity-id="{{ amenity.id }}">Delete</button>
                                    </td>
                                </tr>
                            {% empty %}
                                <tr><td colspan="5" class="text-center">No amenities found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Assign Staff Modal -->
    <div id="assignStaffModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button">&times;</span>
            <div class="modal-header">
                <h2>Assign Request to Staff</h2>
            </div>
            <form id="assignStaffForm">
                {% csrf_token %}
                <input type="hidden" id="assignRequestId" name="request_id">
                <!-- Hidden fields to carry existing data for backend validation -->
                <input type="hidden" id="assignRoomNumber" name="room_number">
                <input type="hidden" id="assignRawText" name="raw_text">
                <input type="hidden" id="assignRequestType" name="request_type">
                <input type="hidden" id="assignStatus" name="status">
                <input type="hidden" id="assignStaffNotes" name="staff_notes">
                <input type="hidden" id="assignBillAdded" name="bill_added">
                <input type="hidden" id="assignAmenityQuantity" name="amenity_quantity">

                <div class="form-group">
                    <label for="assignStaffSelect">Assign to:</label>
                    <select id="assignStaffSelect" name="assigned_staff" class="form-control" required>
                        <option value="">Select Staff Member</option>
                        {% for staff in staff_members %}
                            <option value="{{ staff.id }}">{{ staff.user.username }} ({{ staff.get_category_display }})</option>
                        {% endfor %}
                    </select>
                    <span id="assigned_staffErrorsAssign" class="error-message"></span>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelAssignButton">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Request Details Modal -->
    <div id="requestDetailsModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button" id="closeRequestDetailsModalButton">&times;</span>
            <div class="modal-header">
                <h2>Request Details <small>(ID: <span id="modalRequestIdDisplay"></span>)</small></h2>
            </div>
            <form id="requestUpdateForm">
                {% csrf_token %}
                <input type="hidden" id="modalRequestId" name="request_id">
                <!-- Hidden fields to carry existing data for backend validation -->
                <input type="hidden" id="modalRoomNumberHidden" name="room_number">
                <input type="hidden" id="modalRawTextHidden" name="raw_text">
                <input type="hidden" id="modalAmenityQuantityHidden" name="amenity_quantity">

                <div class="form-group">
                    <label>Room Number:</label>
                    <p id="detailRoomNumber" class="form-control-static"></p>
                </div>
                <div class="form-group">
                    <label>Guest Names:</label>
                    <p id="detailGuestNames" class="form-control-static"></p>
                </div>
                <div class="form-group">
                    <label>Received At:</label>
                    <p id="detailTimestamp" class="form-control-static"></p>
                </div>
                <div class="form-group">
                    <label>Raw Request Text:</label>
                    <p id="detailRawText" class="form-control-static"></p>
                </div>
                <div class="form-group">
                    <label>ConciAI Response:</label>
                    <p id="detailConciResponse" class="form-control-static"></p>
                </div>
                <div class="form-group">
                    <label>AI Intent:</label>
                    <p id="detailAiIntent" class="form-control-static"></p>
                </div>
                <div class="form-group">
                    <label>AI Entities:</label>
                    <pre id="detailAiEntities" class="form-control-static" style="white-space: pre-wrap; word-break: break-all;"></pre>
                </div>
                
                <!-- Amenity Details Section (Conditional Display) -->
                <div id="amenityDetailsSection" style="display: none; border-top: 1px solid var(--border); padding-top: 15px; margin-top: 15px;">
                    <h3>Amenity Details</h3>
                    <div class="form-group">
                        <label>Amenity Name:</label>
                        <p id="detailAmenityName" class="form-control-static"></p>
                    </div>
                    <div class="form-group">
                        <label>Quantity:</label>
                        <p id="detailAmenityQuantity" class="form-control-static"></p>
                    </div>
                    <div class="form-group">
                        <label>Price Per Unit:</label>
                        <p id="detailPricePerUnit" class="form-control-static"></p>
                    </div>
                    <div class="form-group">
                        <label>Total Amenity Cost:</label>
                        <p id="detailTotalAmenityCost" class="form-control-static"></p>
                    </div>
                    <div class="form-group">
                        <label>Bill Added:</label>
                        <p id="detailBillAdded" class="form-control-static"></p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="id_request_type">Request Type:</label>
                    <select id="id_request_type" name="request_type" class="form-control">
                        {% for value, label in guest_request_type_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                    <span id="request_typeErrors" class="error-message"></span>
                </div>

                <div class="form-group">
                    <label for="id_status">Status:</label>
                    <select id="id_status" name="status" class="form-control" disabled> <!-- Status is now disabled for admin -->
                        {% for value, label in guest_request_status_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                    <span id="statusErrors" class="error-message"></span>
                </div>

                <div class="form-group">
                    <label for="id_assigned_staff">Assigned Staff:</label>
                    <select id="id_assigned_staff" name="assigned_staff" class="form-control">
                        <option value="">Unassigned</option>
                        {% for staff in staff_members %}
                            <option value="{{ staff.id }}">{{ staff.user.username }} ({{ staff.get_category_display }})</option>
                        {% endfor %}
                    </select>
                    <span id="assigned_staffErrors" class="error-message"></span>
                </div>

                <div class="form-group">
                    <label for="id_staff_notes">Staff Notes:</label>
                    <textarea id="id_staff_notes" name="staff_notes" class="form-control" rows="3"></textarea>
                    <span id="staff_notesErrors" class="error-message"></span>
                </div>

                <div class="form-group">
                    <input type="checkbox" id="modalAmenityBillAdded" name="bill_added" class="form-check-input">
                    <label for="modalAmenityBillAdded">Bill Added</label>
                </div>

                <div class="chat-history-container" id="detailChatHistory">
                    <!-- Chat history will be loaded here by JavaScript -->
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="closeRequestDetailsModalButtonFooter">Close</button>
                    <button type="submit" class="btn btn-primary" id="saveRequestChangesButton">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Amenity Add/Edit Modal -->
    <div id="amenityModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button">&times;</span>
            <div class="modal-header">
                <h2 id="amenityModalTitle">Add New Amenity</h2>
            </div>
            <form id="amenityForm">
                {% csrf_token %}
                <input type="hidden" id="amenityId" name="amenity_id">
                <div class="form-group">
                    <label for="amenityName">Name:</label>
                    <input type="text" id="amenityName" name="name" class="form-control" required>
                    <span id="amenityNameErrors" class="error-message"></span>
                </div>
                <div class="form-group">
                    <label for="amenityDescription">Description:</label>
                    <textarea id="amenityDescription" name="description" class="form-control" rows="3"></textarea>
                    <span id="amenityDescriptionErrors" class="error-message"></span>
                </div>
                <div class="form-group">
                    <label for="amenityPrice">Price:</label>
                    <input type="number" id="amenityPrice" name="price" class="form-control" step="0.01" required>
                    <span id="amenityPriceErrors" class="error-message"></span>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="amenityIsAvailable" name="is_available" class="form-check-input">
                    <label for="amenityIsAvailable">Available</label>
                    <span id="amenityIsAvailableErrors" class="error-message"></span>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelAmenityButton">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Amenity</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Guest Assignment Modal -->
    <div id="assignmentModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button close-button">&times;</span>
            <div class="modal-header">
                <h2 id="assignmentModalTitle">Add New Guest Assignment</h2>
            </div>
            <form id="assignmentForm">
                {% csrf_token %}
                <input type="hidden" id="assignmentId" name="assignment_id">
                <div class="form-group">
                    <label for="room_number_input">Room Number:</label>
                    <input type="text" id="room_number_input" name="room_number_input" class="form-control" required>
                    <span id="room_number_inputErrors" class="error-message"></span>
                </div>
                <div class="form-group">
                    <label for="guest_names">Guest Names:</label>
                    <input type="text" id="guest_names" name="guest_names" class="form-control" required>
                    <span id="guest_namesErrors" class="error-message"></span>
                </div>
                <div class="form-group">
                    <label for="check_in_date">Check-in Date:</label>
                    <input type="date" id="check_in_date" name="check_in_date" class="form-control" required>
                    <span id="check_in_dateErrors" class="error-message"></span>
                </div>
                <div class="form-group">
                    <label for="check_in_time_input">Check-in Time:</label>
                    <input type="time" id="check_in_time_input" name="check_in_time_input" class="form-control" required>
                    <span id="check_in_time_inputErrors" class="error-message"></span>
                </div>
                <div class="form-group">
                    <label for="check_out_date">Check-out Date:</label>
                    <input type="date" id="check_out_date" name="check_out_date" class="form-control" required>
                    <span id="check_out_dateErrors" class="error-message"></span>
                </div>
                <div class="form-group">
                    <label for="check_out_time_input">Check-out Time:</label>
                    <input type="time" id="check_out_time_input" name="check_out_time_input" class="form-control" required>
                    <span id="check_out_time_inputErrors" class="error-message"></span>
                </div>
                <div class="form-group">
                    <label for="status">Status:</label>
                    <select id="status" name="status" class="form-control" required>
                        {% for value, label in assignment_status_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                    <span id="statusErrors" class="error-message"></span>
                </div>
                <div class="form-group">
                    <label for="total_bill_amount">Total Bill Amount:</label>
                    <input type="number" id="total_bill_amount" name="total_bill_amount" class="form-control" step="0.01" value="0.00">
                    <span id="total_bill_amountErrors" class="error-message"></span>
                </div>
                <div class="form-group">
                    <label for="amount_paid">Amount Paid:</label>
                    <input type="number" id="amount_paid" name="amount_paid" class="form-control" step="0.01" value="0.00">
                    <span id="amount_paidErrors" class="error-message"></span>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary cancel-button">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Assignment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal (for delete actions) -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button confirmation-close-button">&times;</span>
            <div class="modal-header">
                <h2>Confirm Action</h2>
            </div>
            <p id="confirmationMessage"></p>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary confirmation-cancel-button">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmationYesButton">Confirm</button>
            </div>
        </div>
    </div>

    <script defer>
        console.log("Script loading..."); // Debugging: Check if script starts

        // Global utility function to show messages
        function showMessage(message, type) {
            const messageBox = document.getElementById('messageBox');
            if (messageBox) { // Ensure element exists
                messageBox.textContent = message;
                messageBox.className = ''; // Clear existing classes
                messageBox.classList.add('show', type);
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, 3000); // Hide after 3 seconds
            }
        }

        // CSRF Token for AJAX requests
        const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        const csrfToken = csrfTokenElement ? csrfTokenElement.value : '';
        console.log("CSRF Token:", csrfToken ? "Found" : "Not Found"); // Debugging

        // Theme Toggle Logic
        const themeToggleButton = document.getElementById('themeToggleButton');
        const htmlElement = document.documentElement;

        // Function to set the theme based on localStorage or default
        function setInitialTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            htmlElement.setAttribute('data-theme', savedTheme);
            updateThemeToggleButton(savedTheme);
            console.log("Initial theme set to:", savedTheme); // Debugging
        }

        // Function to update the theme toggle button icon
        function updateThemeToggleButton(theme) {
            const icon = themeToggleButton ? themeToggleButton.querySelector('i') : null;
            if (icon) { // Check if icon exists before manipulating
                if (theme === 'dark') {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                }
                console.log("Theme toggle button updated for theme:", theme); // Debugging
            } else {
                console.warn("Theme toggle button or its icon not found."); // Debugging
            }
        }

        // Event listener for theme toggle button
        if (themeToggleButton) { // Ensure button exists
            themeToggleButton.addEventListener('click', () => {
                let currentTheme = htmlElement.getAttribute('data-theme');
                let newTheme = currentTheme === 'light' ? 'dark' : 'light';
                htmlElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeToggleButton(newTheme);
                console.log("Theme toggled to:", newTheme); // Debugging
            });
        } else {
            console.warn("themeToggleButton not found."); // Debugging
        }

        // Centralized Initialization Function
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded fired. Initializing dashboard elements..."); // Debugging
            setInitialTheme(); // Set theme immediately when DOM is ready

            // Sidebar Toggle Logic
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarToggleIcon = sidebarToggle ? sidebarToggle.querySelector('i') : null;

            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', () => {
                    if (sidebar) sidebar.classList.toggle('collapsed');
                    if (mainContent) mainContent.classList.toggle('sidebar-collapsed');
                    if (sidebar && sidebarToggleIcon) {
                        if (sidebar.classList.contains('collapsed')) {
                            sidebarToggleIcon.classList.remove('fa-chevron-left');
                            sidebarToggleIcon.classList.add('fa-chevron-right');
                        } else {
                            sidebarToggleIcon.classList.remove('fa-chevron-right');
                            sidebarToggleIcon.classList.add('fa-chevron-left');
                        }
                    }
                    console.log("Sidebar toggled."); // Debugging
                });
            } else {
                console.warn("sidebarToggle not found."); // Debugging
            }

            // Notification Bell Logic
            const notificationBell = document.getElementById('notificationBell');
            const notificationBadge = document.getElementById('notificationBadge');
            let lastCheckTimestamp = new Date().toISOString();

            async function fetchNewRequests() {
                try {
                    const response = await fetch(`/api/check_new_requests/?last_check=${encodeURIComponent(lastCheckTimestamp)}`);
                    const data = await response.json();

                    if (data.success) {
                        if (notificationBadge) {
                            notificationBadge.textContent = data.new_requests_count;
                            if (data.new_requests_count > 0) {
                                notificationBadge.style.display = 'block';
                            } else {
                                notificationBadge.style.display = 'none';
                            }
                        }
                        lastCheckTimestamp = data.current_timestamp;
                        console.log("New requests fetched:", data.new_requests_count); // Debugging
                    } else {
                        console.error('Failed to fetch new requests:', data.error);
                    }
                } catch (error) {
                    console.error('Network error fetching new requests:', error);
                }
            }

            setInterval(fetchNewRequests, 30000);
            fetchNewRequests(); // Initial fetch

            // D3.js Chart for Reservations (Last 7 Days)
            {% if current_main_tab == 'home' %}
                const reservationsData = {{ reservations_chart_data|safe }};
                const bookingPlatformData = {{ booking_platform_data|safe }};

                function drawReservationsChart() {
                    const svgElement = document.getElementById('reservationsChart');
                    if (!svgElement) { console.warn("reservationsChart SVG not found."); return; }

                    const svg = d3.select(svgElement);
                    const margin = {top: 20, right: 30, bottom: 40, left: 40};
                    const width = parseFloat(svg.style("width")) - margin.left - margin.right;
                    const height = parseFloat(svg.style("height")) - margin.top - margin.bottom;

                    svg.selectAll("*").remove(); 

                    const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                    const x = d3.scaleBand()
                        .domain(reservationsData.map(d => d.date))
                        .range([0, width])
                        .padding(0.2);

                    const y = d3.scaleLinear()
                        .domain([0, d3.max(reservationsData, d => Math.max(d.booked, d.cancelled)) + 5])
                        .range([height, 0]);

                    g.append("g")
                        .attr("transform", `translate(0,${height})`)
                        .call(d3.axisBottom(x).tickSizeOuter(0))
                        .selectAll("text")
                        .style("fill", "var(--chart-axis-text)");

                    g.append("g")
                        .call(d3.axisLeft(y).tickSizeOuter(0))
                        .selectAll("text")
                        .style("fill", "var(--chart-axis-text)");

                    g.append("g")
                        .attr("class", "grid")
                        .attr("transform", `translate(0,${height})`)
                        .call(d3.axisBottom(x)
                            .tickSize(-height)
                            .tickFormat("")
                        )
                        .select(".domain").remove();

                    g.append("g")
                        .attr("class", "grid")
                        .call(d3.axisLeft(y)
                            .tickSize(-width)
                            .tickFormat("")
                        )
                        .select(".domain").remove();

                    g.selectAll(".bar-booked")
                        .data(reservationsData)
                        .enter().append("rect")
                        .attr("class", "bar-booked")
                        .attr("x", d => x(d.date))
                        .attr("y", d => y(d.booked))
                        .attr("width", x.bandwidth() / 2)
                        .attr("height", d => height - y(d.booked))
                        .attr("fill", "var(--chart-color-booked)");

                    g.selectAll(".bar-cancelled")
                        .data(reservationsData)
                        .enter().append("rect")
                        .attr("class", "bar-cancelled")
                        .attr("x", d => x(d.date) + x.bandwidth() / 2)
                        .attr("y", d => y(d.cancelled))
                        .attr("width", x.bandwidth() / 2)
                        .attr("height", d => height - y(d.cancelled))
                        .attr("fill", "var(--chart-color-cancelled)");
                }

                function drawBookingPlatformChart() {
                    const svgElement = document.getElementById('bookingPlatformChart');
                    if (!svgElement) { console.warn("bookingPlatformChart SVG not found."); return; }

                    const svg = d3.select(svgElement);
                    const width = parseFloat(svg.style("width"));
                    const height = parseFloat(svg.style("height"));
                    const radius = Math.min(width, height) / 2 - 20;

                    svg.selectAll("*").remove(); 

                    const g = svg.append("g")
                        .attr("transform", `translate(${width / 2},${height / 2})`);

                    const color = d3.scaleOrdinal()
                        .range([
                            "var(--chart-platform1)", "var(--chart-platform2)",
                            "var(--chart-platform3)", "var(--chart-platform4)",
                            "var(--chart-platform5)", "var(--chart-platform6)"
                        ]);

                    const pie = d3.pie()
                        .value(d => d.value);

                    const path = d3.arc()
                        .outerRadius(radius - 10)
                        .innerRadius(0);

                    const label = d3.arc()
                        .outerRadius(radius)
                        .innerRadius(radius - 80);

                    const arc = g.selectAll(".arc")
                        .data(pie(bookingPlatformData))
                        .enter().append("g")
                        .attr("class", "arc");

                    arc.append("path")
                        .attr("d", path)
                        .attr("fill", d => color(d.data.platform));

                    arc.append("text")
                        .attr("transform", d => `translate(${label.centroid(d)})`)
                        .attr("text-anchor", "middle")
                        .text(d => `${d.data.platform} (${d.data.value}%)`)
                        .style("fill", "var(--text)")
                        .style("font-size", "0.8em");
                }

                drawReservationsChart();
                drawBookingPlatformChart();
                console.log("Charts drawn.");

                window.addEventListener('resize', () => {
                    drawReservationsChart();
                    drawBookingPlatformChart();
                });
            {% endif %}

            // Modals (Common declarations and closing logic)
            const requestDetailsModal = document.getElementById('requestDetailsModal');
            const amenityModal = document.getElementById('amenityModal');
            const confirmationModal = document.getElementById('confirmationModal');
            const assignmentModal = document.getElementById('assignmentModal'); 
            const assignStaffModal = document.getElementById('assignStaffModal'); 

            function closeAllModals() {
                if (requestDetailsModal) requestDetailsModal.classList.remove('show');
                if (amenityModal) amenityModal.classList.remove('show');
                if (confirmationModal) confirmationModal.classList.remove('show');
                if (assignmentModal) assignmentModal.classList.remove('show');
                if (assignStaffModal) assignStaffModal.classList.remove('show'); 

                document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
                console.log("All modals closed and errors cleared.");
            }

            document.querySelectorAll('.modal-close-button').forEach(button => {
                button.addEventListener('click', closeAllModals);
            });
            document.querySelectorAll('.confirmation-close-button, .confirmation-cancel-button').forEach(button => {
                button.addEventListener('click', closeAllModals);
            });
            document.querySelectorAll('.close-button, .cancel-button').forEach(button => {
                button.addEventListener('click', closeAllModals);
            });

            window.addEventListener('click', (event) => {
                if (event.target === requestDetailsModal || event.target === amenityModal || 
                    event.target === confirmationModal || event.target === assignmentModal || 
                    event.target === assignStaffModal) {
                    closeAllModals();
                }
            });


            // Request Details Modal Logic
            const viewDetailsButtons = document.querySelectorAll('.view-details'); 
            
            const requestUpdateForm = document.getElementById('requestUpdateForm');
            const modalRequestId = document.getElementById('modalRequestId');
            const idStaffNotes = document.getElementById('id_staff_notes'); 
            const idAssignedStaff = document.getElementById('id_assigned_staff'); 
            const idStatus = document.getElementById('id_status'); 
            const idRequestType = document.getElementById('id_request_type'); 
            const saveRequestChangesButton = document.getElementById('saveRequestChangesButton'); 

            // Hidden fields for request details form
            const modalRoomNumberHidden = document.getElementById('modalRoomNumberHidden');
            const modalRawTextHidden = document.getElementById('modalRawTextHidden');
            const modalAmenityQuantityHidden = document.getElementById('modalAmenityQuantityHidden');


            viewDetailsButtons.forEach(button => {
                button.addEventListener('click', async () => {
                    console.log("View Details button clicked."); 
                    const requestId = button.dataset.requestId;
                    try {
                        const response = await fetch(`/api/requests/${requestId}/details/`);
                        const result = await response.json();

                        if (result.success) {
                            // Populate static display fields
                            if (document.getElementById('modalRequestIdDisplay')) document.getElementById('modalRequestIdDisplay').textContent = requestId; 
                            if (document.getElementById('detailRoomNumber')) document.getElementById('detailRoomNumber').textContent = result.room_number;
                            if (document.getElementById('detailGuestNames')) document.getElementById('detailGuestNames').textContent = result.guest_names;
                            if (document.getElementById('detailTimestamp')) document.getElementById('detailTimestamp').textContent = new Date(result.timestamp).toLocaleString();
                            if (document.getElementById('detailRawText')) document.getElementById('detailRawText').textContent = result.raw_text;
                            if (document.getElementById('detailConciResponse')) document.getElementById('detailConciResponse').textContent = result.conci_response_text;
                            if (document.getElementById('detailAiIntent')) document.getElementById('detailAiIntent').textContent = result.ai_intent;
                            
                            const detailAiEntities = document.getElementById('detailAiEntities');
                            if (detailAiEntities) {
                                if (result.ai_entities && typeof result.ai_entities === 'object') {
                                    detailAiEntities.textContent = JSON.stringify(result.ai_entities, null, 2);
                                } else {
                                    detailAiEntities.textContent = result.ai_entities || 'N/A';
                                }
                            }
                            
                            // Populate form fields for editing
                            if (modalRequestId) modalRequestId.value = requestId; 
                            if (idStaffNotes) idStaffNotes.value = result.staff_notes || ''; 
                            if (idStatus) idStatus.value = result.raw_status_value; 
                            if (idRequestType) idRequestType.value = result.raw_request_type_value; 

                            if (idAssignedStaff) { 
                                idAssignedStaff.value = result.raw_assigned_staff_id || ''; 
                            }

                            // Populate hidden fields for backend validation
                            if (modalRoomNumberHidden) modalRoomNumberHidden.value = result.room_number || '';
                            if (modalRawTextHidden) modalRawTextHidden.value = result.raw_text || '';
                            // amenity_quantity should be 0 or null if not an amenity request
                            if (modalAmenityQuantityHidden) modalAmenityQuantityHidden.value = result.amenity_quantity || 0;


                            const amenityDetailsSection = document.getElementById('amenityDetailsSection');
                            if (amenityDetailsSection) { 
                                if (result.amenity_details) {
                                    amenityDetailsSection.style.display = 'block';
                                    if (document.getElementById('detailAmenityName')) document.getElementById('detailAmenityName').textContent = result.amenity_details.name;
                                    if (document.getElementById('detailAmenityQuantity')) document.getElementById('detailAmenityQuantity').textContent = result.amenity_details.quantity;
                                    if (document.getElementById('detailPricePerUnit')) document.getElementById('detailPricePerUnit').textContent = `$${result.amenity_details.price_per_unit.toFixed(2)}`;
                                    if (document.getElementById('detailTotalAmenityCost')) document.getElementById('detailTotalAmenityCost').textContent = `$${result.amenity_details.total_amenity_cost.toFixed(2)}`;
                                    if (document.getElementById('detailBillAdded')) document.getElementById('detailBillAdded').textContent = result.amenity_details.bill_added ? 'Yes' : 'No';
                                } else {
                                    amenityDetailsSection.style.display = 'none';
                                }
                            }

                            const detailChatHistory = document.getElementById('detailChatHistory');
                            if (detailChatHistory) { 
                                detailChatHistory.innerHTML = ''; 
                                if (result.chat_history && Array.isArray(result.chat_history) && result.chat_history.length > 0) {
                                    result.chat_history.forEach(message => {
                                        const msgDiv = document.createElement('div');
                                        msgDiv.classList.add('chat-message', message.role);
                                        const messageText = (message.parts && message.parts.length > 0 && message.parts[0].text) ? message.parts[0].text : 'No text content.';
                                        msgDiv.innerHTML = `<strong>${message.role === 'user' ? 'Guest' : 'Conci'}:</strong> ${messageText}`;
                                        detailChatHistory.appendChild(msgDiv);
                                    });
                                } else {
                                    detailChatHistory.innerHTML = '<p>No detailed conversation history available.</p>';
                                }
                            }

                            const loggedInStaffMemberId = "{{ logged_in_staff_member.id|default:'' }}";
                            const loggedInStaffCategory = "{{ logged_in_staff_member.category|default:'' }}";

                            if (saveRequestChangesButton) {
                                let canEdit = false;
                                if (loggedInStaffCategory === 'general' || loggedInStaffCategory === 'concierge') {
                                    canEdit = true;
                                } else {
                                    if (result.assigned_staff && result.assigned_staff.id == loggedInStaffMemberId) {
                                        canEdit = true;
                                    }
                                    if (!result.assigned_staff && result.raw_request_type_value === loggedInStaffCategory) {
                                        canEdit = true;
                                    }
                                }
                                saveRequestChangesButton.disabled = !canEdit;
                                console.log("Save Changes button disabled status:", !canEdit); 
                            }

                            if (requestDetailsModal) requestDetailsModal.classList.add('show'); 
                            console.log("Request Details modal shown."); 
                        } else {
                            console.error('Backend reported error for Request Details:', result.error);
                            showMessage(result.error || 'Failed to load request details.', 'error');
                        }
                    }
                    catch (error) {
                        console.error('Error fetching request details:', error);
                        showMessage('Network error or server issue fetching request details.', 'error');
                    }
                });
            });

            // Submit Request Update Form
            if (requestUpdateForm) {
                console.log("Attaching listener to requestUpdateForm submit."); 
                requestUpdateForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log("Request Update Form submitted."); 
                    document.querySelectorAll('#requestUpdateForm .error-message').forEach(el => el.textContent = '');

                    const requestId = modalRequestId ? modalRequestId.value : '';
                    const url = `/api/requests/${requestId}/update/`; 

                    // Create a new FormData object to ensure all fields are included
                    const formData = new FormData();
                    formData.append('request_id', requestId);
                    
                    // Append all necessary fields from the modal's current state (including hidden ones)
                    // These correspond to the fields required by GuestRequestForm on backend
                    formData.append('room_number', modalRoomNumberHidden ? modalRoomNumberHidden.value : '');
                    formData.append('raw_text', modalRawTextHidden ? modalRawTextHidden.value : '');
                    formData.append('amenity_quantity', modalAmenityQuantityHidden ? modalAmenityQuantityHidden.value : 0); // Default to 0 if not present

                    // Append fields that can be directly edited/selected in the modal
                    formData.append('staff_notes', idStaffNotes ? idStaffNotes.value : '');
                    formData.append('assigned_staff', idAssignedStaff ? idAssignedStaff.value : '');
                    formData.append('status', idStatus ? idStatus.value : ''); // Status is disabled, but its value is still needed
                    formData.append('request_type', idRequestType ? idRequestType.value : '');

                    const modalAmenityBillAddedCheckbox = document.getElementById('modalAmenityBillAdded');
                    formData.append('bill_added', modalAmenityBillAddedCheckbox ? (modalAmenityBillAddedCheckbox.checked ? 'True' : 'False') : 'False');


                    try {
                        const response = await fetch(url, {
                            method: 'POST', 
                            headers: {
                                'X-CSRFToken': csrfToken, 
                            },
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success) {
                            showMessage(result.message, 'success');
                            if (requestDetailsModal) requestDetailsModal.classList.remove('show');
                            location.reload(); 
                        } else {
                            let generalErrorMessage = result.error || 'Failed to update request due to validation errors.';
                            showMessage(generalErrorMessage, 'error');

                            if (result.errors) {
                                const errors = JSON.parse(result.errors);
                                for (const field in errors) {
                                    const errorDiv = document.getElementById(`${field}Errors`);
                                    if (errorDiv) {
                                        errorDiv.textContent = errors[field][0].message;
                                    } else {
                                        console.error(`Unhandled form error for field ${field}:`, errors[field][0].message);
                                        showMessage(`Error: ${errors[field][0].message}`, 'error');
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error submitting request update form:', error);
                        showMessage('Network error or server issue updating request.', 'error');
                    }
                });
            } else {
                console.warn("requestUpdateForm not found."); 
            }

            // NEW: Assign Staff Modal Logic
            const assignRequestIdInput = document.getElementById('assignRequestId');
            const assignStaffSelect = document.getElementById('assignStaffSelect');
            const cancelAssignButton = document.getElementById('cancelAssignButton');
            const assignStaffForm = document.getElementById('assignStaffForm');

            // Hidden fields for assign staff form
            const assignRoomNumber = document.getElementById('assignRoomNumber');
            const assignRawText = document.getElementById('assignRawText');
            const assignRequestType = document.getElementById('assignRequestType');
            const assignStatus = document.getElementById('assignStatus');
            const assignStaffNotes = document.getElementById('assignStaffNotes');
            const assignBillAdded = document.getElementById('assignBillAdded');
            const assignAmenityQuantity = document.getElementById('assignAmenityQuantity');


            document.querySelectorAll('.assign-request-button').forEach(button => {
                button.addEventListener('click', async () => { // Made async to fetch details
                    console.log("Assign Request button clicked."); 
                    const requestId = button.dataset.requestId;

                    try {
                        // Fetch current request details to get all required fields for the form
                        const currentRequestResponse = await fetch(`/api/requests/${requestId}/details/`);
                        const currentRequestData = await currentRequestResponse.json();

                        if (currentRequestData.success) {
                            if (assignRequestIdInput) assignRequestIdInput.value = requestId;
                            if (assignStaffSelect) assignStaffSelect.value = currentRequestData.raw_assigned_staff_id || ''; // Pre-select if already assigned

                            // Populate hidden fields with current data
                            if (assignRoomNumber) assignRoomNumber.value = currentRequestData.room_number || '';
                            if (assignRawText) assignRawText.value = currentRequestData.raw_text || '';
                            if (assignRequestType) assignRequestType.value = currentRequestData.raw_request_type_value || '';
                            if (assignStatus) assignStatus.value = currentRequestData.raw_status_value || '';
                            if (assignStaffNotes) assignStaffNotes.value = currentRequestData.staff_notes || '';
                            if (assignBillAdded) assignBillAdded.value = currentRequestData.amenity_details ? (currentRequestData.amenity_details.bill_added ? 'True' : 'False') : 'False';
                            if (assignAmenityQuantity) assignAmenityQuantity.value = currentRequestData.amenity_quantity || 0;


                            const assignErrorsDiv = document.getElementById('assigned_staffErrorsAssign');
                            if (assignErrorsDiv) assignErrorsDiv.textContent = '';
                            if (assignStaffModal) assignStaffModal.classList.add('show');
                            console.log("Assign Staff modal shown with data for ID:", requestId); 
                        } else {
                            showMessage(currentRequestData.error || 'Failed to fetch current request details for assignment.', 'error');
                        }
                    } catch (error) {
                        console.error('Error fetching request details for assignment:', error);
                        showMessage('Network error or server issue fetching request details.', 'error');
                    }
                });
            });

            if (cancelAssignButton) { 
                cancelAssignButton.addEventListener('click', () => {
                    if (assignStaffModal) assignStaffModal.classList.remove('show');
                    console.log("Assign Staff modal canceled."); 
                });
            }


            // Submit Assign Staff Form
            if (assignStaffForm) {
                console.log("Attaching listener to assignStaffForm submit."); 
                assignStaffForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log("Assign Staff Form submitted."); 
                    const assignErrorsDiv = document.getElementById('assigned_staffErrorsAssign');
                    if (assignErrorsDiv) assignErrorsDiv.textContent = ''; 

                    const requestId = assignRequestIdInput ? assignRequestIdInput.value : '';
                    const url = `/api/requests/${requestId}/update/`; 

                    // FormData now includes all required fields from hidden inputs
                    const formData = new FormData(assignStaffForm);

                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken,
                            },
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success) {
                            showMessage(result.message, 'success');
                            if (assignStaffModal) assignStaffModal.classList.remove('show');
                            location.reload(); 
                        } else {
                            let generalErrorMessage = result.error || 'Failed to assign task due to validation errors.';
                            showMessage(generalErrorMessage, 'error');

                            if (result.errors) {
                                const errors = JSON.parse(result.errors);
                                const errorDiv = document.getElementById('assigned_staffErrorsAssign');
                                if (errors.assigned_staff && errorDiv) {
                                    errorDiv.textContent = errors.assigned_staff[0].message;
                                } else {
                                    console.error('Unhandled form error:', errors);
                                    showMessage('Error: ' + JSON.stringify(errors), 'error');
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error assigning task:', error);
                        showMessage('Network error or server issue assigning task.', 'error');
                    }
                });
            } else {
                console.warn("assignStaffForm not found."); 
            }


            // Custom Confirmation Modal Logic for Status Updates
            const confirmationMessage = document.getElementById('confirmationMessage');
            const confirmationYesButton = document.getElementById('confirmationYesButton');
            const confirmationCloseButtons = confirmationModal ? confirmationModal.querySelectorAll('.confirmation-close-button, .confirmation-cancel-button') : [];

            let currentActionId = null; 
            let currentActionType = null; 

            function showConfirmationModal(message, id, actionType) {
                if (confirmationMessage) confirmationMessage.textContent = message;
                currentActionId = id;
                currentActionType = actionType;
                if (confirmationModal) confirmationModal.classList.add('show');
                console.log("Confirmation modal shown for action:", actionType, "ID:", id); 
            }

            if (confirmationYesButton) { 
                confirmationYesButton.addEventListener('click', async () => {
                    if (confirmationModal) confirmationModal.classList.remove('show'); 

                    if (currentActionType === 'delete_assignment') {
                        try {
                            const response = await fetch(`/api/assignments/${currentActionId}/delete/`, {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': csrfToken 
                                }
                            });
                            const result = await response.json();
                            if (result.success) {
                                showMessage('Assignment deleted successfully!', 'success');
                                const deletedRow = document.querySelector(`.data-table tbody tr [data-assignment-id="${currentActionId}"]`);
                                if (deletedRow) {
                                    deletedRow.closest('tr').remove(); 
                                }
                                console.log("Assignment deleted:", currentActionId); 
                            } else {
                                showMessage(result.error || 'Failed to delete assignment.', 'error');
                            }
                        } catch (error) {
                            console.error('Error deleting assignment:', error);
                            showMessage('Network error or server issue deleting assignment.', 'error');
                        }
                    } else if (currentActionType === 'delete_amenity') {
                        try {
                            const response = await fetch(`/api/amenities/${currentActionId}/delete/`, {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': csrfToken 
                                }
                            });
                            const result = await response.json();
                            if (result.success) {
                                showMessage('Amenity deleted successfully!', 'success');
                                const deletedRow = document.querySelector(`.data-table tbody tr [data-amenity-id="${currentActionId}"]`);
                                if (deletedRow) {
                                    deletedRow.closest('tr').remove(); 
                                }
                                console.log("Amenity deleted:", currentActionId); 
                            } else {
                                showMessage(result.error || 'Failed to delete amenity.', 'error');
                            }
                        } catch (error) {
                            console.error('Error deleting amenity:', error);
                            showMessage('Network error or server issue deleting amenity.', 'error');
                        }
                    }
                });
            } else {
                console.warn("confirmationYesButton not found."); 
            }

            if (confirmationCloseButtons) { 
                confirmationCloseButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        if (confirmationModal) confirmationModal.classList.remove('show');
                        console.log("Confirmation modal closed."); 
                    });
                });
            } else {
                console.warn("confirmationCloseButtons not found."); 
            }


            // Add/Edit Guest Assignment Modal Logic
            const addAssignmentButton = document.getElementById('addAssignmentButton');
            const assignmentForm = document.getElementById('assignmentForm');
            const assignmentModalTitle = document.getElementById('assignmentModalTitle');

            function clearFormErrors(formId) {
                document.querySelectorAll(`#${formId} .error-message`).forEach(el => el.textContent = '');
            }

            if (addAssignmentButton) {
                addAssignmentButton.addEventListener('click', () => {
                    if (assignmentModalTitle) assignmentModalTitle.textContent = 'Add New Guest Assignment';
                    if (assignmentForm) assignmentForm.reset(); 
                    const assignmentIdInput = document.getElementById('assignmentId');
                    if (assignmentIdInput) assignmentIdInput.value = ''; 
                    clearFormErrors('assignmentForm');
                    if (assignmentModal) assignmentModal.classList.add('show');
                    console.log("Add Assignment modal shown."); 
                });
            } 

            document.querySelectorAll('.edit-assignment-button').forEach(button => {
                button.addEventListener('click', async () => {
                    console.log("Edit Assignment button clicked."); 
                    const assignmentId = button.dataset.assignmentId;
                    if (assignmentModalTitle) assignmentModalTitle.textContent = 'Edit Guest Assignment';
                    if (assignmentForm) assignmentForm.reset(); 
                    const assignmentIdInput = document.getElementById('assignmentId');
                    if (assignmentIdInput) assignmentIdInput.value = assignmentId; 
                    clearFormErrors('assignmentForm');

                    try {
                        const response = await fetch(`/api/assignments/${assignmentId}/edit/`); 
                        const data = await response.json();
                        if (data.success) {
                            if (data.assignment.check_in_time) {
                                const checkInDateTime = new Date(data.assignment.check_in_time);
                                const checkInDateInput = assignmentForm.querySelector('[name="check_in_date"]');
                                const checkInTimeInput = assignmentForm.querySelector('[name="check_in_time_input"]');
                                if (checkInDateInput) checkInDateInput.value = checkInDateTime.toISOString().split('T')[0];
                                if (checkInTimeInput) checkInTimeInput.value = checkInDateTime.toTimeString().slice(0, 5);
                            }
                            if (data.assignment.check_out_time) {
                                const checkOutDateTime = new Date(data.assignment.check_out_time);
                                const checkOutDateInput = assignmentForm.querySelector('[name="check_out_date"]');
                                const checkOutTimeInput = assignmentForm.querySelector('[name="check_out_time_input"]');
                                if (checkOutDateInput) checkOutDateInput.value = checkOutDateTime.toISOString().split('T')[0];
                                if (checkOutTimeInput) checkOutTimeInput.value = checkOutDateTime.toTimeString().slice(0, 5);
                            }
                            
                            const roomNumberInput = assignmentForm.querySelector('[name="room_number_input"]');
                            if (roomNumberInput && data.assignment.room_number && data.assignment.room_number.room_number) {
                                roomNumberInput.value = data.assignment.room_number.room_number;
                            }

                            const guestNamesInput = assignmentForm.querySelector('[name="guest_names"]');
                            if (guestNamesInput) guestNamesInput.value = data.assignment.guest_names;
                            
                            const statusSelect = assignmentForm.querySelector('[name="status"]');
                            if (statusSelect) statusSelect.value = data.assignment.status;
                            
                            const totalBillAmountInput = assignmentForm.querySelector('[name="total_bill_amount"]');
                            if (totalBillAmountInput) totalBillAmountInput.value = data.assignment.total_bill_amount;
                            
                            const amountPaidInput = assignmentForm.querySelector('[name="amount_paid"]');
                            if (amountPaidInput) amountPaidInput.value = data.assignment.amount_paid;

                            if (assignmentModal) assignmentModal.classList.add('show');
                            console.log("Edit Assignment modal shown with data for ID:", assignmentId); 
                        } else {
                            showMessage(data.error || 'Failed to load assignment details.', 'error');
                        }
                    } catch (error) {
                        console.error('Error fetching assignment details:', error);
                        showMessage('Network error or server issue fetching assignment details.', 'error');
                    }
                });
            });


            const closeAssignmentModalButtons = assignmentModal ? assignmentModal.querySelectorAll('.close-button, .cancel-button') : [];
            closeAssignmentModalButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (assignmentModal) assignmentModal.classList.remove('show');
                    clearFormErrors('assignmentForm');
                    console.log("Assignment modal closed."); 
                });
            });

            if (assignmentForm) { 
                assignmentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log("Assignment Form submitted."); 
                    clearFormErrors('assignmentForm');

                    const formData = new FormData(assignmentForm);
                    const assignmentIdInput = document.getElementById('assignmentId');
                    const assignmentId = assignmentIdInput ? assignmentIdInput.value : '';
                    const url = assignmentId ? `/api/assignments/${assignmentId}/edit/` : `/dashboard/guests/`;
                    const method = 'POST'; 

                    try {
                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'X-CSRFToken': csrfToken, 
                            },
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success) {
                            showMessage(result.message, 'success');
                            if (assignmentModal) assignmentModal.classList.remove('show');
                            location.reload();
                        } else {
                            let generalErrorMessage = result.error || 'Failed to save assignment due to validation errors.';
                            showMessage(generalErrorMessage, 'error');

                            if (result.errors) {
                                const errors = JSON.parse(result.errors);
                                for (const field in errors) {
                                    const errorDiv = document.getElementById(`${field}Errors`);
                                    if (errorDiv) {
                                        errorDiv.textContent = errors[field][0].message;
                                    } else {
                                        console.error(`Unhandled form error for field ${field}:`, errors[field][0].message);
                                        showMessage(`Error: ${errors[field][0].message}`, 'error');
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error submitting assignment form:', error);
                        showMessage('Network error or server issue saving assignment.', 'error');
                    }
                });
            } 


            // Amenity Modal Logic
            const addAmenityButton = document.getElementById('addAmenityButton');
            const amenityModalTitle = document.getElementById('amenityModalTitle');
            const amenityForm = document.getElementById('amenityForm');
            const amenityIdInput = document.getElementById('amenityId');
            const amenityNameInput = document.getElementById('amenityName');
            const amenityDescriptionInput = document.getElementById('amenityDescription');
            const amenityPriceInput = document.getElementById('amenityPrice');
            const amenityIsAvailableInput = document.getElementById('amenityIsAvailable');

            if (addAmenityButton) { 
                addAmenityButton.addEventListener('click', () => {
                    if (amenityModalTitle) amenityModalTitle.textContent = 'Add New Amenity';
                    if (amenityForm) amenityForm.reset(); 
                    if (amenityIdInput) amenityIdInput.value = ''; 
                    if (amenityModal) amenityModal.classList.add('show');
                    document.querySelectorAll('#amenityForm .error-message').forEach(el => el.textContent = '');
                    console.log("Add Amenity modal shown."); 
                });
            } 

            document.querySelectorAll('.edit-amenity-button').forEach(button => {
                button.addEventListener('click', async () => {
                    console.log("Edit Amenity button clicked."); 
                    const amenityId = button.dataset.amenityId;
                    try {
                        const response = await fetch(`/api/amenities/${amenityId}/`);
                        const result = await response.json();
                        if (result.success) {
                            if (amenityModalTitle) amenityModalTitle.textContent = 'Edit Amenity';
                            if (amenityIdInput) amenityIdInput.value = result.id;
                            if (amenityNameInput) amenityNameInput.value = result.name;
                            if (amenityDescriptionInput) amenityDescriptionInput.value = result.description || '';
                            if (amenityPriceInput) amenityPriceInput.value = result.price;
                            if (amenityIsAvailableInput) amenityIsAvailableInput.checked = result.is_available;
                            if (amenityModal) amenityModal.classList.add('show');
                            document.querySelectorAll('#amenityForm .error-message').forEach(el => el.textContent = '');
                            console.log("Edit Amenity modal shown with data for ID:", amenityId); 
                        } else {
                            showMessage(result.error || 'Failed to load amenity details.', 'error');
                        }
                    } catch (error) {
                        console.error('Error fetching amenity details:', error);
                        showMessage('Network error or server issue loading amenity details.', 'error');
                    }
                });
            });

            // Submit Amenity Form
            if (amenityForm) { 
                amenityForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log("Amenity Form submitted."); 
                    document.querySelectorAll('#amenityForm .error-message').forEach(el => el.textContent = '');

                    const amenityId = amenityIdInput ? amenityIdInput.value : '';
                    const url = '{% url "main:save_or_update_amenity_api" %}'; 
                    
                    const method = 'POST'; 

                    const formData = new FormData(amenityForm);
                    if (amenityIsAvailableInput) formData.set('is_available', amenityIsAvailableInput.checked ? 'True' : 'False');

                    try {
                        const response = await fetch(url, {
                            method: method, 
                            headers: {
                                'X-CSRFToken': csrfToken,
                            },
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success) {
                            showMessage(result.message, 'success');
                            if (amenityModal) amenityModal.classList.remove('show');
                            location.reload(); 
                        } else {
                            let generalErrorMessage = result.error || 'Failed to save amenity due to validation errors.';
                            showMessage(generalErrorMessage, 'error');

                            if (result.errors) {
                                const errors = JSON.parse(result.errors);
                                for (const field in errors) {
                                    const errorDiv = document.getElementById(`amenity${field.charAt(0).toUpperCase() + field.slice(1)}Errors`);
                                    if (errorDiv) {
                                        errorDiv.textContent = errors[field][0].message;
                                    } else {
                                        showMessage(errors[field][0].message, 'error');
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error submitting amenity form:', error);
                        showMessage('Network error or server issue saving amenity.', 'error');
                    }
                });
            } 

            // Delete Assignment Logic
            document.querySelectorAll('.delete-assignment-button').forEach(button => {
                button.addEventListener('click', async () => {
                    console.log("Delete Assignment button clicked."); 
                    const assignmentId = button.dataset.assignmentId;
                    showConfirmationModal('Are you sure you want to delete this guest assignment?', assignmentId, 'delete_assignment');
                });
            });

            // Delete Amenity Logic
            document.querySelectorAll('.delete-amenity-button').forEach(button => {
                button.addEventListener('click', async () => {
                    console.log("Delete Amenity button clicked."); 
                    const amenityId = button.dataset.amenityId;
                    showConfirmationModal('Are you sure you want to delete this amenity? This cannot be undone.', amenityId, 'delete_amenity');
                });
            });
            console.log("Dashboard initialization complete."); 
        }); // End DOMContentLoaded
    </script>
</body>
</html>
