<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }}</title>
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts - Inter for a modern, clean look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- D3.js for charts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        /* New Color Palette from image_01bb87.png */
        :root {
            --light-blue-gray: #D8E0E8;
            --light-green: #D1DFCC;
            --light-yellow-green: #DFE29D;
            --off-white: #F8F8F8;
            --dark-charcoal: #252527;

            /* Mapping new palette to existing UI elements */
            --sidebar-bg: var(--light-blue-gray); /* Changed to light-blue-gray */
            --sidebar-text: var(--dark-charcoal); /* Changed for contrast */
            --header-bg: var(--light-blue-gray);
            --header-text: var(--dark-charcoal);
            --main-bg: var(--light-blue-gray); /* Main background */
            --card-bg: var(--off-white);
            --card-border: var(--dark-charcoal); /* Stronger definition */
            --button-primary-bg: var(--dark-charcoal);
            --button-primary-text: var(--off-white);
            --button-secondary-bg: var(--light-yellow-green); /* Uses another palette color */
            --button-secondary-text: var(--dark-charcoal);
            --link-color: var(--dark-charcoal); /* Consistent link color */
            --success-color: #28a745; /* Standard green for success */
            --error-color: #dc3545; /* Standard red for error */
            --warning-color: #ffc107; /* Standard yellow for warning */
            --info-color: #17a2b8; /* Standard blue for info */
            --table-header-bg: var(--dark-charcoal);
            --table-header-text: var(--off-white);
            --table-row-hover-bg: var(--light-blue-gray);
            --modal-bg: var(--off-white);
            --modal-border: var(--dark-charcoal);
            --input-border: var(--light-blue-gray);
            --input-focus-border: var(--dark-charcoal);
            --chart-color-booked: var(--dark-charcoal);
            --chart-color-cancelled: var(--error-color);
            --chart-color-platform1: var(--light-green);
            --chart-color-platform2: var(--dark-charcoal);
            --chart-color-platform3: var(--light-yellow-green);
            --chart-color-platform4: #9C27B0; /* Keeping these if no direct palette mapping */
            --chart-color-platform5: #FF5722;
            --chart-color-platform6: #607D8B;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--main-bg);
            color: var(--dark-charcoal);
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px; /* Increased width slightly */
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100%;
            overflow-y: auto; /* Ensures scrolling if content overflows */
            box-sizing: border-box; /* Include padding in width */
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--sidebar-text);
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            flex-grow: 1;
        }

        .sidebar ul li {
            margin-bottom: 10px;
        }

        .sidebar ul li a {
            display: block;
            padding: 10px 15px;
            color: var(--sidebar-text);
            text-decoration: none;
            border-radius: 8px;
            transition: background-color 0.3s ease, color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap; /* Prevent text wrapping for menu items */
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: var(--dark-charcoal); /* Darker hover for contrast */
            color: var(--off-white);
        }

        .sidebar ul li a i {
            font-size: 1.1em;
        }

        .logout-section {
            margin-top: auto; /* Pushes logout to the bottom */
            padding-top: 20px;
            border-top: 1px solid var(--dark-charcoal); /* Changed border color */
        }

        .logout-section a {
            display: block;
            padding: 10px 15px;
            color: var(--error-color);
            text-decoration: none;
            border-radius: 8px;
            transition: background-color 0.3s ease, color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logout-section a:hover {
            background-color: var(--error-color);
            color: var(--off-white);
        }

        .main-content {
            margin-left: 280px; /* Offset for adjusted fixed sidebar width */
            flex-grow: 1;
            padding: 20px;
        }

        .header {
            background-color: var(--header-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            margin: 0;
            color: var(--header-text);
        }

        .header .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header .user-info .notification-bell {
            position: relative;
            cursor: pointer;
            color: var(--dark-charcoal);
            font-size: 1.5em;
        }

        .header .user-info .notification-bell .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--error-color);
            color: var(--off-white);
            border-radius: 50%;
            padding: 3px 7px;
            font-size: 0.7em;
            line-height: 1;
        }

        .header .user-info span {
            font-weight: 500;
            color: var(--header-text);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--card-border);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .card h3 {
            margin-top: 0;
            color: var(--dark-charcoal);
            font-size: 1.2em;
            font-weight: 600;
        }

        .card p {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--dark-charcoal);
            margin: 10px 0 0;
        }

        .card.summary-card {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .card.summary-card .icon-wrapper {
            background-color: var(--dark-charcoal);
            color: var(--off-white);
            padding: 15px;
            border-radius: 50%;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            flex-shrink: 0;
        }

        .card.summary-card .text-content {
            flex-grow: 1;
        }

        .card.summary-card .text-content p {
            font-size: 1.5em;
        }

        .chart-container {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--card-border);
            margin-bottom: 20px;
        }

        .chart-container h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--dark-charcoal);
            font-size: 1.2em;
            font-weight: 600;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .chart-placeholder {
            width: 100%;
            height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--light-blue-gray);
            border-radius: 8px;
            color: var(--dark-charcoal);
        }

        /* Request Management Styles */
        .request-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--dark-charcoal);
        }

        .request-tabs button {
            background-color: transparent;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            color: var(--dark-charcoal);
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .request-tabs button:hover {
            color: var(--link-color);
        }

        .request-tabs button.active {
            color: var(--dark-charcoal);
            border-bottom-color: var(--dark-charcoal);
            font-weight: 600;
        }

        .request-category {
            margin-bottom: 30px;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--card-border);
        }

        .request-category h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--dark-charcoal);
            font-size: 1.3em;
            font-weight: 600;
            border-bottom: 1px solid var(--light-blue-gray);
            padding-bottom: 10px;
        }

        .request-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .request-item {
            background-color: var(--light-green); /* Changed to light-green */
            border: 1px solid var(--dark-charcoal);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 150px;
        }

        .request-item p {
            margin: 5px 0;
            font-size: 0.95em;
        }

        .request-item .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: capitalize;
            margin-top: 10px;
        }

        .status-badge.pending { background-color: var(--warning-color); color: var(--dark-charcoal); }
        .status-badge.in_progress { background-color: var(--info-color); color: var(--off-white); }
        .status-badge.completed { background-color: var(--success-color); color: var(--off-white); }
        .status-badge.cancelled { background-color: var(--error-color); color: var(--off-white); }
        .status-badge.casual_chat { background-color: var(--light-yellow-green); color: var(--dark-charcoal); }
        .status-badge.general_inquiry { background-color: var(--light-yellow-green); color: var(--dark-charcoal); }


        .request-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .request-actions button {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .request-actions button.view-details {
            background-color: var(--dark-charcoal);
            color: var(--off-white);
        }
        .request-actions button.view-details:hover {
            background-color: #333;
        }

        .request-actions button.update-status {
            background-color: var(--light-green);
            color: var(--dark-charcoal);
        }
        .request-actions button.update-status:hover {
            background-color: #c0d0bb;
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: var(--modal-bg);
            margin: auto;
            padding: 30px;
            border: 1px solid var(--modal-border);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--light-blue-gray);
            padding-bottom: 10px;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--dark-charcoal);
        }

        .close-button {
            color: var(--dark-charcoal);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--dark-charcoal);
            text-decoration: none;
            cursor: pointer;
        }

        .modal-body label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-charcoal);
        }

        .modal-body input[type="text"],
        .modal-body input[type="email"],
        .modal-body input[type="number"],
        .modal-body input[type="date"],
        .modal-body input[type="time"],
        .modal-body textarea,
        .modal-body select {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 1em;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .modal-body input[type="text"]:focus,
        .modal-body input[type="email"]:focus,
        .modal-body input[type="number"]:focus,
        .modal-body input[type="date"]:focus,
        .modal-body input[type="time"]:focus,
        .modal-body textarea:focus,
        .modal-body select:focus {
            border-color: var(--input-focus-border);
            outline: none;
        }

        .modal-body textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Specific styling for the checkbox in modals */
        .form-check {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .form-check-input {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            accent-color: var(--dark-charcoal);
        }

        .form-check-label {
            margin-bottom: 0;
            font-weight: 500;
            color: var(--dark-charcoal);
            cursor: pointer;
        }

        /* New: Flex container for date and time inputs */
        .datetime-group {
            display: flex;
            gap: 15px; /* Space between date and time fields */
            margin-bottom: 15px; /* Space below the group */
            flex-wrap: wrap; /* Allow items to wrap on smaller screens */
        }

        .datetime-group .form-group {
            flex: 1; /* Each input takes equal space */
            min-width: 120px; /* Minimum width before wrapping */
            margin-bottom: 0; /* Remove individual form-group margin as handled by parent */
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            border-top: 1px solid var(--light-blue-gray);
            padding-top: 15px;
        }

        .modal-footer button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .modal-footer button.save-button {
            background-color: var(--button-primary-bg);
            color: var(--button-primary-text);
        }

        .modal-footer button.save-button:hover {
            background-color: #333;
        }

        .modal-footer button.cancel-button {
            background-color: var(--button-secondary-bg);
            color: var(--button-secondary-text);
        }

        .modal-footer button.cancel-button:hover {
            background-color: #c0c0c0;
        }

        /* Message Box Styles */
        #messageBox {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 500;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        #messageBox.show {
            opacity: 1;
            display: block;
        }

        #messageBox.success {
            background-color: var(--success-color);
            color: var(--off-white);
        }

        #messageBox.error {
            background-color: var(--error-color);
            color: var(--off-white);
        }

        /* Request Details Modal Specific Styles */
        .request-details-modal .modal-body .detail-row {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px dashed var(--light-blue-gray);
            padding-bottom: 5px;
        }

        .request-details-modal .modal-body .detail-row strong {
            flex: 0 0 120px;
            color: var(--dark-charcoal);
        }

        .request-details-modal .modal-body .detail-row span {
            flex-grow: 1;
            color: var(--dark-charcoal);
        }

        .request-details-modal .chat-history-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--light-blue-gray);
        }

        .request-details-modal .chat-history-section h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--dark-charcoal);
        }

        .request-details-modal .chat-messages {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--light-blue-gray);
            border-radius: 8px;
            padding: 10px;
            background-color: var(--light-blue-gray);
        }

        .request-details-modal .chat-message {
            margin-bottom: 8px;
            padding: 5px 8px;
            border-radius: 6px;
        }

        .request-details-modal .chat-message.user {
            background-color: var(--off-white);
            text-align: left;
        }

        .request-details-modal .chat-message.model {
            background-color: var(--light-green);
            text-align: left;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: none;
                border-bottom: 2px solid var(--light-blue-gray);
            }
            .main-content {
                margin-left: 0;
                padding-top: 20px;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .header .user-info {
                width: 100%;
                justify-content: flex-end;
            }
            .dashboard-grid, .chart-grid, .request-list {
                grid-template-columns: 1fr;
            }
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            /* Date/Time fields stack on small screens */
            .datetime-group {
                flex-direction: column;
                gap: 0; /* Remove gap when stacking */
            }
            .datetime-group .form-group {
                width: 100%; /* Full width when stacked */
                margin-bottom: 15px; /* Add back margin for stacked items */
            }
        }

        /* Table styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .data-table thead {
            background-color: var(--table-header-bg);
            color: var(--table-header-text);
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--light-blue-gray);
        }

        .data-table tbody tr:hover {
            background-color: var(--table-row-hover-bg);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .table-responsive {
            overflow-x: auto;
            border-radius: 8px;
        }

        /* Form control styling for filter forms - Using CSS Grid for better layout */
        .filter-card form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 1em;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .form-control:focus {
            border-color: var(--input-focus-border);
            outline: none;
        }

        .form-group {
            margin-bottom: 0;
        }

        .button-primary {
            background-color: var(--button-primary-bg);
            color: var(--button-primary-text);
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .button-primary:hover {
            background-color: #333;
        }

        .button-secondary {
            background-color: var(--button-secondary-bg);
            color: var(--button-secondary-text);
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .button-secondary:hover {
            background-color: #c0c0c0;
        }

        .error-message {
            color: var(--error-color);
            font-size: 0.85em;
            margin-top: -10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h2>ConciAI</h2>
            <ul>
                <li><a href="{% url 'main:home_dashboard' %}" class="{% if current_main_tab == 'home' %}active{% endif %}"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="{% url 'main:guest_requests_dashboard' %}" class="{% if current_main_tab == 'requests' %}active{% endif %}"><i class="fas fa-bell"></i> Guest Requests</a></li>
                <li><a href="{% url 'main:guest_management' %}" class="{% if current_main_tab == 'guest_management' %}active{% endif %}"><i class="fas fa-users"></i> Guest Management</a></li>
                <li><a href="{% url 'main:amenity_management' %}" class="{% if current_main_tab == 'amenities' %}active{% endif %}"><i class="fas fa-spa"></i> Amenity Management</a></li>
            </ul>
            <div class="logout-section">
                <a href="{% url 'logout' %}"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </aside>

        <main class="main-content">
            <header class="header">
                <h1>{{ page_title }}</h1>
                <div class="user-info">
                    <div class="notification-bell" id="notificationBell">
                        <i class="fas fa-bell"></i>
                        <span class="badge" id="notificationBadge">0</span>
                    </div>
                    <span>Hello, {{ user.username }}!</span>
                </div>
            </header>

            {% if current_main_tab == 'home' %}
                <div class="dashboard-grid">
                    <div class="card summary-card">
                        <div class="icon-wrapper"><i class="fas fa-door-open"></i></div>
                        <div class="text-content">
                            <h3>Occupied Rooms</h3>
                            <p>{{ occupied_rooms }} / {{ total_rooms }}</p>
                        </div>
                    </div>
                    <div class="card summary-card">
                        <div class="icon-wrapper"><i class="fas fa-calendar-check"></i></div>
                        <div class="text-content">
                            <h3>Reserved Rooms</h3>
                            <p>{{ reserved_rooms }}</p>
                        </div>
                    </div>
                    <div class="card summary-card">
                        <div class="icon-wrapper"><i class="fas fa-bed"></i></div>
                        <div class="text-content">
                            <h3>Available Rooms</h3>
                            <p>{{ available_rooms }}</p>
                        </div>
                    </div>
                    <div class="card summary-card">
                        <div class="icon-wrapper"><i class="fas fa-tools"></i></div>
                        <div class="text-content">
                            <h3>Rooms Not Ready</h3>
                            <p>{{ not_ready_rooms }}</p>
                        </div>
                    </div>
                    <div class="card summary-card">
                        <div class="icon-wrapper"><i class="fas fa-book-open"></i></div>
                        <div class="text-content">
                            <h3>New Bookings Today</h3>
                            <p>{{ new_bookings_count }}</p>
                        </div>
                    </div>
                    <div class="card summary-card">
                        <div class="icon-wrapper"><i class="fas fa-sign-in-alt"></i></div>
                        <div class="text-content">
                            <h3>Check-ins Today</h3>
                            <p>{{ check_ins_today_count }}</p>
                        </div>
                    </div>
                    <div class="card summary-card">
                        <div class="icon-wrapper"><i class="fas fa-sign-out-alt"></i></div>
                        <div class="text-content">
                            <h3>Check-outs Today</h3>
                            <p>{{ check_outs_today_count }}</p>
                        </div>
                    </div>
                    <div class="card summary-card">
                        <div class="icon-wrapper"><i class="fas fa-concierge-bell"></i></div>
                        <div class="text-content">
                            <h3>Total Requests</h3>
                            <p>{{ total_requests_count }}</p>
                        </div>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>Reservations (Last 7 Days)</h3>
                        <svg id="reservationsChart" class="chart-placeholder"></svg>
                    </div>
                    <div class="chart-container">
                        <h3>Bookings by Platform</h3>
                        <svg id="bookingPlatformChart" class="chart-placeholder"></svg>
                    </div>
                </div>

            {% elif current_main_tab == 'requests' %}
                <div class="request-tabs">
                    <button class="tab-button {% if current_sub_tab == 'active' %}active{% endif %}" onclick="location.href='{% url 'main:active_requests' %}'">Active Requests</button>
                    <button class="tab-button {% if current_sub_tab == 'archive' %}active{% endif %}" onclick="location.href='{% url 'main:archive_requests' %}'">Archive</button>
                    <button class="tab-button {% if current_sub_tab == 'all' %}active{% endif %}" onclick="location.href='{% url 'main:all_requests' %}'">All Requests</button>
                </div>

                {% if has_any_requests %}
                    {% for category in grouped_requests %}
                        <div class="request-category">
                            <h3>{{ category.display_name }} ({{ category.requests|length }})</h3>
                            <div class="request-list">
                                {% for item in category.requests %}
                                    <div class="request-item" data-request-id="{{ item.request.id }}"> {# Added data-request-id here #}
                                        <div>
                                            <p><strong>Room:</strong> {{ item.request.room_number }}</p>
                                            <p><strong>Guest:</strong> {{ item.assignment.guest_names|default:"N/A" }}</p>
                                            <p><strong>Request:</strong> {{ item.request.raw_text|truncatechars:70 }}</p>
                                            {% if item.request.request_type == 'amenity_request' and item.request.amenity_requested %}
                                                <p><strong>Amenity:</strong> {{ item.request.amenity_requested.name }} (x{{ item.request.amenity_quantity }})</p>
                                                <p><strong>Cost:</strong> ${{ item.request.amenity_requested.price|floatformat:2 }} each</p>
                                            {% endif %}
                                            <p><strong>Status:</strong> <span class="status-badge {{ item.request.status }}">{{ item.request.get_status_display }}</span></p>
                                        </div>
                                        <div class="request-actions">
                                            <button class="view-details" data-request-id="{{ item.request.id }}">View Details</button>
                                            {% if item.request.status == 'pending' %}
                                                <button class="update-status" data-request-id="{{ item.request.id }}" data-new-status="in_progress">Mark In Progress</button>
                                            {% elif item.request.status == 'in_progress' %}
                                                <button class="update-status" data-request-id="{{ item.request.id }}" data-new-status="completed">Mark Completed</button>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>No requests found for this category.</p>
                {% endif %}


            {% elif current_main_tab == 'guest_management' %}
                <div class="guest-management-section">
                    <button id="addAssignmentButton" class="button-primary" style="margin-bottom: 20px;">Add New Guest Assignment</button>

                    <!-- Filter Form -->
                    <div class="filter-card card" style="margin-bottom: 20px;">
                        <h3>Filter Assignments</h3>
                        <form id="filterForm" method="GET" action="{% url 'main:guest_management' %}">
                            <div class="form-group">
                                <label for="room_number_filter">Room Number:</label>
                                <input type="text" id="room_number_filter" name="room_number" value="{{ filter_params.room_number|default:'' }}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="guest_names_filter">Guest Names:</label>
                                <input type="text" id="guest_names_filter" name="guest_names" value="{{ filter_params.guest_names|default:'' }}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="status_filter">Status:</label>
                                <select id="status_filter" name="status" class="form-control">
                                    <option value="">All</option>
                                    {% for value, label in assignment_status_choices %}
                                        <option value="{{ value }}" {% if filter_params.status == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="check_in_date_from_filter">Check-in Date From:</label>
                                <input type="date" id="check_in_date_from_filter" name="check_in_date_from" value="{{ filter_params.check_in_date_from|default:'' }}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="check_in_date_to_filter">Check-in Date To:</label>
                                <input type="date" id="check_in_date_to_filter" name="check_in_date_to" value="{{ filter_params.check_in_date_to|default:'' }}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="check_out_date_from_filter">Check-out Date From:</label>
                                <input type="date" id="check_out_date_from_filter" name="check_out_date_from" value="{{ filter_params.check_out_date_from|default:'' }}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="check_out_date_to_filter">Check-out Date To:</label>
                                <input type="date" id="check_out_date_to_to_filter" name="check_out_date_to" value="{{ filter_params.check_out_date_to|default:'' }}" class="form-control">
                            </div>
                            <button type="submit" class="button-primary" style="margin-top: 20px;">Apply Filters</button>
                            <button type="button" class="button-secondary" style="margin-top: 20px;" onclick="window.location.href='{% url 'main:guest_management' %}'">Clear Filters</button>
                        </form>
                    </div>


                    <h3>All Guest Assignments</h3>
                    {% if all_assignments %}
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Room No.</th>
                                        <th>Guest Names</th>
                                        <th>Check-in</th>
                                        <th>Check-out</th>
                                        <th>Status</th>
                                        <th>Total Bill</th>
                                        <th>Amount Paid</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for assignment in all_assignments %}
                                        <tr>
                                            <td>{{ assignment.room_number }}</td>
                                            <td>{{ assignment.guest_names }}</td>
                                            <td>{{ assignment.check_in_time|date:"M d, Y H:i" }}</td>
                                            <td>{{ assignment.check_out_time|date:"M d, Y H:i" }}</td>
                                            <td><span class="status-badge {{ assignment.status }}">{{ assignment.get_status_display }}</span></td>
                                            <td>${{ assignment.total_bill_amount|floatformat:2 }}</td>
                                            <td>${{ assignment.amount_paid|floatformat:2 }}</td>
                                            <td>
                                                <button class="edit-assignment-button" data-assignment-id="{{ assignment.id }}">Edit</button>
                                                <button class="delete-assignment-button" data-assignment-id="{{ assignment.id }}">Delete</button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p>No guest assignments found.</p>
                    {% endif %}
                </div>

            {% elif current_main_tab == 'amenities' %}
                <div class="amenity-management-section">
                    <button id="addAmenityButton" class="button-primary" style="margin-bottom: 20px;">Add New Amenity</button>

                    <h3>Current Amenities</h3>
                    {% if amenities %}
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Price</th>
                                        <th>Available</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for amenity in amenities %}
                                        <tr>
                                            <td>{{ amenity.name }}</td>
                                            <td>{{ amenity.description|default:"-" }}</td>
                                            <td>${{ amenity.price|floatformat:2 }}</td>
                                            <td>
                                                {% if amenity.is_available %}
                                                    <i class="fas fa-check-circle" style="color: var(--success-color);"></i> Yes
                                                {% else %}
                                                    <i class="fas fa-times-circle" style="color: var(--error-color);"></i> No
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button class="edit-amenity-button" data-amenity-id="{{ amenity.id }}">Edit</button>
                                                <button class="delete-amenity-button" data-amenity-id="{{ amenity.id }}">Delete</button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p>No amenities found.</p>
                    {% endif %}
                </div>
            {% endif %}
        </main>
    </div>

    <!-- Add/Edit Guest Assignment Modal -->
    <div id="assignmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="assignmentModalTitle">Add New Guest Assignment</h2>
                <span class="close-button">&times;</span>
            </div>
            <form id="assignmentForm" class="modal-body">
                {% csrf_token %}
                <input type="hidden" id="assignmentId" name="assignment_id">

                <!-- Room Number Input -->
                <div class="form-group">
                    <label for="{{ form.room_number_input.id_for_label }}">{{ form.room_number_input.label }}:</label>
                    {{ form.room_number_input }}
                    <div id="roomNumberInputErrors" class="error-message"></div>
                </div>

                <!-- Guest Names -->
                <div class="form-group">
                    <label for="{{ form.guest_names.id_for_label }}">{{ form.guest_names.label }}:</label>
                    {{ form.guest_names }}
                    <div id="guestNamesErrors" class="error-message"></div>
                </div>

                <!-- Check-in Date and Time -->
                <div class="datetime-group">
                    <div class="form-group">
                        <label for="{{ form.check_in_date.id_for_label }}">{{ form.check_in_date.label }}:</label>
                        {{ form.check_in_date }}
                        <div id="checkInDateErrors" class="error-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="{{ form.check_in_time_input.id_for_label }}">{{ form.check_in_time_input.label }}:</label>
                        {{ form.check_in_time_input }}
                        <div id="checkInTimeInputErrors" class="error-message"></div>
                    </div>
                </div>

                <!-- Check-out Date and Time -->
                <div class="datetime-group">
                    <div class="form-group">
                        <label for="{{ form.check_out_date.id_for_label }}">{{ form.check_out_date.label }}:</label>
                        {{ form.check_out_date }}
                        <div id="checkOutDateErrors" class="error-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="{{ form.check_out_time_input.id_for_label }}">{{ form.check_out_time_input.label }}:</label>
                        {{ form.check_out_time_input }}
                        <div id="checkOutTimeInputErrors" class="error-message"></div>
                    </div>
                </div>

                <!-- Total Bill Amount -->
                <div class="form-group">
                    <label for="{{ form.total_bill_amount.id_for_label }}">{{ form.total_bill_amount.label }}:</label>
                    {{ form.total_bill_amount }}
                    <div id="totalBillAmountErrors" class="error-message"></div>
                </div>

                <!-- Amount Paid - Explicitly setting label text -->
                <div class="form-group">
                    <label for="{{ form.amount_paid.id_for_label }}">Amount Paid:</label> {# Explicitly set label text #}
                    {{ form.amount_paid }}
                    <div id="amountPaidErrors" class="error-message"></div>
                </div>

                <!-- Status -->
                <div class="form-group">
                    <label for="{{ form.status.id_for_label }}">{{ form.status.label }}:</label>
                    {{ form.status }}
                    <div id="statusErrors" class="error-message"></div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="save-button">Add Assignment</button>
                    <button type="button" class="cancel-button">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Request Details Modal -->
    <div id="requestDetailsModal" class="modal request-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Request Details</h2>
                <span class="close-button" id="closeRequestDetailsModalButton">&times;</span>
            </div>
            <div class="modal-body">
                <div class="detail-row"><strong>Room:</strong> <span id="detailRoomNumber"></span></div>
                <div class="detail-row"><strong>Guest:</strong> <span id="detailGuestNames"></span></div>
                <div class="detail-row"><strong>Status:</strong> <span id="detailStatus"></span></div>
                <div class="detail-row"><strong>Type:</strong> <span id="detailRequestType"></span></div>
                <div class="detail-row"><strong>Timestamp:</strong> <span id="detailTimestamp"></span></div>
                <div class="detail-row"><strong>Raw Text:</strong> <span id="detailRawText"></span></div>
                <div class="detail-row"><strong>Conci Response:</strong> <span id="detailConciResponse"></span></div>
                <div class="detail-row"><strong>AI Intent:</strong> <span id="detailAiIntent"></span></div>
                <div class="detail-row"><strong>AI Entities:</strong> <span id="detailAiEntities"></span></div>
                <div class="detail-row"><strong>Staff Notes:</strong> <span id="detailStaffNotes"></span></div>
                <div id="amenityDetailsSection" style="display:none;">
                    <div class="detail-row"><strong>Amenity Name:</strong> <span id="detailAmenityName"></span></div>
                    <div class="detail-row"><strong>Amenity Quantity:</strong> <span id="detailAmenityQuantity"></span></div>
                    <div class="detail-row"><strong>Price per Unit:</strong> <span id="detailPricePerUnit"></span></div>
                    <div class="detail-row"><strong>Total Amenity Cost:</strong> <span id="detailTotalAmenityCost"></span></div>
                    <div class="detail-row"><strong>Bill Added:</strong> <span id="detailBillAdded"></span></div>
                </div>
                <div class="chat-history-section">
                    <h4>Conversation History</h4>
                    <div class="chat-messages" id="detailChatHistory">
                        <!-- Chat messages will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="cancel-button" id="closeRequestDetailsModalButtonFooter">Close</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Amenity Modal -->
    <div id="amenityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="amenityModalTitle">Add New Amenity</h2>
                <span class="close-button">&times;</span>
            </div>
            <form id="amenityForm" class="modal-body">
                {% csrf_token %}
                <input type="hidden" id="amenityId" name="amenity_id">

                <div class="form-group">
                    <label for="id_name">Name:</label>
                    <input type="text" id="id_name" name="name" class="form-control" required>
                    <div id="amenityNameErrors" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="id_description">Description:</label>
                    <textarea id="id_description" name="description" class="form-control" rows="3"></textarea>
                    <div id="amenityDescriptionErrors" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="id_price">Price:</label>
                    <input type="number" step="0.01" id="id_price" name="price" class="form-control" required>
                    <div id="amenityPriceErrors" class="error-message"></div>
                </div>
                <div class="form-group form-check">
                    <input type="checkbox" id="id_is_available" name="is_available" class="form-check-input">
                    <label class="form-check-label" for="id_is_available">Is Available</label>
                    <div id="amenityIsAvailableErrors" class="error-message"></div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="save-button">Save Amenity</button>
                    <button type="button" class="cancel-button">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Confirmation Modal for Status Updates -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="confirmationModalTitle">Confirm Action</h2>
                <span class="close-button confirmation-close-button">&times;</span>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="button-secondary confirmation-cancel-button">No</button>
                <button type="button" class="button-primary" id="confirmationYesButton">Yes</button>
            </div>
        </div>
    </div>


    <div id="messageBox"></div>

    <script>
        // Global utility function to show messages
        function showMessage(message, type) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = ''; // Clear existing classes
            messageBox.classList.add('show', type);
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000); // Hide after 3 seconds
        }

        // Notification Bell Logic
        const notificationBell = document.getElementById('notificationBell');
        const notificationBadge = document.getElementById('notificationBadge');
        let lastCheckTimestamp = new Date().toISOString(); // Initialize with current time

        async function fetchNewRequests() {
            try {
                const response = await fetch(`/api/check_new_requests/?last_check=${encodeURIComponent(lastCheckTimestamp)}`);
                const data = await response.json();

                if (data.success) {
                    notificationBadge.textContent = data.new_requests_count;
                    if (data.new_requests_count > 0) {
                        notificationBadge.style.display = 'block'; // Show badge
                    } else {
                        notificationBadge.style.display = 'none'; // Hide badge
                    }
                    lastCheckTimestamp = data.current_timestamp; // Update timestamp for next check
                } else {
                    console.error('Failed to fetch new requests:', data.error);
                }
            } catch (error) {
                console.error('Network error fetching new requests:', error);
            }
        }

        // Fetch new requests every 30 seconds
        setInterval(fetchNewRequests, 30000);
        fetchNewRequests(); // Initial fetch on page load

        // D3.js Chart for Reservations (Last 7 Days)
        // Only include this JavaScript block if current_main_tab is 'home'
        {% if current_main_tab == 'home' %}
            const reservationsData = {{ reservations_chart_data|safe }};
            const bookingPlatformData = {{ booking_platform_data|safe }};

            function drawReservationsChart() {
                const svg = d3.select("#reservationsChart");
                const margin = {top: 20, right: 30, bottom: 40, left: 40};
                const width = parseFloat(svg.style("width")) - margin.left - margin.right;
                const height = parseFloat(svg.style("height")) - margin.top - margin.bottom;

                svg.selectAll("*").remove(); // Clear previous chart

                const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                const x = d3.scaleBand()
                    .domain(reservationsData.map(d => d.date))
                    .range([0, width])
                    .padding(0.2);

                const y = d3.scaleLinear()
                    .domain([0, d3.max(reservationsData, d => Math.max(d.booked, d.cancelled)) + 5])
                    .range([height, 0]);

                g.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x));

                g.append("g")
                    .call(d3.axisLeft(y));

                // Booked bars
                g.selectAll(".bar-booked")
                    .data(reservationsData)
                    .enter().append("rect")
                    .attr("class", "bar-booked")
                    .attr("x", d => x(d.date))
                    .attr("y", d => y(d.booked))
                    .attr("width", x.bandwidth() / 2)
                    .attr("height", d => height - y(d.booked))
                    .attr("fill", "var(--chart-color-booked)");

                // Cancelled bars
                g.selectAll(".bar-cancelled")
                    .data(reservationsData)
                    .enter().append("rect")
                    .attr("class", "bar-cancelled")
                    .attr("x", d => x(d.date) + x.bandwidth() / 2)
                    .attr("y", d => y(d.cancelled))
                    .attr("width", x.bandwidth() / 2)
                    .attr("height", d => height - y(d.cancelled))
                    .attr("fill", "var(--chart-color-cancelled)");
            }

            function drawBookingPlatformChart() {
                const svg = d3.select("#bookingPlatformChart");
                const width = parseFloat(svg.style("width"));
                const height = parseFloat(svg.style("height"));
                const radius = Math.min(width, height) / 2 - 20;

                svg.selectAll("*").remove(); // Clear previous chart

                const g = svg.append("g")
                    .attr("transform", `translate(${width / 2},${height / 2})`);

                const color = d3.scaleOrdinal()
                    .range([
                        "var(--chart-color-platform1)",
                        "var(--chart-color-platform2)",
                        "var(--chart-color-platform3)",
                        "var(--chart-color-platform4)",
                        "var(--chart-color-platform5)",
                        "var(--chart-color-platform6)"
                    ]);

                const pie = d3.pie()
                    .value(d => d.value);

                const path = d3.arc()
                    .outerRadius(radius - 10)
                    .innerRadius(0);

                const label = d3.arc()
                    .outerRadius(radius)
                    .innerRadius(radius - 80);

                const arc = g.selectAll(".arc")
                    .data(pie(bookingPlatformData))
                    .enter().append("g")
                    .attr("class", "arc");

                arc.append("path")
                    .attr("d", path)
                    .attr("fill", d => color(d.data.platform));

                arc.append("text")
                    .attr("transform", d => `translate(${label.centroid(d)})`)
                    .attr("text-anchor", "middle")
                    .text(d => `${d.data.platform} (${d.data.value}%)`)
                    .style("fill", "var(--dark-charcoal)")
                    .style("font-size", "0.8em");
            }

            // Initial chart drawing
            window.addEventListener('load', () => {
                drawReservationsChart();
                drawBookingPlatformChart();
            });

            // Redraw charts on window resize
            window.addEventListener('resize', () => {
                drawReservationsChart();
                drawBookingPlatformChart();
            });
        {% endif %}

        // Request Details Modal Logic
        const requestDetailsModal = document.getElementById('requestDetailsModal');
        const closeRequestDetailsModalButton = document.getElementById('closeRequestDetailsModalButton');
        const closeRequestDetailsModalButtonFooter = document.getElementById('closeRequestDetailsModalButtonFooter');
        const viewDetailsButtons = document.querySelectorAll('.view-details');

        viewDetailsButtons.forEach(button => {
            button.addEventListener('click', async () => {
                const requestId = button.dataset.requestId;
                try {
                    const response = await fetch(`/api/requests/${requestId}/details/`);
                    const result = await response.json();

                    if (result.success) {
                        document.getElementById('detailRoomNumber').textContent = result.room_number;
                        document.getElementById('detailGuestNames').textContent = result.guest_names;
                        document.getElementById('detailStatus').textContent = result.status;
                        document.getElementById('detailRequestType').textContent = result.request_type;
                        document.getElementById('detailTimestamp').textContent = new Date(result.timestamp).toLocaleString();
                        document.getElementById('detailRawText').textContent = result.raw_text;
                        document.getElementById('detailConciResponse').textContent = result.conci_response_text;
                        document.getElementById('detailAiIntent').textContent = result.ai_intent;
                        document.getElementById('detailAiEntities').textContent = JSON.stringify(result.ai_entities, null, 2);
                        document.getElementById('detailStaffNotes').textContent = result.staff_notes;

                        // Amenity details section
                        const amenityDetailsSection = document.getElementById('amenityDetailsSection');
                        if (result.amenity_details) {
                            amenityDetailsSection.style.display = 'block';
                            document.getElementById('detailAmenityName').textContent = result.amenity_details.name;
                            document.getElementById('detailAmenityQuantity').textContent = result.amenity_details.quantity;
                            document.getElementById('detailPricePerUnit').textContent = `$${result.amenity_details.price_per_unit.toFixed(2)}`;
                            document.getElementById('detailTotalAmenityCost').textContent = `$${result.amenity_details.total_amenity_cost.toFixed(2)}`;
                            document.getElementById('detailBillAdded').textContent = result.amenity_details.bill_added ? 'Yes' : 'No';
                        } else {
                            amenityDetailsSection.style.display = 'none';
                        }


                        const detailChatHistory = document.getElementById('detailChatHistory');
                        detailChatHistory.innerHTML = ''; // Clear previous history
                        if (result.chat_history && result.chat_history.length > 0) {
                            result.chat_history.forEach(message => {
                                const msgDiv = document.createElement('div');
                                msgDiv.classList.add('chat-message', message.role);
                                msgDiv.innerHTML = `<strong>${message.role === 'user' ? 'Guest' : 'Conci'}:</strong> ${message.parts[0].text}`;
                                detailChatHistory.appendChild(msgDiv);
                            });
                        } else {
                            detailChatHistory.innerHTML = '<p>No detailed conversation history available.</p>';
                        }

                        requestDetailsModal.classList.add('show'); // Show the modal
                    } else {
                        console.error('Backend reported error for Request Details:', result.error);
                        showMessage(result.error || 'Failed to load request details.', 'error');
                    }
                }
                catch (error) {
                    console.error('Error fetching request details:', error);
                    showMessage('Network error or server issue fetching request details.', 'error');
                }
            });
        });

        // Close Request Details Modal
        if (closeRequestDetailsModalButton) {
            closeRequestDetailsModalButton.addEventListener('click', () => {
                requestDetailsModal.classList.remove('show');
            });
        }
        if (closeRequestDetailsModalButtonFooter) {
            closeRequestDetailsModalButtonFooter.addEventListener('click', () => {
                requestDetailsModal.classList.remove('show');
            });
        }

        // Custom Confirmation Modal Logic for Status Updates
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmationYesButton = document.getElementById('confirmationYesButton');
        const confirmationCloseButtons = confirmationModal.querySelectorAll('.confirmation-close-button, .confirmation-cancel-button');

        let currentRequestId = null;
        let currentNewStatus = null; // Will also hold action type for deletes

        // Function to show the custom confirmation modal
        function showConfirmationModal(message, requestId, newStatus) {
            confirmationMessage.textContent = message;
            currentRequestId = requestId;
            currentNewStatus = newStatus;
            confirmationModal.classList.add('show');
        }

        // Event listener for the "Yes" button in the custom confirmation modal
        confirmationYesButton.addEventListener('click', async () => {
            confirmationModal.classList.remove('show'); // Hide modal immediately

            // Determine which action to take based on currentNewStatus (which now holds the action type)
            if (currentNewStatus === 'delete_assignment') {
                try {
                    const response = await fetch(`/api/assignments/${currentRequestId}/delete/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    });
                    const result = await response.json();
                    if (result.success) {
                        showMessage('Assignment deleted successfully!', 'success');
                        // No need to reload, just remove the row
                        const deletedRow = document.querySelector(`.data-table tbody tr [data-assignment-id="${currentRequestId}"]`).closest('tr');
                        if (deletedRow) {
                            deletedRow.remove();
                        }
                    } else {
                        showMessage(result.error || 'Failed to delete assignment.', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting assignment:', error);
                    showMessage('Network error or server issue deleting assignment.', 'error');
                }
            } else if (currentNewStatus === 'delete_amenity') {
                try {
                    const response = await fetch(`/api/amenities/${currentRequestId}/delete/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    });
                    const result = await response.json();
                    if (result.success) {
                        showMessage('Amenity deleted successfully!', 'success');
                        // No need to reload, just remove the row
                        const deletedRow = document.querySelector(`.data-table tbody tr [data-amenity-id="${currentRequestId}"]`).closest('tr');
                        if (deletedRow) {
                            deletedRow.remove();
                        }
                    } else {
                        showMessage(result.error || 'Failed to delete amenity.', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting amenity:', error);
                    showMessage('Network error or server issue deleting amenity.', 'error');
                }
            } else {
                // This is the original status update logic for Guest Requests
                try {
                    const response = await fetch(`/request/${currentRequestId}/update_status/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: `new_status=${currentNewStatus}`
                    });
                    const result = await response.json();
                    if (result.success) {
                        showMessage('Status updated successfully!', 'success');
                        // Dynamically update the status badge
                        const requestItem = document.querySelector(`.request-item[data-request-id="${currentRequestId}"]`);
                        if (requestItem) {
                            const statusBadge = requestItem.querySelector('.status-badge');
                            if (statusBadge) {
                                // Remove old status classes and add new one
                                statusBadge.classList.remove('pending', 'in_progress', 'completed', 'cancelled', 'casual_chat', 'general_inquiry');
                                statusBadge.classList.add(currentNewStatus);
                                // Update text content
                                statusBadge.textContent = currentNewStatus.replace('_', ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

                                // Optionally, disable the button that was clicked if it's no longer applicable
                                const clickedButton = requestItem.querySelector(`button[data-request-id="${currentRequestId}"][data-new-status="${currentNewStatus}"]`);
                                if (clickedButton) {
                                    clickedButton.style.display = 'none'; // Hide the button
                                    // You might want to show the next logical button (e.g., if "Mark In Progress" was clicked, show "Mark Completed")
                                    if (currentNewStatus === 'in_progress') {
                                        const markCompletedButton = requestItem.querySelector(`button[data-new-status="completed"]`);
                                        if (markCompletedButton) markCompletedButton.style.display = 'inline-block';
                                    } else if (currentNewStatus === 'completed') {
                                        // Hide all status update buttons if completed
                                        requestItem.querySelectorAll('.update-status').forEach(btn => btn.style.display = 'none');
                                    }
                                }
                            }
                        }
                    } else {
                        showMessage(result.error || 'Failed to update status.', 'error');
                    }
                } catch (error) {
                    console.error('Error updating status:', error);
                    showMessage('Network error or server issue updating status.', 'error');
                }
            }
        });

        // Event listeners to close the custom confirmation modal
        confirmationCloseButtons.forEach(button => {
            button.addEventListener('click', () => {
                confirmationModal.classList.remove('show');
            });
        });

        // Update Request Status Logic (now uses custom confirmation modal)
        document.querySelectorAll('.update-status').forEach(button => {
            button.addEventListener('click', () => {
                const requestId = button.dataset.requestId;
                const newStatus = button.dataset.newStatus;
                const statusDisplayName = newStatus.replace(/_/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                showConfirmationModal(`Are you sure you want to change status to "${statusDisplayName}"?`, requestId, newStatus);
            });
        });

        // Add/Edit Guest Assignment Modal Logic
        const assignmentModal = document.getElementById('assignmentModal');
        const addAssignmentButton = document.getElementById('addAssignmentButton');
        const assignmentForm = document.getElementById('assignmentForm');
        const closeAssignmentModalButtons = assignmentModal.querySelectorAll('.close-button, .cancel-button');
        const assignmentModalTitle = document.getElementById('assignmentModalTitle');

        // Function to clear form errors
        function clearFormErrors() {
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
        }

        // Open Add Assignment Modal
        if (addAssignmentButton) {
            addAssignmentButton.addEventListener('click', () => {
                assignmentModalTitle.textContent = 'Add New Guest Assignment';
                assignmentForm.reset(); // Clear form fields
                document.getElementById('assignmentId').value = ''; // Clear hidden ID
                clearFormErrors();
                assignmentModal.classList.add('show');
            });
        }

        // Open Edit Assignment Modal
        document.querySelectorAll('.edit-assignment-button').forEach(button => {
            button.addEventListener('click', async () => {
                const assignmentId = button.dataset.assignmentId;
                assignmentModalTitle.textContent = 'Edit Guest Assignment';
                assignmentForm.reset(); // Clear form fields
                document.getElementById('assignmentId').value = assignmentId; // Set hidden ID
                clearFormErrors();

                try {
                    const response = await fetch(`/api/assignments/${assignmentId}/edit/`); // Assuming GET request for initial data
                    const data = await response.json();
                    if (data.success) {
                        // Populate form fields with existing data
                        if (data.assignment.check_in_time) {
                            const checkInDateTime = new Date(data.assignment.check_in_time);
                            assignmentForm.querySelector('[name="check_in_date"]').value = checkInDateTime.toISOString().split('T')[0];
                            assignmentForm.querySelector('[name="check_in_time_input"]').value = checkInDateTime.toTimeString().slice(0, 5);
                        }
                        if (data.assignment.check_out_time) {
                            const checkOutDateTime = new Date(data.assignment.check_out_time);
                            assignmentForm.querySelector('[name="check_out_date"]').value = checkOutDateTime.toISOString().split('T')[0];
                            assignmentForm.querySelector('[name="check_out_time_input"]').value = checkOutDateTime.toTimeString().slice(0, 5);
                        }
                        
                        if (data.assignment.room_number && data.assignment.room_number.room_number) {
                            assignmentForm.querySelector('[name="room_number_input"]').value = data.assignment.room_number.room_number;
                        }

                        assignmentForm.querySelector('[name="guest_names"]').value = data.assignment.guest_names;
                        assignmentForm.querySelector('[name="status"]').value = data.assignment.status;
                        assignmentForm.querySelector('[name="total_bill_amount"]').value = data.assignment.total_bill_amount;
                        assignmentForm.querySelector('[name="amount_paid"]').value = data.assignment.amount_paid;


                        assignmentModal.classList.add('show');
                    } else {
                        showMessage(data.error || 'Failed to load assignment details.', 'error');
                    }
                } catch (error) {
                    console.error('Error fetching assignment details:', error);
                    showMessage('Network error or server issue fetching assignment details.', 'error');
                }
            });
        });


        // Close Assignment Modal
        closeAssignmentModalButtons.forEach(button => {
            button.addEventListener('click', () => {
                assignmentModal.classList.remove('show');
                clearFormErrors();
            });
        });

        // Submit Assignment Form
        assignmentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearFormErrors();

            const formData = new FormData(assignmentForm);
            const assignmentId = document.getElementById('assignmentId').value;
            const url = assignmentId ? `/api/assignments/${assignmentId}/edit/` : `/dashboard/guests/`;
            const method = assignmentId ? 'POST' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(result.message, 'success');
                    assignmentModal.classList.remove('show');
                    location.reload();
                } else {
                    showMessage(result.error || 'Failed to save assignment.', 'error');
                    if (result.errors) {
                        const errors = JSON.parse(result.errors);
                        for (const field in errors) {
                            const errorDiv = document.getElementById(`${field}Errors`);
                            if (errorDiv) {
                                errorDiv.textContent = errors[field][0].message;
                            } else {
                                showMessage(errors[field][0].message, 'error');
                            }
                        }
                         if (errors.room_number_input) {
                            document.getElementById('roomNumberInputErrors').textContent = errors.room_number_input[0].message;
                        }
                        if (errors.total_bill_amount) {
                            document.getElementById('totalBillAmountErrors').textContent = errors.total_bill_amount[0].message;
                        }
                        if (errors.amount_paid) {
                            document.getElementById('amountPaidErrors').textContent = errors.amount_paid[0].message;
                        }
                    }
                }
            } catch (error) {
                console.error('Error submitting assignment form:', error);
                showMessage('Network error or server issue saving assignment.', 'error');
            }
        });

        // Add/Edit Amenity Modal Logic
        const amenityModal = document.getElementById('amenityModal');
        const addAmenityButton = document.getElementById('addAmenityButton');
        const amenityForm = document.getElementById('amenityForm');
        const closeAmenityModalButtons = amenityModal.querySelectorAll('.close-button, .cancel-button');
        const amenityModalTitle = document.getElementById('amenityModalTitle');

        // Function to clear amenity form errors
        function clearAmenityFormErrors() {
            document.querySelectorAll('#amenityForm .error-message').forEach(el => el.textContent = '');
        }

        // Open Add Amenity Modal
        if (addAmenityButton) {
            addAmenityButton.addEventListener('click', () => {
                amenityModalTitle.textContent = 'Add New Amenity';
                amenityForm.reset();
                document.getElementById('amenityId').value = '';
                clearAmenityFormErrors();
                amenityModal.classList.add('show');
            });
        }

        // Open Edit Amenity Modal
        document.querySelectorAll('.edit-amenity-button').forEach(button => {
            button.addEventListener('click', async () => {
                const amenityId = button.dataset.amenityId;
                amenityModalTitle.textContent = 'Edit Amenity';
                amenityForm.reset();
                document.getElementById('amenityId').value = amenityId;
                clearAmenityFormErrors();

                try {
                    const response = await fetch(`/api/amenities/${amenityId}/`);
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('id_name').value = data.name;
                        document.getElementById('id_description').value = data.description;
                        document.getElementById('id_price').value = data.price;
                        document.getElementById('id_is_available').checked = data.is_available;
                        amenityModal.classList.add('show');
                    } else {
                        showMessage(data.error || 'Failed to load amenity details.', 'error');
                    }
                } catch (error) {
                    console.error('Error fetching amenity details:', error);
                    showMessage('Network error or server issue fetching amenity details.', 'error');
                }
            });
        });

        // Close Amenity Modal
        closeAmenityModalButtons.forEach(button => {
            button.addEventListener('click', () => {
                amenityModal.classList.remove('show');
                clearAmenityFormErrors();
            });
        });

        // Submit Amenity Form
        amenityForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearAmenityFormErrors();

            const formData = new FormData(amenityForm);
            const amenityId = document.getElementById('amenityId').value;
            const url = amenityId ? `/amenities/${amenityId}/` : `/amenities/`;
            const method = 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(result.message, 'success');
                    amenityModal.classList.remove('show');
                    location.reload();
                } else {
                    showMessage(result.error || 'Failed to save amenity.', 'error');
                    if (result.errors) {
                        const errors = JSON.parse(result.errors);
                        for (const field in errors) {
                            const errorDiv = document.getElementById(`amenity${field.charAt(0).toUpperCase() + field.slice(1)}Errors`);
                            if (errorDiv) {
                                errorDiv.textContent = errors[field][0].message;
                            } else {
                                showMessage(errors[field][0].message, 'error');
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error submitting amenity form:', error);
                showMessage('Network error or server issue saving amenity.', 'error');
            }
        });

        // Delete Assignment Logic
        document.querySelectorAll('.delete-assignment-button').forEach(button => {
            button.addEventListener('click', async () => {
                const assignmentId = button.dataset.assignmentId;
                showConfirmationModal('Are you sure you want to delete this guest assignment?', assignmentId, 'delete_assignment');
            });
        });

        // Delete Amenity Logic
        document.querySelectorAll('.delete-amenity-button').forEach(button => {
            button.addEventListener('click', async () => {
                const amenityId = button.dataset.amenityId;
                showConfirmationModal('Are you sure you want to delete this amenity? This cannot be undone.', amenityId, 'delete_amenity');
            });
        });

    </script>
</body>
</html>
