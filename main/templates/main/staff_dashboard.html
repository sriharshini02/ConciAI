<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }}</title>
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts - Inter for a modern, clean look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- D3.js for charts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        /* Restored Color Palette from user's provided snippet, with Dark Mode additions */
        :root {
            /* Light Mode Colors */
            --light-gray-bg: #F0F2F5; /* Main background, slightly darker than sidebar */
            --off-white: #FFFFFF;      /* Sidebar, Card, Modal background */
            --dark-text: #2C3E50;      /* Dark charcoal for main text, headers, primary buttons */
            --medium-gray-border: #D1D9E6; /* Light border for cards, inputs */
            --light-blue-accent: #4A90E2; /* For links, active states */
            --success-color: #28a745; /* Standard green for success */
            --error-color: #dc3545;    /* Standard red for error */
            --warning-color: #ffc107; /* Standard yellow for warning */
            --info-color: #17a2b8;    /* Standard blue for info */

            /* Mapping to UI elements */
            --sidebar-bg: var(--off-white);
            --sidebar-text: var(--dark-text);
            --header-bg: var(--off-white);
            --header-text: var(--dark-text);
            --main-bg: var(--light-gray-bg);
            --card-bg: var(--off-white);
            --card-border: var(--medium-gray-border);
            --button-primary-bg: var(--light-blue-accent);
            --button-primary-text: var(--off-white);
            --button-secondary-bg: var(--medium-gray-border);
            --button-secondary-text: var(--dark-text);
            --link-color: var(--light-blue-accent);
            --table-header-bg: var(--dark-text);
            --table-header-text: var(--off-white);
            --table-row-hover-bg: #E0E6F0; /* Slightly darker hover for light rows */
            --modal-bg: var(--off-white);
            --modal-border: var(--medium-gray-border);
            --input-border: var(--medium-gray-border);
            --input-focus-border: var(--light-blue-accent);
            --chart-color-booked: var(--light-blue-accent);
            --chart-color-cancelled: var(--error-color);
            --chart-color-platform1: #6A8EAE; /* Muted blues/greens for charts */
            --chart-color-platform2: #8EB1C7;
            --chart-color-platform3: #AEC8DC;
            --chart-color-platform4: #C0D0E0;
            --chart-color-platform5: #D0D8E8;
            --chart-color-platform6: #E0E6F0;

            /* Badge Specific Colors (based on standard status colors) */
            --badge-pending-bg: #FFF3CD; /* Light yellow */
            --badge-pending-text: #856404; /* Dark yellow */
            --badge-in_progress-bg: #CCE5FF; /* Light blue */
            --badge-in_progress-text: #004085; /* Dark blue */
            --badge-completed-bg: #D4EDDA; /* Light green */
            --badge-completed-text: #155724; /* Dark green */
            --badge-cancelled-bg: #F8D7DA; /* Light red */
            --badge-cancelled-text: #721C24; /* Dark red */
            --badge-amenity_request-bg: #E6E6FA; /* Lavender */
            --badge-amenity_request-text: #4B0082; /* Indigo */
            --badge-maintenance-bg: #FFEBEE; /* Light pink */
            --badge-maintenance-text: #B71C1C; /* Dark red */
            --badge-housekeeping-bg: #E8F5E9; /* Very light green */
            --badge-housekeeping-text: #2E7D32; /* Dark green */
            --badge-room_service-bg: #FFFDE7; /* Creamy yellow */
            --badge-room_service-text: #F9A825; /* Orange-yellow */
            --badge-concierge-bg: #E3F2FD; /* Pale blue */
            --badge-concierge-text: #1976D2; /* Medium blue */
            --badge-general_inquiry-bg: #F5F5F5; /* Light grey */
            --badge-general_inquiry-text: #424242; /* Dark grey */
            --badge-casual_chat-bg: #ECEFF1; /* Lighter grey */
            --badge-casual_chat-text: #546E7A; /* Blue-grey */
        }

        /* Dark Mode Colors (Less Bright) */
        html[data-theme='dark'] {
            --light-gray-bg: #1A202C; /* Dark background */
            --off-white: #2D3748;      /* Darker sidebar, card, modal background */
            --dark-text: #E2E8F0;      /* Light text */
            --medium-gray-border: #4A5568; /* Darker border */
            --light-blue-accent: #63B3ED; /* Lighter blue for dark mode */
            --success-color: #48BB78;
            --error-color: #FC8181;
            --warning-color: #F6AD55;
            --info-color: #63B3ED;

            /* Mapping to UI elements for Dark Mode */
            --sidebar-bg: var(--off-white);
            --sidebar-text: var(--dark-text);
            --header-bg: var(--off-white);
            --header-text: var(--dark-text);
            --main-bg: var(--light-gray-bg);
            --card-bg: var(--off-white);
            --card-border: var(--medium-gray-border);
            --button-primary-bg: var(--light-blue-accent);
            --button-primary-text: var(--dark-text); /* White text on blue */
            --button-secondary-bg: var(--medium-gray-border);
            --button-secondary-text: var(--dark-text);
            --link-color: var(--light-blue-accent);
            --table-header-bg: #1F2937; /* Even darker for table header */
            --table-header-text: var(--dark-text);
            --table-row-hover-bg: #374151; /* Darker hover for dark rows */
            --modal-bg: var(--off-white);
            --modal-border: var(--medium-gray-border);
            --input-border: var(--medium-gray-border);
            --input-focus-border: var(--light-blue-accent);
            --chart-color-booked: var(--light-blue-accent);
            --chart-color-cancelled: var(--error-color);
            --chart-color-platform1: #63B3ED; /* Lighter shades for dark mode charts */
            --chart-color-platform2: #9F7AEA;
            --chart-color-platform3: #F6AD55;
            --chart-color-platform4: #48BB78;
            --chart-color-platform5: #CBD5E0;
            --chart-color-platform6: #ED8936;

            /* Badge Specific Colors for Dark Mode */
            --badge-pending-bg: #422006;
            --badge-pending-text: #F6AD55;
            --badge-in_progress-bg: #2B6CB0;
            --badge-in_progress-text: #90CDF4;
            --badge-completed-bg: #2F855A;
            --badge-completed-text: #9AE6B4;
            --badge-cancelled-bg: #9B2C2C;
            --badge-cancelled-text: #FC8181;
            --badge-amenity_request-bg: #553C9A;
            --badge-amenity_request-text: #D6BCFA;
            --badge-maintenance-bg: #C53030;
            --badge-maintenance-text: #FC8181;
            --badge-housekeeping-bg: #38A169;
            --badge-housekeeping-text: #9AE6B4;
            --badge-room_service-bg: #D69E2E;
            --badge-room_service-text: #FBD38D;
            --badge-concierge-bg: #3182CE;
            --badge-concierge-text: #90CDF4;
            --badge-general_inquiry-bg: #718096;
            --badge-general_inquiry-text: #CBD5E0;
            --badge-casual_chat-bg: #4A5568;
            --badge-casual_chat-text: #CBD5E0;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--main-bg);
            color: var(--dark-text);
            overflow-x: hidden; /* Prevent horizontal scroll */
            line-height: 1.6;
        }

        .container-wrapper {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            position: fixed; /* Fixed position */
            height: 100vh; /* Full viewport height */
            top: 0;
            left: 0;
            overflow-y: auto; /* Allow sidebar content to scroll */
            box-sizing: border-box;
            transition: width 0.3s ease, transform 0.3s ease;
            z-index: 999;
        }

        .sidebar.collapsed {
            width: 70px; /* Collapsed width */
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--medium-gray-border);
        }

        .sidebar-header h2 {
            margin: 0;
            color: var(--sidebar-text);
            font-size: 1.8em;
            white-space: nowrap;
            overflow: hidden;
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .sidebar-header h2 {
            opacity: 0;
            width: 0;
        }

        .sidebar-toggle-button {
            background: none;
            border: none;
            font-size: 1.5em;
            color: var(--sidebar-text);
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
            position: absolute; /* Position relative to sidebar */
            bottom: 70px; /* Above logout */
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000; /* Ensure it's clickable */
        }

        .sidebar-toggle-button:hover {
            background-color: rgba(0,0,0,0.05);
        }

        .sidebar nav {
            flex-grow: 1; /* Allows navigation to take up remaining space */
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li {
            margin-bottom: 10px;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            color: var(--sidebar-text);
            text-decoration: none;
            border-radius: 8px;
            transition: background-color 0.3s ease, color 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
        }

        .sidebar.collapsed ul li a {
            justify-content: center; /* Center icons when collapsed */
            padding: 10px; /* Adjust padding for icon-only */
        }

        .sidebar ul li a span {
            transition: opacity 0.3s ease, width 0.3s ease;
            flex-grow: 1; /* Allow text to take space */
        }

        .sidebar.collapsed ul li a span {
            opacity: 0;
            width: 0;
            padding: 0;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: var(--light-blue-accent);
            color: var(--off-white);
        }
        .sidebar ul li a.active i {
            color: var(--off-white); /* Ensure icon color matches active text */
        }

        .sidebar ul li a i {
            font-size: 1.1em;
            color: var(--sidebar-text);
            transition: color 0.3s ease;
        }

        .logout-section {
            margin-top: auto; /* Pushes logout to the bottom */
            padding-top: 20px;
            border-top: 1px solid var(--medium-gray-border);
            text-align: center; /* Center the logout button */
        }

        .logout-section a {
            display: inline-flex; /* Use inline-flex for centering */
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            color: var(--error-color);
            text-decoration: none;
            border-radius: 8px;
            transition: background-color 0.3s ease, color 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
        }

        .sidebar.collapsed .logout-section a {
            justify-content: center; /* Center icon when collapsed */
            padding: 10px; /* Adjust padding for icon-only */
        }
        .sidebar.collapsed .logout-section a span {
            opacity: 0;
            width: 0;
            padding: 0;
        }

        .logout-section a:hover {
            background-color: var(--error-color);
            color: var(--off-white);
        }

        .main-content {
            margin-left: 280px; /* Initial offset for sidebar */
            flex-grow: 1;
            padding: 20px;
            transition: margin-left 0.3s ease;
        }

        .main-content.sidebar-collapsed {
            margin-left: 70px; /* Adjusted offset when sidebar is collapsed */
        }

        .header {
            background-color: var(--header-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--medium-gray-border);
        }

        .header h1 {
            margin: 0;
            color: var(--header-text);
        }

        .header .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header .user-info .notification-bell {
            position: relative;
            cursor: pointer;
            color: var(--dark-text);
            font-size: 1.5em;
        }

        .header .user-info .notification-bell .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--error-color);
            color: var(--off-white);
            border-radius: 50%;
            padding: 3px 7px;
            font-size: 0.7em;
            line-height: 1;
        }

        .header .user-info span {
            font-weight: 500;
            color: var(--header-text);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.03);
            border: 1px solid var(--card-border);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .card h3 {
            margin-top: 0;
            color: var(--dark-text);
            font-size: 1.2em;
            font-weight: 600;
        }

        .card p {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--dark-text);
            margin: 10px 0 0;
        }

        .card.summary-card {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .card.summary-card .icon-wrapper {
            background-color: var(--dark-text);
            color: var(--off-white);
            padding: 15px;
            border-radius: 50%;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            flex-shrink: 0;
        }

        .card.summary-card .text-content {
            flex-grow: 1;
        }

        .card.summary-card .text-content p {
            font-size: 1.5em;
        }

        .chart-container {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.03);
            border: 1px solid var(--card-border);
            margin-bottom: 20px;
        }

        .chart-container h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--dark-text);
            font-size: 1.2em;
            font-weight: 600;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .chart-placeholder {
            width: 100%;
            height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--light-gray-bg);
            border-radius: 8px;
            color: var(--dark-text);
        }

        /* Request Management Styles */
        .request-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--dark-text);
        }

        .request-tabs button {
            background-color: transparent;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            color: var(--dark-text);
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .request-tabs button:hover {
            color: var(--link-color);
        }

        .request-tabs button.active {
            color: var(--dark-text);
            border-bottom-color: var(--dark-text);
            font-weight: 600;
        }

        .request-category {
            margin-bottom: 30px;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.03);
            border: 1px solid var(--card-border);
        }

        .request-category h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--dark-text);
            font-size: 1.3em;
            font-weight: 600;
            border-bottom: 1px solid var(--medium-gray-border);
            padding-bottom: 10px;
        }

        .request-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .request-item {
            background-color: var(--light-gray-bg);
            border: 1px solid var(--medium-gray-border);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 150px;
        }

        .request-item p {
            margin: 5px 0;
            font-size: 0.95em;
        }

        .request-item .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: capitalize;
            margin-top: 10px;
        }

        .status-badge.pending { background-color: var(--badge-pending-bg); color: var(--badge-pending-text); }
        .status-badge.in_progress { background-color: var(--badge-in_progress-bg); color: var(--badge-in_progress-text); }
        .status-badge.completed { background-color: var(--badge-completed-bg); color: var(--badge-completed-text); }
        .status-badge.cancelled { background-color: var(--badge-cancelled-bg); color: var(--badge-cancelled-text); }
        .status-badge.casual_chat { background-color: var(--badge-casual_chat-bg); color: var(--badge-casual_chat-text); }
        .status-badge.general_inquiry { background-color: var(--badge-general_inquiry-bg); color: var(--badge-general_inquiry-text); }
        .status-badge.amenity_request { background-color: var(--badge-amenity_request-bg); color: var(--badge-amenity_request-text); }
        .status-badge.maintenance { background-color: var(--badge-maintenance-bg); color: var(--badge-maintenance-text); }
        .status-badge.housekeeping { background-color: var(--badge-housekeeping-bg); color: var(--badge-housekeeping-text); }
        .status-badge.room_service { background-color: var(--badge-room_service-bg); color: var(--badge-room_service-text); }
        .status-badge.concierge { background-color: var(--badge-concierge-bg); color: var(--badge-concierge-text); }


        .request-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .request-actions button {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .request-actions button.view-details {
            background-color: var(--dark-text);
            color: var(--off-white);
        }
        .request-actions button.view-details:hover {
            background-color: #4A5C6F;
        }

        .request-actions button.update-status {
            background-color: var(--light-blue-accent);
            color: var(--off-white);
        }
        .request-actions button.update-status:hover {
            background-color: #3A7BC8;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: var(--modal-bg);
            margin: auto;
            padding: 30px;
            border: 1px solid var(--modal-border);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--medium-gray-border);
            padding-bottom: 10px;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--dark-text);
        }

        .close-button {
            color: var(--dark-text);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--light-blue-accent);
            text-decoration: none;
            cursor: pointer;
        }

        .modal-body label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-text);
        }

        .modal-body input[type="text"],
        .modal-body input[type="email"],
        .modal-body input[type="number"],
        .modal-body input[type="date"],
        .modal-body input[type="time"],
        .modal-body textarea,
        .modal-body select {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 1em;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .modal-body input[type="text"]:focus,
        .modal-body input[type="email"]:focus,
        .modal-body input[type="number"]:focus,
        .modal-body input[type="date"]:focus,
        .modal-body input[type="time"]:focus,
        .modal-body textarea:focus,
        .modal-body select:focus {
            border-color: var(--input-focus-border);
            outline: none;
        }

        .modal-body textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-check {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .form-check-input {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            accent-color: var(--light-blue-accent);
        }

        .form-check-label {
            margin-bottom: 0;
            font-weight: 500;
            color: var(--dark-text);
            cursor: pointer;
        }

        .datetime-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .datetime-group .form-group {
            flex: 1;
            min-width: 120px;
            margin-bottom: 0;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            border-top: 1px solid var(--medium-gray-border);
            padding-top: 15px;
        }

        .modal-footer button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .modal-footer button.save-button {
            background-color: var(--button-primary-bg);
            color: var(--button-primary-text);
        }

        .modal-footer button.save-button:hover {
            background-color: #3A7BC8;
        }

        .modal-footer button.cancel-button {
            background-color: var(--button-secondary-bg);
            color: var(--button-secondary-text);
        }

        .modal-footer button.cancel-button:hover {
            background-color: #C0C8D0;
        }

        /* Message Box Styles */
        #messageBox {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 500;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        #messageBox.show {
            opacity: 1;
            display: block;
        }

        #messageBox.success {
            background-color: var(--success-color);
            color: var(--off-white);
        }

        #messageBox.error {
            background-color: var(--error-color);
            color: var(--off-white);
        }

        /* Request Details Modal Specific Styles */
        .request-details-modal .modal-body .detail-row {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px dashed var(--medium-gray-border);
            padding-bottom: 5px;
        }

        .request-details-modal .modal-body .detail-row strong {
            flex: 0 0 120px;
            color: var(--dark-text);
        }

        .request-details-modal .modal-body .detail-row span {
            flex-grow: 1;
            color: var(--dark-text);
        }

        .request-details-modal .chat-history-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--medium-gray-border);
        }

        .request-details-modal .chat-history-section h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--dark-text);
        }

        .request-details-modal .chat-messages {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--medium-gray-border);
            border-radius: 8px;
            padding: 10px;
            background-color: var(--light-gray-bg);
        }

        .request-details-modal .chat-message {
            margin-bottom: 8px;
            padding: 5px 8px;
            border-radius: 6px;
        }

        .request-details-modal .chat-message.user {
            background-color: var(--off-white);
            text-align: left;
        }

        .request-details-modal .chat-message.model {
            background-color: #E0F2F7;
            text-align: left;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container-wrapper {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: none;
                border-bottom: 2px solid var(--medium-gray-border);
                padding-bottom: 80px; /* More space for toggle and logout on mobile */
            }
            .sidebar.collapsed {
                width: 100%;
                padding-bottom: 80px;
            }
            .sidebar-header .toggle-btn {
                display: none; /* Hide toggle button on mobile if sidebar is always open, or reposition it */
            }
            .sidebar-toggle-button {
                position: absolute;
                bottom: 10px; /* Adjust position for mobile */
                right: 10px;
                left: auto;
                transform: none;
            }
            .main-content {
                margin-left: 0;
                padding-top: 20px;
            }
            .main-content.sidebar-collapsed {
                margin-left: 0;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .header .user-info {
                width: 100%;
                justify-content: flex-end;
            }
            .dashboard-grid, .chart-grid, .request-list {
                grid-template-columns: 1fr;
            }
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            .datetime-group {
                flex-direction: column;
                gap: 0;
            }
            .datetime-group .form-group {
                width: 100%;
                margin-bottom: 15px;
            }
        }

        /* Table styles (consolidated) */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .data-table thead {
            background-color: var(--table-header-bg);
            color: var(--table-header-text);
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--medium-gray-border);
        }

        .data-table tbody tr:hover {
            background-color: var(--table-row-hover-bg);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .table-responsive {
            overflow-x: auto;
            border-radius: 8px;
        }

        /* Form control styling for filter forms - Using CSS Grid for better layout */
        .filter-card form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 1em;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .form-control:focus {
            border-color: var(--input-focus-border);
            outline: none;
        }

        .form-group {
            margin-bottom: 0;
        }

        .button-primary {
            background-color: var(--button-primary-bg);
            color: var(--button-primary-text);
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .button-primary:hover {
            background-color: #3A7BC8;
        }

        .button-secondary {
            background-color: var(--button-secondary-bg);
            color: var(--button-secondary-text);
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .button-secondary:hover {
            background-color: #C0C8D0;
        }

        .error-message {
            color: var(--error-color);
            font-size: 0.85em;
            margin-top: -10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    {% csrf_token %} <!-- CSRF token for Django forms -->
    <div class="message-box" id="messageBox"></div>

    <div class="container-wrapper">
        <div class="sidebar" id="sidebar">
            <div>
                <div class="sidebar-header">
                    <h2>ConciAI</h2>
                </div>
                <nav>
                    <ul>
                        <li><a href="{% url 'main:home_dashboard' %}" class="{% if current_main_tab == 'home' %}active{% endif %}"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
                        <li><a href="{% url 'main:guest_requests_dashboard' %}" class="{% if current_main_tab == 'requests' %}active{% endif %}"><i class="fas fa-bell"></i> <span>Guest Requests</span></a></li>
                        <li><a href="{% url 'main:guest_management' %}" class="{% if current_main_tab == 'guest_management' %}active{% endif %}"><i class="fas fa-users"></i> <span>Guest Management</span></a></li>
                        <li><a href="{% url 'main:amenity_management' %}" class="{% if current_main_tab == 'amenities' %}active{% endif %}"><i class="fas fa-concierge-bell"></i> <span>Amenity Management</span></a></li>
                        <!-- Add more navigation items as needed -->
                    </ul>
                </nav>
            </div>
            <!-- Sidebar Toggle Button - Moved inside sidebar and adjusted position -->
            <button id="sidebarToggle" class="sidebar-toggle-button">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="logout-section">
                <a href="{% url 'logout' %}">
                    <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
                </a>
            </div>
        </div>

        <div class="main-content" id="mainContent">
            <header class="header">
                <h1>{{ page_title }}</h1>
                <div class="user-info">
                    <button id="notificationBell" class="notification-bell">
                        <i class="fas fa-bell"></i>
                        <span class="badge" id="notificationBadge">0</span>
                    </button>
                    <button id="themeToggleButton" class="notification-bell" style="font-size: 1.2em;">
                        <i class="fas fa-moon"></i>
                    </button>
                    <span>Welcome, {{ request.user.username }}</span>
                </div>
            </header>

            {% if current_main_tab == 'home' %}
                <div class="card">
                    <h2>Overview</h2>
                    <div class="dashboard-grid">
                        <div class="card summary-card">
                            <div class="icon-wrapper"><i class="fas fa-hotel"></i></div>
                            <div class="text-content">
                                <h3>Total Rooms</h3>
                                <p>{{ total_rooms }}</p>
                            </div>
                        </div>
                        <div class="card summary-card">
                            <div class="icon-wrapper"><i class="fas fa-door-open"></i></div>
                            <div class="text-content">
                                <h3>Occupied Rooms</h3>
                                <p>{{ occupied_rooms }}</p>
                            </div>
                        </div>
                        <div class="card summary-card">
                            <div class="icon-wrapper"><i class="fas fa-bookmark"></i></div>
                            <div class="text-content">
                                <h3>Reserved Rooms</h3>
                                <p>{{ reserved_rooms }}</p>
                            </div>
                        </div>
                        <div class="card summary-card">
                            <div class="icon-wrapper"><i class="fas fa-bed"></i></div>
                            <div class="text-content">
                                <h3>Available Rooms</h3>
                                <p>{{ available_rooms }}</p>
                            </div>
                        </div>
                        <div class="card summary-card">
                            <div class="icon-wrapper"><i class="fas fa-ban"></i></div>
                            <div class="text-content">
                                <h3>Rooms Not Ready</h3>
                                <p>{{ not_ready_rooms }}</p>
                            </div>
                        </div>
                        <div class="card summary-card">
                            <div class="icon-wrapper"><i class="fas fa-calendar-plus"></i></div>
                            <div class="text-content">
                                <h3>New Bookings Today</h3>
                                <p>{{ new_bookings_count }}</p>
                            </div>
                        </div>
                        <div class="card summary-card">
                            <div class="icon-wrapper"><i class="fas fa-sign-in-alt"></i></div>
                            <div class="text-content">
                                <h3>Check-ins Today</h3>
                                <p>{{ check_ins_today_count }}</p>
                            </div>
                        </div>
                        <div class="card summary-card">
                            <div class="icon-wrapper"><i class="fas fa-sign-out-alt"></i></div>
                            <div class="text-content">
                                <h3>Check-outs Today</h3>
                                <p>{{ check_outs_today_count }}</p>
                            </div>
                        </div>
                        <div class="card summary-card">
                            <div class="icon-wrapper"><i class="fas fa-concierge-bell"></i></div>
                            <div class="text-content">
                                <h3>Total Guest Requests</h3>
                                <p>{{ total_requests_count }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>Reservations (Last 7 Days)</h3>
                        <svg id="reservationsChart"></svg>
                    </div>
                    <div class="chart-container">
                        <h3>Bookings by Platform</h3>
                        <svg id="bookingPlatformChart"></svg>
                    </div>
                </div>

            {% elif current_main_tab == 'requests' %}
                <div class="card">
                    <h2>Guest Requests</h2>
                    <div class="request-tabs">
                        <a href="{% url 'main:active_requests' %}" class="{% if current_sub_tab == 'active' %}active{% endif %}">Active Requests</a>
                        <a href="{% url 'main:archive_requests' %}" class="{% if current_sub_tab == 'archive' %}active{% endif %}">Archived Requests</a>
                        <a href="{% url 'main:all_requests' %}" class="{% if current_sub_tab == 'all' %}active{% endif %}">All Requests</a>
                    </div>

                    {% for group in grouped_requests %}
                        {% if group.requests %}
                            <div class="request-category">
                                <h3>{{ group.display_name }}</h3>
                                <div class="request-list">
                                    {% for item in group.requests %}
                                        <div class="request-item">
                                            <div>
                                                <p><strong>Request ID:</strong> {{ item.request.id }}</p>
                                                <p><strong>Room:</strong> {{ item.request.room_number }}</p>
                                                <p><strong>Guest:</strong> {{ item.assignment.guest_names|default:"N/A" }}</p>
                                                <p><strong>Description:</strong> {{ item.request.raw_text|truncatechars:70 }}</p>
                                                <p><strong>Assigned Staff:</strong> {{ item.assigned_staff_name|default:"Unassigned" }}</p>
                                                <p><strong>Received At:</strong> {{ item.request.timestamp|date:"M d, Y H:i" }}</p>
                                                <span class="status-badge {{ item.request.status }}">{{ item.request.get_status_display }}</span>
                                            </div>
                                            <div class="request-actions">
                                                <button class="view-details button-primary" data-request-id="{{ item.request.id }}">View Details</button>
                                                <button class="update-status button-primary assign-request-button" data-request-id="{{ item.request.id }}" {% if item.request.assigned_staff %}disabled{% endif %}>
                                                    {% if item.request.assigned_staff %}Assigned{% else %}Assign{% endif %}
                                                </button>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    {% empty %}
                        <p class="text-center">No requests found for this category.</p>
                    {% endfor %}
                </div>

            {% elif current_main_tab == 'guest_management' %}
                <div class="card">
                    <h2>Guest Room Assignments</h2>
                    <div class="btn-group">
                        <button class="button-primary" id="addAssignmentButton">
                            <i class="fas fa-plus"></i> Add New Assignment
                        </button>
                    </div>

                    <!-- Filter Form -->
                    <div class="card filter-card" style="margin-bottom: 20px;">
                        <h3>Filter Assignments</h3>
                        <form method="GET">
                            <div class="form-group">
                                <label for="room_number_filter">Room Number:</label>
                                <input type="text" id="room_number_filter" name="room_number" class="form-control" value="{{ filter_params.room_number|default:'' }}">
                            </div>
                            <div class="form-group">
                                <label for="guest_names_filter">Guest Names:</label>
                                <input type="text" id="guest_names_filter" name="guest_names" class="form-control" value="{{ filter_params.guest_names|default:'' }}">
                            </div>
                            <div class="form-group">
                                <label for="status_filter">Status:</label>
                                <select id="status_filter" name="status" class="form-control">
                                    <option value="">All</option>
                                    {% for value, label in assignment_status_choices %}
                                        <option value="{{ value }}" {% if filter_params.status == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="check_in_date_from_filter">Check-in From:</label>
                                <input type="date" id="check_in_date_from_filter" name="check_in_date_from" class="form-control" value="{{ filter_params.check_in_date_from|default:'' }}">
                            </div>
                            <div class="form-group">
                                <label for="check_in_date_to_filter">Check-in To:</label>
                                <input type="date" id="check_in_date_to_filter" name="check_in_date_to" class="form-control" value="{{ filter_params.check_in_date_to|default:'' }}">
                            </div>
                            <div class="form-group">
                                <label for="check_out_date_from_filter">Check-out From:</label>
                                <input type="date" id="check_out_date_from_filter" name="check_out_date_from" class="form-control" value="{{ filter_params.check_out_date_from|default:'' }}">
                            </div>
                            <div class="form-group">
                                <label for="check_out_date_to_filter">Check-out To:</label>
                                <input type="date" id="check_out_date_to_filter" name="check_out_date_to" class="form-control" value="{{ filter_params.check_out_date_to|default:'' }}">
                            </div>
                            <div style="grid-column: span 2; display: flex; gap: 10px; justify-content: flex-end; align-items: flex-end;">
                                <button type="submit" class="button-primary">Apply Filters</button>
                                <a href="{% url 'main:guest_management' %}" class="button-secondary">Clear Filters</a>
                            </div>
                        </form>
                    </div>

                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Room No.</th>
                                    <th>Guest Names</th>
                                    <th>Check-in</th>
                                    <th>Check-out</th>
                                    <th>Status</th>
                                    <th>Total Bill</th>
                                    <th>Amount Paid</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for assignment in all_assignments %}
                                    <tr>
                                        <td>{{ assignment.id }}</td>
                                        <td>{{ assignment.room_number }}</td>
                                        <td>{{ assignment.guest_names }}</td>
                                        <td>{{ assignment.check_in_time|date:"M d, Y H:i" }}</td>
                                        <td>{{ assignment.check_out_time|date:"M d, Y H:i" }}</td>
                                        <td><span class="status-badge {{ assignment.status }}">{{ assignment.get_status_display }}</span></td>
                                        <td>${{ assignment.total_bill_amount|floatformat:2 }}</td>
                                        <td>${{ assignment.amount_paid|floatformat:2 }}</td>
                                        <td>
                                            <button class="button-primary button-sm edit-assignment-button" data-assignment-id="{{ assignment.id }}">Edit</button>
                                            <button class="button-secondary button-sm delete-assignment-button" data-assignment-id="{{ assignment.id }}">Delete</button>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr><td colspan="9" class="text-center">No guest assignments found.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

            {% elif current_main_tab == 'amenities' %}
                <div class="card">
                    <h2>Amenity Management</h2>
                    <div class="btn-group">
                        <button class="button-primary" id="addAmenityButton">
                            <i class="fas fa-plus"></i> Add New Amenity
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Price</th>
                                    <th>Available</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for amenity in amenities %}
                                    <tr>
                                        <td>{{ amenity.name }}</td>
                                        <td>{{ amenity.description|default:"N/A" }}</td>
                                        <td>${{ amenity.price|floatformat:2 }}</td>
                                        <td>
                                            {% if amenity.is_available %}
                                                <span class="status-badge completed">Yes</span>
                                            {% else %}
                                                <span class="status-badge cancelled">No</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="button-primary button-sm edit-amenity-button" data-amenity-id="{{ amenity.id }}">Edit</button>
                                            <button class="button-secondary button-sm delete-amenity-button" data-amenity-id="{{ amenity.id }}">Delete</button>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr><td colspan="5" class="text-center">No amenities found.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Assign Staff Modal -->
    <div id="assignStaffModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div class="modal-header">
                <h2>Assign Request to Staff</h2>
            </div>
            <form id="assignStaffForm">
                {% csrf_token %}
                <input type="hidden" id="assignRequestId" name="request_id">
                <!-- Hidden fields to carry existing data for backend validation -->
                <input type="hidden" id="assignRoomNumber" name="room_number">
                <input type="hidden" id="assignRawText" name="raw_text">
                <input type="hidden" id="assignRequestType" name="request_type">
                <input type="hidden" id="assignStatus" name="status">
                <input type="hidden" id="assignStaffNotes" name="staff_notes">
                <input type="hidden" id="assignBillAdded" name="bill_added">
                <input type="hidden" id="assignAmenityQuantity" name="amenity_quantity">

                <div class="modal-body">
                    <label for="assignStaffSelect">Assign to:</label>
                    <select id="assignStaffSelect" name="assigned_staff" class="form-control" required>
                        <option value="">Select Staff Member</option>
                        {% for staff in staff_members %}
                            <option value="{{ staff.id }}">{{ staff.user.username }} ({{ staff.get_category_display }})</option>
                        {% endfor %}
                    </select>
                    <span id="assigned_staffErrorsAssign" class="error-message"></span>
                </div>
                <div class="modal-footer">
                    <button type="button" class="cancel-button">Cancel</button>
                    <button type="submit" class="save-button">Assign Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Request Details Modal -->
    <div id="requestDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeRequestDetailsModalButton">&times;</span>
            <div class="modal-header">
                <h2>Request Details <small>(ID: <span id="modalRequestIdDisplay"></span>)</small></h2>
            </div>
            <form id="requestUpdateForm">
                {% csrf_token %}
                <input type="hidden" id="modalRequestId" name="request_id">
                <!-- Hidden fields to carry existing data for backend validation -->
                <input type="hidden" id="modalRoomNumberHidden" name="room_number">
                <input type="hidden" id="modalRawTextHidden" name="raw_text">
                <input type="hidden" id="modalAmenityQuantityHidden" name="amenity_quantity">

                <div class="modal-body">
                    <div class="detail-row">
                        <strong>Room Number:</strong> <span id="detailRoomNumber"></span>
                    </div>
                    <div class="detail-row">
                        <strong>Guest Names:</strong> <span id="detailGuestNames"></span>
                    </div>
                    <div class="detail-row">
                        <strong>Received At:</strong> <span id="detailTimestamp"></span>
                    </div>
                    <div class="detail-row">
                        <strong>Raw Request Text:</strong> <span id="detailRawText"></span>
                    </div>
                    <div class="detail-row">
                        <strong>ConciAI Response:</strong> <span id="detailConciResponse"></span>
                    </div>
                    <div class="detail-row">
                        <strong>AI Intent:</strong> <span id="detailAiIntent"></span>
                    </div>
                    <div class="detail-row">
                        <strong>AI Entities:</strong> <pre id="detailAiEntities" style="white-space: pre-wrap; word-break: break-all;"></pre>
                    </div>
                    
                    <!-- Amenity Details Section (Conditional Display) -->
                    <div id="amenityDetailsSection" style="display: none; border-top: 1px solid var(--medium-gray-border); padding-top: 15px; margin-top: 15px;">
                        <h4>Amenity Details</h4>
                        <div class="detail-row">
                            <strong>Amenity Name:</strong> <span id="detailAmenityName"></span>
                        </div>
                        <div class="detail-row">
                            <strong>Quantity:</strong> <span id="detailAmenityQuantity"></span>
                        </div>
                        <div class="detail-row">
                            <strong>Price Per Unit:</strong> <span id="detailPricePerUnit"></span>
                        </div>
                        <div class="detail-row">
                            <strong>Total Amenity Cost:</strong> <span id="detailTotalAmenityCost"></span>
                        </div>
                        <div class="detail-row">
                            <strong>Bill Added:</strong> <span id="detailBillAdded"></span>
                        </div>
                    </div>

                    <label for="id_request_type">Request Type:</label>
                    <select id="id_request_type" name="request_type" class="form-control">
                        {% for value, label in guest_request_type_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                    <span id="request_typeErrors" class="error-message"></span>

                    <label for="id_status">Status:</label>
                    <select id="id_status" name="status" class="form-control" disabled> <!-- Status is now disabled for admin -->
                        {% for value, label in guest_request_status_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                    <span id="statusErrors" class="error-message"></span>

                    <label for="id_assigned_staff">Assigned Staff:</label>
                    <select id="id_assigned_staff" name="assigned_staff" class="form-control">
                        <option value="">Unassigned</option>
                        {% for staff in staff_members %}
                            <option value="{{ staff.id }}">{{ staff.user.username }} ({{ staff.get_category_display }})</option>
                        {% endfor %}
                    </select>
                    <span id="assigned_staffErrors" class="error-message"></span>

                    <label for="id_staff_notes">Staff Notes:</label>
                    <textarea id="id_staff_notes" name="staff_notes" class="form-control" rows="3"></textarea>
                    <span id="staff_notesErrors" class="error-message"></span>

                    <div class="form-check">
                        <input type="checkbox" id="modalAmenityBillAdded" name="bill_added" class="form-check-input">
                        <label for="modalAmenityBillAdded" class="form-check-label">Bill Added</label>
                    </div>

                    <div class="chat-history-section">
                        <h4>Chat History</h4>
                        <div class="chat-messages" id="detailChatHistory">
                            <!-- Chat history will be loaded here by JavaScript -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="cancel-button" id="closeRequestDetailsModalButtonFooter">Close</button>
                    <button type="submit" class="save-button" id="saveRequestChangesButton">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Amenity Add/Edit Modal -->
    <div id="amenityModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div class="modal-header">
                <h2 id="amenityModalTitle">Add New Amenity</h2>
            </div>
            <form id="amenityForm">
                {% csrf_token %}
                <input type="hidden" id="amenityId" name="amenity_id">
                <div class="modal-body">
                    <label for="amenityName">Name:</label>
                    <input type="text" id="amenityName" name="name" class="form-control" required>
                    <span id="amenityNameErrors" class="error-message"></span>

                    <label for="amenityDescription">Description:</label>
                    <textarea id="amenityDescription" name="description" class="form-control" rows="3"></textarea>
                    <span id="amenityDescriptionErrors" class="error-message"></span>

                    <label for="amenityPrice">Price:</label>
                    <input type="number" id="amenityPrice" name="price" class="form-control" step="0.01" required>
                    <span id="amenityPriceErrors" class="error-message"></span>

                    <div class="form-check">
                        <input type="checkbox" id="amenityIsAvailable" name="is_available" class="form-check-input">
                        <label for="amenityIsAvailable" class="form-check-label">Available</label>
                        <span id="amenityIsAvailableErrors" class="error-message"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="cancel-button" id="cancelAmenityButton">Cancel</button>
                    <button type="submit" class="save-button">Save Amenity</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Guest Assignment Modal -->
    <div id="assignmentModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div class="modal-header">
                <h2 id="assignmentModalTitle">Add New Guest Assignment</h2>
            </div>
            <form id="assignmentForm">
                {% csrf_token %}
                <input type="hidden" id="assignmentId" name="assignment_id">
                <div class="modal-body">
                    <label for="room_number_input">Room Number:</label>
                    <input type="text" id="room_number_input" name="room_number_input" class="form-control" required>
                    <span id="room_number_inputErrors" class="error-message"></span>

                    <label for="guest_names">Guest Names:</label>
                    <input type="text" id="guest_names" name="guest_names" class="form-control" required>
                    <span id="guest_namesErrors" class="error-message"></span>

                    <div class="datetime-group">
                        <div class="form-group">
                            <label for="check_in_date">Check-in Date:</label>
                            <input type="date" id="check_in_date" name="check_in_date" class="form-control" required>
                            <span id="check_in_dateErrors" class="error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="check_in_time_input">Check-in Time:</label>
                            <input type="time" id="check_in_time_input" name="check_in_time_input" class="form-control" required>
                            <span id="check_in_time_inputErrors" class="error-message"></span>
                        </div>
                    </div>

                    <div class="datetime-group">
                        <div class="form-group">
                            <label for="check_out_date">Check-out Date:</label>
                            <input type="date" id="check_out_date" name="check_out_date" class="form-control" required>
                            <span id="check_out_dateErrors" class="error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="check_out_time_input">Check-out Time:</label>
                            <input type="time" id="check_out_time_input" name="check_out_time_input" class="form-control" required>
                            <span id="check_out_time_inputErrors" class="error-message"></span>
                        </div>
                    </div>

                    <label for="status">Status:</label>
                    <select id="status" name="status" class="form-control" required>
                        {% for value, label in assignment_status_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                    <span id="statusErrors" class="error-message"></span>

                    <label for="total_bill_amount">Total Bill Amount:</label>
                    <input type="number" id="total_bill_amount" name="total_bill_amount" class="form-control" step="0.01" value="0.00">
                    <span id="total_bill_amountErrors" class="error-message"></span>

                    <label for="amount_paid">Amount Paid:</label>
                    <input type="number" id="amount_paid" name="amount_paid" class="form-control" step="0.01" value="0.00">
                    <span id="amount_paidErrors" class="error-message"></span>
                </div>
                <div class="modal-footer">
                    <button type="button" class="cancel-button">Cancel</button>
                    <button type="submit" class="save-button">Save Assignment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal (for delete actions) -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div class="modal-header">
                <h2>Confirm Action</h2>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="cancel-button">Cancel</button>
                <button type="button" class="save-button" id="confirmationYesButton">Confirm</button>
            </div>
        </div>
    </div>

    <script defer>
        console.log("Script loading...");

        function showMessage(message, type) {
            const messageBox = document.getElementById('messageBox');
            if (messageBox) {
                messageBox.textContent = message;
                messageBox.className = '';
                messageBox.classList.add('show', type);
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, 3000);
            }
        }

        const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        const csrfToken = csrfTokenElement ? csrfTokenElement.value : '';
        console.log("CSRF Token:", csrfToken ? "Found" : "Not Found");

        const themeToggleButton = document.getElementById('themeToggleButton');
        const htmlElement = document.documentElement;

        function setInitialTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            htmlElement.setAttribute('data-theme', savedTheme);
            updateThemeToggleButton(savedTheme);
            console.log("Initial theme set to:", savedTheme);
        }

        function updateThemeToggleButton(theme) {
            const icon = themeToggleButton ? themeToggleButton.querySelector('i') : null;
            if (icon) {
                if (theme === 'dark') {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                }
            } else {
                console.warn("Theme toggle button or its icon not found.");
            }
        }

        if (themeToggleButton) {
            themeToggleButton.addEventListener('click', () => {
                let currentTheme = htmlElement.getAttribute('data-theme');
                let newTheme = currentTheme === 'light' ? 'dark' : 'light';
                htmlElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeToggleButton(newTheme);
                console.log("Theme toggled to:", newTheme);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded fired. Initializing dashboard elements...");
            setInitialTheme();

            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarToggleIcon = sidebarToggle ? sidebarToggle.querySelector('i') : null;

            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', () => {
                    if (sidebar) sidebar.classList.toggle('collapsed');
                    if (mainContent) mainContent.classList.toggle('sidebar-collapsed');
                    if (sidebar && sidebarToggleIcon) {
                        if (sidebar.classList.contains('collapsed')) {
                            sidebarToggleIcon.classList.remove('fa-chevron-left');
                            sidebarToggleIcon.classList.add('fa-chevron-right');
                        } else {
                            sidebarToggleIcon.classList.remove('fa-chevron-right');
                            sidebarToggleIcon.classList.add('fa-chevron-left');
                        }
                    }
                    console.log("Sidebar toggled.");
                });
            }

            const notificationBell = document.getElementById('notificationBell');
            const notificationBadge = document.getElementById('notificationBadge');
            let lastCheckTimestamp = new Date().toISOString();

            async function fetchNewRequests() {
                try {
                    const response = await fetch(`/api/check_new_requests/?last_check=${encodeURIComponent(lastCheckTimestamp)}`);
                    const data = await response.json();

                    if (data.success) {
                        if (notificationBadge) {
                            notificationBadge.textContent = data.new_requests_count;
                            if (data.new_requests_count > 0) {
                                notificationBadge.style.display = 'block';
                            } else {
                                notificationBadge.style.display = 'none';
                            }
                        }
                        lastCheckTimestamp = data.current_timestamp;
                        console.log("New requests fetched:", data.new_requests_count);
                    } else {
                        console.error('Failed to fetch new requests:', data.error);
                    }
                } catch (error) {
                    console.error('Network error fetching new requests:', error);
                }
            }

            setInterval(fetchNewRequests, 30000);
            fetchNewRequests();

            {% if current_main_tab == 'home' %}
                const reservationsData = {{ reservations_chart_data|safe }};
                const bookingPlatformData = {{ booking_platform_data|safe }};

                function drawReservationsChart() {
                    const svgElement = document.getElementById('reservationsChart');
                    if (!svgElement) { console.warn("reservationsChart SVG not found."); return; }

                    const svg = d3.select(svgElement);
                    const margin = {top: 20, right: 30, bottom: 40, left: 40};
                    const width = parseFloat(svg.style("width")) - margin.left - margin.right;
                    const height = parseFloat(svg.style("height")) - margin.top - margin.bottom;

                    svg.selectAll("*").remove(); 

                    const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                    const x = d3.scaleBand()
                        .domain(reservationsData.map(d => d.date))
                        .range([0, width])
                        .padding(0.2);

                    const y = d3.scaleLinear()
                        .domain([0, d3.max(reservationsData, d => Math.max(d.booked, d.cancelled)) + 5])
                        .range([height, 0]);

                    g.append("g")
                        .attr("transform", `translate(0,${height})`)
                        .call(d3.axisBottom(x).tickSizeOuter(0))
                        .selectAll("text")
                        .style("fill", "var(--sidebar-text)"); /* Use sidebar-text for axis */

                    g.append("g")
                        .call(d3.axisLeft(y).tickSizeOuter(0))
                        .selectAll("text")
                        .style("fill", "var(--sidebar-text)"); /* Use sidebar-text for axis */

                    g.append("g")
                        .attr("class", "grid")
                        .attr("transform", `translate(0,${height})`)
                        .call(d3.axisBottom(x)
                            .tickSize(-height)
                            .tickFormat("")
                        )
                        .select(".domain").remove();

                    g.append("g")
                        .attr("class", "grid")
                        .call(d3.axisLeft(y)
                            .tickSize(-width)
                            .tickFormat("")
                        )
                        .select(".domain").remove();

                    g.selectAll(".bar-booked")
                        .data(reservationsData)
                        .enter().append("rect")
                        .attr("class", "bar-booked")
                        .attr("x", d => x(d.date))
                        .attr("y", d => y(d.booked))
                        .attr("width", x.bandwidth() / 2)
                        .attr("height", d => height - y(d.booked))
                        .attr("fill", "var(--chart-color-booked)");

                    g.selectAll(".bar-cancelled")
                        .data(reservationsData)
                        .enter().append("rect")
                        .attr("class", "bar-cancelled")
                        .attr("x", d => x(d.date) + x.bandwidth() / 2)
                        .attr("y", d => y(d.cancelled))
                        .attr("width", x.bandwidth() / 2)
                        .attr("height", d => height - y(d.cancelled))
                        .attr("fill", "var(--chart-color-cancelled)");
                }

                function drawBookingPlatformChart() {
                    const svgElement = document.getElementById('bookingPlatformChart');
                    if (!svgElement) { console.warn("bookingPlatformChart SVG not found."); return; }

                    const svg = d3.select(svgElement);
                    const width = parseFloat(svg.style("width"));
                    const height = parseFloat(svg.style("height"));
                    const radius = Math.min(width, height) / 2 - 20;

                    svg.selectAll("*").remove(); 

                    const g = svg.append("g")
                        .attr("transform", `translate(${width / 2},${height / 2})`);

                    const color = d3.scaleOrdinal()
                        .range([
                            "var(--chart-color-platform1)", "var(--chart-color-platform2)",
                            "var(--chart-color-platform3)", "var(--chart-color-platform4)",
                            "var(--chart-color-platform5)", "var(--chart-color-platform6)"
                        ]);

                    const pie = d3.pie()
                        .value(d => d.value);

                    const path = d3.arc()
                        .outerRadius(radius - 10)
                        .innerRadius(0);

                    const label = d3.arc()
                        .outerRadius(radius)
                        .innerRadius(radius - 80);

                    const arc = g.selectAll(".arc")
                        .data(pie(bookingPlatformData))
                        .enter().append("g")
                        .attr("class", "arc");

                    arc.append("path")
                        .attr("d", path)
                        .attr("fill", d => color(d.data.platform));

                    arc.append("text")
                        .attr("transform", d => `translate(${label.centroid(d)})`)
                        .attr("text-anchor", "middle")
                        .text(d => `${d.data.platform} (${d.data.value}%)`)
                        .style("fill", "var(--dark-text)")
                        .style("font-size", "0.8em");
                }

                drawReservationsChart();
                drawBookingPlatformChart();
                console.log("Charts drawn.");

                window.addEventListener('resize', () => {
                    drawReservationsChart();
                    drawBookingPlatformChart();
                });
            {% endif %}

            const requestDetailsModal = document.getElementById('requestDetailsModal');
            const amenityModal = document.getElementById('amenityModal');
            const confirmationModal = document.getElementById('confirmationModal');
            const assignmentModal = document.getElementById('assignmentModal'); 
            const assignStaffModal = document.getElementById('assignStaffModal'); 

            function closeAllModals() {
                if (requestDetailsModal) requestDetailsModal.classList.remove('show');
                if (amenityModal) amenityModal.classList.remove('show');
                if (confirmationModal) confirmationModal.classList.remove('show');
                if (assignmentModal) assignmentModal.classList.remove('show');
                if (assignStaffModal) assignStaffModal.classList.remove('show'); 

                document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
                console.log("All modals closed and errors cleared.");
            }

            document.querySelectorAll('.close-button').forEach(button => {
                button.addEventListener('click', closeAllModals);
            });
            document.querySelectorAll('.cancel-button').forEach(button => {
                button.addEventListener('click', closeAllModals);
            });

            window.addEventListener('click', (event) => {
                if (event.target === requestDetailsModal || event.target === amenityModal || 
                    event.target === confirmationModal || event.target === assignmentModal || 
                    event.target === assignStaffModal) {
                    closeAllModals();
                }
            });


            const viewDetailsButtons = document.querySelectorAll('.view-details'); 
            
            const requestUpdateForm = document.getElementById('requestUpdateForm');
            const modalRequestId = document.getElementById('modalRequestId');
            const idStaffNotes = document.getElementById('id_staff_notes'); 
            const idAssignedStaff = document.getElementById('id_assigned_staff'); 
            const idStatus = document.getElementById('id_status'); 
            const idRequestType = document.getElementById('id_request_type'); 
            const saveRequestChangesButton = document.getElementById('saveRequestChangesButton'); 

            const modalRoomNumberHidden = document.getElementById('modalRoomNumberHidden');
            const modalRawTextHidden = document.getElementById('modalRawTextHidden');
            const modalAmenityQuantityHidden = document.getElementById('modalAmenityQuantityHidden');


            viewDetailsButtons.forEach(button => {
                button.addEventListener('click', async () => {
                    console.log("View Details button clicked."); 
                    const requestId = button.dataset.requestId;
                    try {
                        const response = await fetch(`/api/requests/${requestId}/details/`);
                        const result = await response.json();

                        if (result.success) {
                            if (document.getElementById('modalRequestIdDisplay')) document.getElementById('modalRequestIdDisplay').textContent = requestId; 
                            if (document.getElementById('detailRoomNumber')) document.getElementById('detailRoomNumber').textContent = result.room_number;
                            if (document.getElementById('detailGuestNames')) document.getElementById('detailGuestNames').textContent = result.guest_names;
                            if (document.getElementById('detailTimestamp')) document.getElementById('detailTimestamp').textContent = new Date(result.timestamp).toLocaleString();
                            if (document.getElementById('detailRawText')) document.getElementById('detailRawText').textContent = result.raw_text;
                            if (document.getElementById('detailConciResponse')) document.getElementById('detailConciResponse').textContent = result.conci_response_text;
                            if (document.getElementById('detailAiIntent')) document.getElementById('detailAiIntent').textContent = result.ai_intent;
                            
                            const detailAiEntities = document.getElementById('detailAiEntities');
                            if (detailAiEntities) {
                                if (result.ai_entities && typeof result.ai_entities === 'object') {
                                    detailAiEntities.textContent = JSON.stringify(result.ai_entities, null, 2);
                                } else {
                                    detailAiEntities.textContent = result.ai_entities || 'N/A';
                                }
                            }
                            
                            if (modalRequestId) modalRequestId.value = requestId; 
                            if (idStaffNotes) idStaffNotes.value = result.staff_notes || ''; 
                            if (idStatus) idStatus.value = result.raw_status_value; 
                            if (idRequestType) idRequestType.value = result.raw_request_type_value; 

                            if (idAssignedStaff) { 
                                idAssignedStaff.value = result.raw_assigned_staff_id || ''; 
                            }

                            if (modalRoomNumberHidden) modalRoomNumberHidden.value = result.room_number || '';
                            if (modalRawTextHidden) modalRawTextHidden.value = result.raw_text || '';
                            if (modalAmenityQuantityHidden) modalAmenityQuantityHidden.value = result.amenity_quantity || 0;


                            const amenityDetailsSection = document.getElementById('amenityDetailsSection');
                            if (amenityDetailsSection) { 
                                if (result.amenity_details) {
                                    amenityDetailsSection.style.display = 'block';
                                    if (document.getElementById('detailAmenityName')) document.getElementById('detailAmenityName').textContent = result.amenity_details.name;
                                    if (document.getElementById('detailAmenityQuantity')) document.getElementById('detailAmenityQuantity').textContent = result.amenity_details.quantity;
                                    if (document.getElementById('detailPricePerUnit')) document.getElementById('detailPricePerUnit').textContent = `$${result.amenity_details.price_per_unit.toFixed(2)}`;
                                    if (document.getElementById('detailTotalAmenityCost')) document.getElementById('detailTotalAmenityCost').textContent = `$${result.amenity_details.total_amenity_cost.toFixed(2)}`;
                                    if (document.getElementById('detailBillAdded')) document.getElementById('detailBillAdded').textContent = result.amenity_details.bill_added ? 'Yes' : 'No';
                                } else {
                                    amenityDetailsSection.style.display = 'none';
                                }
                            }

                            const detailChatHistory = document.getElementById('detailChatHistory');
                            if (detailChatHistory) { 
                                detailChatHistory.innerHTML = ''; 
                                if (result.chat_history && Array.isArray(result.chat_history) && result.chat_history.length > 0) {
                                    result.chat_history.forEach(message => {
                                        const msgDiv = document.createElement('div');
                                        msgDiv.classList.add('chat-message', message.role);
                                        const messageText = (message.parts && message.parts.length > 0 && message.parts[0].text) ? message.parts[0].text : 'No text content.';
                                        msgDiv.innerHTML = `<strong>${message.role === 'user' ? 'Guest' : 'Conci'}:</strong> ${messageText}`;
                                        detailChatHistory.appendChild(msgDiv);
                                    });
                                } else {
                                    detailChatHistory.innerHTML = '<p>No detailed conversation history available.</p>';
                                }
                            }

                            const loggedInStaffMemberId = "{{ logged_in_staff_member.id|default:'' }}";
                            const loggedInStaffCategory = "{{ logged_in_staff_member.category|default:'' }}";

                            if (saveRequestChangesButton) {
                                let canEdit = false;
                                if (loggedInStaffCategory === 'general' || loggedInStaffCategory === 'concierge') {
                                    canEdit = true;
                                } else {
                                    if (result.assigned_staff && result.assigned_staff.id == loggedInStaffMemberId) {
                                        canEdit = true;
                                    }
                                    if (!result.assigned_staff && result.raw_request_type_value === loggedInStaffCategory) {
                                        canEdit = true;
                                    }
                                }
                                saveRequestChangesButton.disabled = !canEdit;
                                console.log("Save Changes button disabled status:", !canEdit); 
                            }

                            if (requestDetailsModal) requestDetailsModal.classList.add('show'); 
                            console.log("Request Details modal shown."); 
                        } else {
                            console.error('Backend reported error for Request Details:', result.error);
                            showMessage(result.error || 'Failed to load request details.', 'error');
                        }
                    }
                    catch (error) {
                        console.error('Error fetching request details:', error);
                        showMessage('Network error or server issue fetching request details.', 'error');
                    }
                });
            });

            if (requestUpdateForm) {
                console.log("Attaching listener to requestUpdateForm submit."); 
                requestUpdateForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log("Request Update Form submitted."); 
                    document.querySelectorAll('#requestUpdateForm .error-message').forEach(el => el.textContent = '');

                    const requestId = modalRequestId ? modalRequestId.value : '';
                    const url = `/api/requests/${requestId}/update/`; 

                    const formData = new FormData();
                    formData.append('request_id', requestId);
                    
                    formData.append('room_number', modalRoomNumberHidden ? modalRoomNumberHidden.value : '');
                    formData.append('raw_text', modalRawTextHidden ? modalRawTextHidden.value : '');
                    formData.append('amenity_quantity', modalAmenityQuantityHidden ? modalAmenityQuantityHidden.value : 0); 

                    formData.append('staff_notes', idStaffNotes ? idStaffNotes.value : '');
                    formData.append('assigned_staff', idAssignedStaff ? idAssignedStaff.value : '');
                    formData.append('status', idStatus ? idStatus.value : ''); 
                    formData.append('request_type', idRequestType ? idRequestType.value : '');

                    const modalAmenityBillAddedCheckbox = document.getElementById('modalAmenityBillAdded');
                    formData.append('bill_added', modalAmenityBillAddedCheckbox ? (modalAmenityBillAddedCheckbox.checked ? 'True' : 'False') : 'False');


                    try {
                        const response = await fetch(url, {
                            method: 'POST', 
                            headers: {
                                'X-CSRFToken': csrfToken, 
                            },
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success) {
                            showMessage(result.message, 'success');
                            if (requestDetailsModal) requestDetailsModal.classList.remove('show');
                            location.reload(); 
                        } else {
                            let generalErrorMessage = result.error || 'Failed to update request due to validation errors.';
                            showMessage(generalErrorMessage, 'error');

                            if (result.errors) {
                                const errors = JSON.parse(result.errors);
                                for (const field in errors) {
                                    const errorDiv = document.getElementById(`${field}Errors`);
                                    if (errorDiv) {
                                        errorDiv.textContent = errors[field][0].message;
                                    } else {
                                        console.error(`Unhandled form error for field ${field}:`, errors[field][0].message);
                                        showMessage(`Error: ${errors[field][0].message}`, 'error');
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error submitting request update form:', error);
                        showMessage('Network error or server issue updating request.', 'error');
                    }
                });
            }

            const assignRequestIdInput = document.getElementById('assignRequestId');
            const assignStaffSelect = document.getElementById('assignStaffSelect');
            const cancelAssignButton = document.getElementById('cancelAssignButton');
            const assignStaffForm = document.getElementById('assignStaffForm');

            const assignRoomNumber = document.getElementById('assignRoomNumber');
            const assignRawText = document.getElementById('assignRawText');
            const assignRequestType = document.getElementById('assignRequestType');
            const assignStatus = document.getElementById('assignStatus');
            const assignStaffNotes = document.getElementById('assignStaffNotes');
            const assignBillAdded = document.getElementById('assignBillAdded');
            const assignAmenityQuantity = document.getElementById('assignAmenityQuantity');


            document.querySelectorAll('.assign-request-button').forEach(button => {
                button.addEventListener('click', async () => { 
                    console.log("Assign Request button clicked."); 
                    const requestId = button.dataset.requestId;

                    try {
                        const currentRequestResponse = await fetch(`/api/requests/${requestId}/details/`);
                        const currentRequestData = await currentRequestResponse.json();

                        if (currentRequestData.success) {
                            if (assignRequestIdInput) assignRequestIdInput.value = requestId;
                            if (assignStaffSelect) assignStaffSelect.value = currentRequestData.raw_assigned_staff_id || ''; 

                            if (assignRoomNumber) assignRoomNumber.value = currentRequestData.room_number || '';
                            if (assignRawText) assignRawText.value = currentRequestData.raw_text || '';
                            if (assignRequestType) assignRequestType.value = currentRequestData.raw_request_type_value || '';
                            if (assignStatus) assignStatus.value = currentRequestData.raw_status_value || '';
                            if (assignStaffNotes) assignStaffNotes.value = currentRequestData.staff_notes || '';
                            if (assignBillAdded) assignBillAdded.value = currentRequestData.amenity_details ? (currentRequestData.amenity_details.bill_added ? 'True' : 'False') : 'False';
                            if (assignAmenityQuantity) assignAmenityQuantity.value = currentRequestData.amenity_quantity || 0;


                            const assignErrorsDiv = document.getElementById('assigned_staffErrorsAssign');
                            if (assignErrorsDiv) assignErrorsDiv.textContent = '';
                            if (assignStaffModal) assignStaffModal.classList.add('show');
                            console.log("Assign Staff modal shown with data for ID:", requestId); 
                        } else {
                            showMessage(currentRequestData.error || 'Failed to fetch current request details for assignment.', 'error');
                        }
                    } catch (error) {
                        console.error('Error fetching request details for assignment:', error);
                        showMessage('Network error or server issue fetching request details.', 'error');
                    }
                });
            });

            if (cancelAssignButton) { 
                cancelAssignButton.addEventListener('click', () => {
                    if (assignStaffModal) assignStaffModal.classList.remove('show');
                    console.log("Assign Staff modal canceled."); 
                });
            }


            if (assignStaffForm) {
                console.log("Attaching listener to assignStaffForm submit."); 
                assignStaffForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log("Assign Staff Form submitted."); 
                    const assignErrorsDiv = document.getElementById('assigned_staffErrorsAssign');
                    if (assignErrorsDiv) assignErrorsDiv.textContent = ''; 

                    const requestId = assignRequestIdInput ? assignRequestIdInput.value : '';
                    const url = `/api/requests/${requestId}/update/`; 

                    const formData = new FormData(assignStaffForm);

                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken,
                            },
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success) {
                            showMessage(result.message, 'success');
                            if (assignStaffModal) assignStaffModal.classList.remove('show');
                            location.reload(); 
                        } else {
                            let generalErrorMessage = result.error || 'Failed to assign task due to validation errors.';
                            showMessage(generalErrorMessage, 'error');

                            if (result.errors) {
                                const errors = JSON.parse(result.errors);
                                const errorDiv = document.getElementById('assigned_staffErrorsAssign');
                                if (errors.assigned_staff && errorDiv) {
                                    errorDiv.textContent = errors.assigned_staff[0].message;
                                } else {
                                    console.error('Unhandled form error:', errors);
                                    showMessage('Error: ' + JSON.stringify(errors), 'error');
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error assigning task:', error);
                        showMessage('Network error or server issue assigning task.', 'error');
                    }
                });
            }


            const confirmationMessage = document.getElementById('confirmationMessage');
            const confirmationYesButton = document.getElementById('confirmationYesButton');
            const confirmationCloseButtons = confirmationModal ? confirmationModal.querySelectorAll('.close-button, .cancel-button') : [];

            let currentActionId = null; 
            let currentActionType = null; 

            function showConfirmationModal(message, id, actionType) {
                if (confirmationMessage) confirmationMessage.textContent = message;
                currentActionId = id;
                currentActionType = actionType;
                if (confirmationModal) confirmationModal.classList.add('show');
                console.log("Confirmation modal shown for action:", actionType, "ID:", id); 
            }

            if (confirmationYesButton) { 
                confirmationYesButton.addEventListener('click', async () => {
                    if (confirmationModal) confirmationModal.classList.remove('show'); 

                    if (currentActionType === 'delete_assignment') {
                        try {
                            const response = await fetch(`/api/assignments/${currentActionId}/delete/`, {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': csrfToken 
                                }
                            });
                            const result = await response.json();
                            if (result.success) {
                                showMessage('Assignment deleted successfully!', 'success');
                                const deletedRow = document.querySelector(`.data-table tbody tr [data-assignment-id="${currentActionId}"]`);
                                if (deletedRow) {
                                    deletedRow.closest('tr').remove(); 
                                }
                                console.log("Assignment deleted:", currentActionId); 
                            } else {
                                showMessage(result.error || 'Failed to delete assignment.', 'error');
                            }
                        } catch (error) {
                            console.error('Error deleting assignment:', error);
                            showMessage('Network error or server issue deleting assignment.', 'error');
                        }
                    } else if (currentActionType === 'delete_amenity') {
                        try {
                            const response = await fetch(`/api/amenities/${currentActionId}/delete/`, {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': csrfToken 
                                }
                            });
                            const result = await response.json();
                            if (result.success) {
                                showMessage('Amenity deleted successfully!', 'success');
                                const deletedRow = document.querySelector(`.data-table tbody tr [data-amenity-id="${currentActionId}"]`);
                                if (deletedRow) {
                                    deletedRow.closest('tr').remove(); 
                                }
                                console.log("Amenity deleted:", currentActionId); 
                            } else {
                                showMessage(result.error || 'Failed to delete amenity.', 'error');
                            }
                        } catch (error) {
                            console.error('Error deleting amenity:', error);
                            showMessage('Network error or server issue deleting amenity.', 'error');
                        }
                    }
                });
            }

            if (confirmationCloseButtons) { 
                confirmationCloseButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        if (confirmationModal) confirmationModal.classList.remove('show');
                        console.log("Confirmation modal closed."); 
                    });
                });
            }


            const addAssignmentButton = document.getElementById('addAssignmentButton');
            const assignmentForm = document.getElementById('assignmentForm');
            const assignmentModalTitle = document.getElementById('assignmentModalTitle');

            function clearFormErrors(formId) {
                document.querySelectorAll(`#${formId} .error-message`).forEach(el => el.textContent = '');
            }

            if (addAssignmentButton) {
                addAssignmentButton.addEventListener('click', () => {
                    if (assignmentModalTitle) assignmentModalTitle.textContent = 'Add New Guest Assignment';
                    if (assignmentForm) assignmentForm.reset(); 
                    const assignmentIdInput = document.getElementById('assignmentId');
                    if (assignmentIdInput) assignmentIdInput.value = ''; 
                    clearFormErrors('assignmentForm');
                    if (assignmentModal) assignmentModal.classList.add('show');
                    console.log("Add Assignment modal shown."); 
                });
            } 

            document.querySelectorAll('.edit-assignment-button').forEach(button => {
                button.addEventListener('click', async () => {
                    console.log("Edit Assignment button clicked."); 
                    const assignmentId = button.dataset.assignmentId;
                    if (assignmentModalTitle) assignmentModalTitle.textContent = 'Edit Guest Assignment';
                    if (assignmentForm) assignmentForm.reset(); 
                    const assignmentIdInput = document.getElementById('assignmentId');
                    if (assignmentIdInput) assignmentIdInput.value = assignmentId; 
                    clearFormErrors('assignmentForm');

                    try {
                        const response = await fetch(`/api/assignments/${assignmentId}/edit/`); 
                        const data = await response.json();
                        if (data.success) {
                            if (data.assignment.check_in_time) {
                                const checkInDateTime = new Date(data.assignment.check_in_time);
                                const checkInDateInput = assignmentForm.querySelector('[name="check_in_date"]');
                                const checkInTimeInput = assignmentForm.querySelector('[name="check_in_time_input"]');
                                if (checkInDateInput) checkInDateInput.value = checkInDateTime.toISOString().split('T')[0];
                                if (checkInTimeInput) checkInTimeInput.value = checkInDateTime.toTimeString().slice(0, 5);
                            }
                            if (data.assignment.check_out_time) {
                                const checkOutDateTime = new Date(data.assignment.check_out_time);
                                const checkOutDateInput = assignmentForm.querySelector('[name="check_out_date"]');
                                const checkOutTimeInput = assignmentForm.querySelector('[name="check_out_time_input"]');
                                if (checkOutDateInput) checkOutDateInput.value = checkOutDateTime.toISOString().split('T')[0];
                                if (checkOutTimeInput) checkOutTimeInput.value = checkOutDateTime.toTimeString().slice(0, 5);
                            }
                            
                            const roomNumberInput = assignmentForm.querySelector('[name="room_number_input"]');
                            if (roomNumberInput && data.assignment.room_number && data.assignment.room_number.room_number) {
                                roomNumberInput.value = data.assignment.room_number.room_number;
                            }

                            const guestNamesInput = assignmentForm.querySelector('[name="guest_names"]');
                            if (guestNamesInput) guestNamesInput.value = data.assignment.guest_names;
                            
                            const statusSelect = assignmentForm.querySelector('[name="status"]');
                            if (statusSelect) statusSelect.value = data.assignment.status;
                            
                            const totalBillAmountInput = assignmentForm.querySelector('[name="total_bill_amount"]');
                            if (totalBillAmountInput) totalBillAmountInput.value = data.assignment.total_bill_amount;
                            
                            const amountPaidInput = assignmentForm.querySelector('[name="amount_paid"]');
                            if (amountPaidInput) amountPaidInput.value = data.assignment.amount_paid;

                            if (assignmentModal) assignmentModal.classList.add('show');
                            console.log("Edit Assignment modal shown with data for ID:", assignmentId); 
                        } else {
                            showMessage(data.error || 'Failed to load assignment details.', 'error');
                        }
                    } catch (error) {
                        console.error('Error fetching assignment details:', error);
                        showMessage('Network error or server issue fetching assignment details.', 'error');
                    }
                });
            });


            const closeAssignmentModalButtons = assignmentModal ? assignmentModal.querySelectorAll('.close-button, .cancel-button') : [];
            closeAssignmentModalButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (assignmentModal) assignmentModal.classList.remove('show');
                    clearFormErrors('assignmentForm');
                    console.log("Assignment modal closed."); 
                });
            });

            if (assignmentForm) { 
                assignmentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log("Assignment Form submitted."); 
                    clearFormErrors('assignmentForm');

                    const formData = new FormData(assignmentForm);
                    const assignmentIdInput = document.getElementById('assignmentId');
                    const assignmentId = assignmentIdInput ? assignmentIdInput.value : '';
                    const url = assignmentId ? `/api/assignments/${assignmentId}/edit/` : `/dashboard/guests/`;
                    const method = 'POST'; 

                    try {
                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'X-CSRFToken': csrfToken, 
                            },
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success) {
                            showMessage(result.message, 'success');
                            if (assignmentModal) assignmentModal.classList.remove('show');
                            location.reload();
                        } else {
                            let generalErrorMessage = result.error || 'Failed to save assignment due to validation errors.';
                            showMessage(generalErrorMessage, 'error');

                            if (result.errors) {
                                const errors = JSON.parse(result.errors);
                                for (const field in errors) {
                                    const errorDiv = document.getElementById(`${field}Errors`);
                                    if (errorDiv) {
                                        errorDiv.textContent = errors[field][0].message;
                                    } else {
                                        console.error(`Unhandled form error for field ${field}:`, errors[field][0].message);
                                        showMessage(`Error: ${errors[field][0].message}`, 'error');
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error submitting assignment form:', error);
                        showMessage('Network error or server issue saving assignment.', 'error');
                    }
                });
            } 


            const addAmenityButton = document.getElementById('addAmenityButton');
            const amenityModalTitle = document.getElementById('amenityModalTitle');
            const amenityForm = document.getElementById('amenityForm');
            const amenityIdInput = document.getElementById('amenityId');
            const amenityNameInput = document.getElementById('amenityName');
            const amenityDescriptionInput = document.getElementById('amenityDescription');
            const amenityPriceInput = document.getElementById('amenityPrice');
            const amenityIsAvailableInput = document.getElementById('amenityIsAvailable');

            if (addAmenityButton) { 
                addAmenityButton.addEventListener('click', () => {
                    if (amenityModalTitle) amenityModalTitle.textContent = 'Add New Amenity';
                    if (amenityForm) amenityForm.reset(); 
                    if (amenityIdInput) amenityIdInput.value = ''; 
                    if (amenityModal) amenityModal.classList.add('show');
                    document.querySelectorAll('#amenityForm .error-message').forEach(el => el.textContent = '');
                    console.log("Add Amenity modal shown."); 
                });
            } 

            document.querySelectorAll('.edit-amenity-button').forEach(button => {
                button.addEventListener('click', async () => {
                    console.log("Edit Amenity button clicked."); 
                    const amenityId = button.dataset.amenityId;
                    try {
                        const response = await fetch(`/api/amenities/${amenityId}/`);
                        const result = await response.json();
                        if (result.success) {
                            if (amenityModalTitle) amenityModalTitle.textContent = 'Edit Amenity';
                            if (amenityIdInput) amenityIdInput.value = result.id;
                            if (amenityNameInput) amenityNameInput.value = result.name;
                            if (amenityDescriptionInput) amenityDescriptionInput.value = result.description || '';
                            if (amenityPriceInput) amenityPriceInput.value = result.price;
                            if (amenityIsAvailableInput) amenityIsAvailableInput.checked = result.is_available;
                            if (amenityModal) amenityModal.classList.add('show');
                            document.querySelectorAll('#amenityForm .error-message').forEach(el => el.textContent = '');
                            console.log("Edit Amenity modal shown with data for ID:", amenityId); 
                        } else {
                            showMessage(result.error || 'Failed to load amenity details.', 'error');
                        }
                    } catch (error) {
                        console.error('Error fetching amenity details:', error);
                        showMessage('Network error or server issue loading amenity details.', 'error');
                    }
                });
            });

            if (amenityForm) { 
                amenityForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log("Amenity Form submitted."); 
                    document.querySelectorAll('#amenityForm .error-message').forEach(el => el.textContent = '');

                    const amenityId = amenityIdInput ? amenityIdInput.value : '';
                    const url = '{% url "main:save_or_update_amenity_api" %}'; 
                    
                    const method = 'POST'; 

                    const formData = new FormData(amenityForm);
                    if (amenityIsAvailableInput) formData.set('is_available', amenityIsAvailableInput.checked ? 'True' : 'False');

                    try {
                        const response = await fetch(url, {
                            method: method, 
                            headers: {
                                'X-CSRFToken': csrfToken,
                            },
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success) {
                            showMessage(result.message, 'success');
                            if (amenityModal) amenityModal.classList.remove('show');
                            location.reload(); 
                        } else {
                            let generalErrorMessage = result.error || 'Failed to save amenity due to validation errors.';
                            showMessage(generalErrorMessage, 'error');

                            if (result.errors) {
                                const errors = JSON.parse(result.errors);
                                for (const field in errors) {
                                    const errorDiv = document.getElementById(`amenity${field.charAt(0).toUpperCase() + field.slice(1)}Errors`);
                                    if (errorDiv) {
                                        errorDiv.textContent = errors[field][0].message;
                                    } else {
                                        showMessage(errors[field][0].message, 'error');
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error submitting amenity form:', error);
                        showMessage('Network error or server issue saving amenity.', 'error');
                    }
                });
            } 

            document.querySelectorAll('.delete-assignment-button').forEach(button => {
                button.addEventListener('click', async () => {
                    console.log("Delete Assignment button clicked."); 
                    const assignmentId = button.dataset.assignmentId;
                    showConfirmationModal('Are you sure you want to delete this guest assignment?', assignmentId, 'delete_assignment');
                });
            });

            document.querySelectorAll('.delete-amenity-button').forEach(button => {
                button.addEventListener('click', async () => {
                    console.log("Delete Amenity button clicked."); 
                    const amenityId = button.dataset.amenityId;
                    showConfirmationModal('Are you sure you want to delete this amenity? This cannot be undone.', amenityId, 'delete_amenity');
                });
            });
            console.log("Dashboard initialization complete."); 
        });
    </script>
</body>
</html>
