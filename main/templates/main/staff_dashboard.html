<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }}</title>
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts - Inter for a modern, clean look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- D3.js for charts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        /* Define Color Palettes for Light and Dark Mode based on image_2eae9a.jpg */
        :root {
            /* Light Mode Colors */
            --bg: #F7F8FA; /* Very light gray background */
            --card-bg: #FFFFFF; /* White card background */
            --text: #333333; /* Dark gray text */
            --secondary-text: #666666; /* Medium gray secondary text */
            --border: #E0E0E0; /* Light gray border */
            --shadow-color: rgba(0, 0, 0, 0.05); /* Subtle shadow */

            --primary-button-bg: #2C3E50; /* Dark blue/charcoal for primary buttons */
            --primary-button-text: #FFFFFF;
            --secondary-button-bg: #F0F0F0; /* Light gray for secondary buttons */
            --secondary-button-text: #333333;

            --sidebar-bg: #FFFFFF; /* White sidebar */
            --sidebar-text: #333333;
            --sidebar-active-bg: #E0E6F0; /* Light blue-gray for active sidebar item as per image */
            --sidebar-active-text: #2C3E50; /* Dark text for active sidebar item */
            --sidebar-active-border-left: #2C3E50; /* Dark blue-gray for left border */


            /* Accent Colors for Summary Cards (from image) */
            --accent-purple-bg: #E0CCF6; /* Light purple */
            --accent-purple-text: #8A2BE2; /* Dark purple */
            --accent-green-bg: #D1F7E0; /* Light green */
            --accent-green-text: #28A745; /* Dark green */
            --accent-pink-bg: #FAD7DD; /* Light pink */
            --accent-pink-text: #DC3545; /* Dark red/pink */
            --accent-orange-bg: #FFF3CD; /* Light orange/yellow */
            --accent-orange-text: #FFC107; /* Dark orange/yellow */

            /* Chart Colors */
            --chart-line-color: #007BFF; /* Vibrant blue for chart line */
            --chart-grid-color: #E0E0E0; /* Light grid lines */
            --chart-axis-text: #666666; /* Axis text color */

            /* Status Badge Colors (for GuestRoomAssignment and GuestRequest status) */
            --badge-occupied-bg: var(--accent-purple-bg);
            --badge-occupied-text: var(--accent-purple-text);
            --badge-reserved-bg: var(--accent-green-bg);
            --badge-reserved-text: var(--accent-green-text);
            --badge-available-bg: var(--accent-orange-bg);
            --badge-available-text: var(--accent-orange-text);
            --badge-not-ready-bg: var(--accent-pink-bg);
            --badge-not-ready-text: var(--accent-pink-text);
            --badge-pending-bg: var(--border); /* Default light gray */
            --badge-pending-text: var(--secondary-text);
            --badge-in_progress-bg: var(--accent-green-bg);
            --badge-in_progress-text: var(--accent-green-text);
            --badge-completed-bg: var(--accent-purple-bg);
            --badge-completed-text: var(--accent-purple-text);
            --badge-cancelled-bg: var(--accent-pink-bg);
            --badge-cancelled-text: var(--accent-pink-text);
            --badge-default-bg: var(--border);
            --badge-default-text: var(--secondary-text);
        }

        /* Dark Mode Colors */
        html[data-theme='dark'] {
            --bg: #1E1E1E; /* Very dark gray/black background */
            --card-bg: #2C2C2C; /* Darker gray card background */
            --text: #E0E0E0; /* Light gray text */
            --secondary-text: #A0A0A0; /* Medium light gray secondary text */
            --border: #404040; /* Darker gray border */
            --shadow-color: rgba(0, 0, 0, 0.3); /* More pronounced shadow for dark mode */

            --primary-button-bg: #E0E0E0; /* Light gray for primary buttons */
            --primary-button-text: #1E1E1E;
            --secondary-button-bg: #404040; /* Darker gray for secondary buttons */
            --secondary-button-text: #E0E0E0;

            --sidebar-bg: #212121; /* Darker sidebar */
            --sidebar-text: #E0E0E0;
            --sidebar-active-bg: #3A4A5A; /* Darker blue-gray for active sidebar item */
            --sidebar-active-text: #E0E0E0; /* Light text for active sidebar item */
            --sidebar-active-border-left: #007BFF; /* Vibrant blue for left border */

            /* Accent Colors for Summary Cards (adjusted for dark mode visibility) */
            --accent-purple-bg: #5C3D82;
            --accent-purple-text: #E0CCF6;
            --accent-green-bg: #2E6F40;
            --accent-green-text: #D1F7E0;
            --accent-pink-bg: #7A2F3A;
            --accent-pink-text: #FAD7DD;
            --accent-orange-bg: #8F6C1A;
            --accent-orange-text: #FFF3CD;

            /* Chart Colors (lighter versions for dark mode) */
            --chart-line-color: #66B2FF;
            --chart-grid-color: #404040;
            --chart-axis-text: #A0A0A0;

            /* Status Badge Colors (adjusted for dark mode visibility) */
            --badge-occupied-bg: var(--accent-purple-bg);
            --badge-occupied-text: var(--accent-purple-text);
            --badge-reserved-bg: var(--accent-green-bg);
            --badge-reserved-text: var(--accent-green-text);
            --badge-available-bg: var(--accent-orange-bg);
            --badge-available-text: var(--accent-orange-text);
            --badge-not-ready-bg: var(--accent-pink-bg);
            --badge-not-ready-text: var(--accent-pink-text);
            --badge-pending-bg: var(--border);
            --badge-pending-text: var(--secondary-text);
            --badge-in_progress-bg: var(--accent-green-bg);
            --badge-in_progress-text: var(--accent-green-text);
            --badge-completed-bg: var(--accent-purple-bg);
            --badge-completed-text: var(--accent-purple-text);
            --badge-cancelled-bg: var(--accent-pink-bg);
            --badge-cancelled-text: var(--accent-pink-text);
            --badge-default-bg: var(--border);
            --badge-default-text: var(--secondary-text);
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: var(--text);
            overflow-x: hidden;
            font-size: 0.95em;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            display: flex;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            padding: 20px;
            box-shadow: 2px 0 5px var(--shadow-color);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100%;
            overflow-y: auto;
            box-sizing: border-box;
            transition: width 0.3s ease, transform 0.3s ease, background-color 0.3s ease, color 0.3s ease;
            z-index: 999;
        }

        .sidebar.collapsed {
            width: 70px; /* Width when collapsed */
            transform: translateX(0);
        }

        /* Hide text elements when sidebar is collapsed */
        .sidebar.collapsed .sidebar-header h2,
        .sidebar.collapsed ul li a span,
        .sidebar.collapsed .logout-section a span {
            display: none;
        }

        /* Adjust toggle button position when collapsed */
        .sidebar.collapsed .sidebar-header .toggle-btn {
            margin-left: auto; /* Push to the right */
            margin-right: 0;
        }
        .sidebar.collapsed .sidebar-header {
            justify-content: flex-end; /* Align toggle to end */
        }

        /* Center icons when collapsed */
        .sidebar.collapsed ul li a,
        .sidebar.collapsed .logout-section a {
            justify-content: center;
            padding: 10px;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: none; /* Remove border-bottom from header */
        }

        .sidebar-header h2 {
            margin: 0;
            color: var(--sidebar-text);
            font-size: 1.8em;
            transition: opacity 0.3s ease, color 0.3s ease;
        }

        .sidebar-header .toggle-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            color: var(--sidebar-text);
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.3s ease, color 0.3s ease;
            line-height: 1; /* Ensure icon is vertically centered */
        }

        .sidebar-header .toggle-btn:hover {
            background-color: rgba(0,0,0,0.05);
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            flex-grow: 1;
        }

        .sidebar ul li {
            margin-bottom: 5px; /* Reduced margin for tighter spacing */
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            gap: 15px; /* Increased gap between icon and text */
            padding: 12px 15px; /* Adjusted padding */
            color: var(--sidebar-text);
            text-decoration: none;
            border-radius: 8px;
            transition: background-color 0.3s ease, color 0.3s ease, border-left 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            font-weight: 500;
        }

        .sidebar ul li a:hover {
            background-color: var(--sidebar-active-bg); /* Use active background for hover */
            color: var(--sidebar-active-text);
            border-left: 5px solid var(--sidebar-active-border-left); /* Left border on hover */
            padding-left: 10px; /* Adjust padding to accommodate border */
        }
        .sidebar ul li a.active {
            background-color: var(--sidebar-active-bg);
            color: var(--sidebar-active-text);
            border-left: 5px solid var(--sidebar-active-border-left); /* Solid left border for active */
            padding-left: 10px; /* Adjust padding to accommodate border */
        }
        .sidebar ul li a.active i {
            color: var(--sidebar-active-text);
        }

        .sidebar ul li a i {
            font-size: 1.2em;
            color: var(--sidebar-text);
            transition: color 0.3s ease;
        }

        .logout-section {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .logout-section a {
            display: flex;
            align-items: center;
            gap: 15px; /* Increased gap */
            padding: 12px 15px; /* Adjusted padding */
            color: var(--status-error-text);
            text-decoration: none;
            border-radius: 8px;
            transition: background-color 0.3s ease, color 0.3s ease, border-left 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            font-weight: 500;
        }

        .logout-section a:hover {
            background-color: var(--status-error-text);
            color: var(--card-bg);
            border-left: 5px solid var(--status-error-text); /* Left border on hover */
            padding-left: 10px;
        }

        .main-content {
            margin-left: 280px;
            flex-grow: 1;
            padding: 20px;
            transition: margin-left 0.3s ease;
        }

        .main-content.sidebar-collapsed {
            margin-left: 70px;
        }

        .header {
            background-color: var(--card-bg);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px var(--shadow-color);
            border: 1px solid var(--border);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .header h1 {
            margin: 0;
            color: var(--text);
            font-size: 1.5em;
            transition: color 0.3s ease;
        }

        .header .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header .user-info .notification-bell {
            position: relative;
            cursor: pointer;
            color: var(--text);
            font-size: 1.3em;
            transition: color 0.3s ease;
        }

        .header .user-info .notification-bell .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--status-error-text);
            color: var(--card-bg);
            border-radius: 50%;
            padding: 3px 7px;
            font-size: 0.7em;
            line-height: 1;
        }

        .header .user-info span {
            font-weight: 500;
            color: var(--text);
            font-size: 0.9em;
            transition: color 0.3s ease;
        }

        /* Dark Mode Toggle Button */
        .theme-toggle-button {
            background: none;
            border: none;
            font-size: 1.3em;
            color: var(--text);
            cursor: pointer;
            margin-left: 15px;
            transition: color 0.3s ease;
        }
        .theme-toggle-button:hover {
            color: var(--secondary-text);
        }


        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px var(--shadow-color);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .card h3 {
            margin-top: 0;
            color: var(--text);
            font-size: 1.1em;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .card p {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--text);
            margin: 8px 0 0;
            transition: color 0.3s ease;
        }

        .card.summary-card {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card.summary-card .icon-wrapper {
            background-color: var(--bg);
            color: var(--text);
            padding: 12px;
            border-radius: 50%;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            flex-shrink: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Specific Summary Card Colors for original content */
        .card.summary-card.occupied .icon-wrapper { background-color: var(--badge-occupied-bg); color: var(--badge-occupied-text); }
        .card.summary-card.occupied h3, .card.summary-card.occupied p { color: var(--badge-occupied-text); }

        .card.summary-card.reserved .icon-wrapper { background-color: var(--badge-reserved-bg); color: var(--badge-reserved-text); }
        .card.summary-card.reserved h3, .card.summary-card.reserved p { color: var(--badge-reserved-text); }

        .card.summary-card.available .icon-wrapper { background-color: var(--badge-available-bg); color: var(--badge-available-text); }
        .card.summary-card.available h3, .card.summary-card.available p { color: var(--badge-available-text); }

        .card.summary-card.not-ready .icon-wrapper { background-color: var(--badge-not-ready-bg); color: var(--badge-not-ready-text); }
        .card.summary-card.not-ready h3, .card.summary-card.not-ready p { color: var(--badge-not-ready-text); }

        /* General summary card text color for other cards if no specific class */
        .card.summary-card .text-content p, .card.summary-card .text-content h3 {
            color: var(--text);
        }


        .card.summary-card .text-content {
            flex-grow: 1;
        }

        .card.summary-card .text-content p {
            font-size: 1.2em;
        }

        .chart-container {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px var(--shadow-color);
            border: 1px solid var(--border);
            margin-bottom: 20px;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .chart-container h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--text);
            font-size: 1.1em;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .chart-placeholder {
            width: 100%;
            height: 280px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: transparent;
            border-radius: 8px;
            color: var(--secondary-text);
        }
        .chart-placeholder .domain, .chart-placeholder .tick line {
            stroke: var(--chart-grid-color);
            transition: stroke 0.3s ease;
        }
        .chart-placeholder .tick text {
            fill: var(--chart-axis-text);
            transition: fill 0.3s ease;
        }


        /* Request Management Styles */
        .request-tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 5px var(--shadow-color);
            border: 1px solid var(--border);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .request-tabs button {
            flex: 1;
            background-color: var(--card-bg);
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            color: var(--text);
            transition: all 0.3s ease;
            text-align: center;
        }

        .request-tabs button:hover {
            background-color: var(--border);
            color: var(--text);
        }

        .request-tabs button.active {
            background-color: var(--primary-button-bg);
            color: var(--primary-button-text);
            font-weight: 600;
        }

        .request-tabs button.active:hover {
            background-color: var(--primary-button-bg);
            color: var(--primary-button-text);
        }


        .request-category {
            margin-bottom: 25px;
            background-color: var(--card-bg);
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 4px 8px var(--shadow-color);
            border: 1px solid var(--border);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .request-category h3 {
            margin-top: 0;
            margin-bottom: 12px;
            color: var(--text);
            font-size: 1.2em;
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
            transition: color 0.3s ease, border-color 0.3s ease;
        }

        .request-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .request-item {
            background-color: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 2px 4px var(--shadow-color);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 140px;
            font-size: 0.9em;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .request-item p {
            margin: 4px 0;
            font-size: 0.9em;
            color: var(--text);
            transition: color 0.3s ease;
        }

        .request-item .status-badge {
            padding: 3px 6px;
            font-size: 0.75em;
            border-radius: 5px;
            font-weight: 600;
            display: inline-block;
            margin-top: 5px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Status-specific badge colors for GuestRequest status */
        .status-badge.pending { background-color: var(--badge-pending-bg); color: var(--badge-pending-text); }
        .status-badge.in_progress { background-color: var(--badge-in_progress-bg); color: var(--badge-in_progress-text); }
        .status-badge.completed { background-color: var(--badge-completed-bg); color: var(--badge-completed-text); }
        .status-badge.cancelled { background-color: var(--badge-cancelled-bg); color: var(--badge-cancelled-text); }
        .status-badge.casual_chat, .status-badge.general_inquiry { background-color: var(--badge-default-bg); color: var(--badge-default-text); }


        .request-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .request-actions button {
            padding: 7px 10px;
            font-size: 0.85em;
            background-color: var(--primary-button-bg);
            color: var(--primary-button-text);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .request-actions button:hover {
            opacity: 0.9;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: auto;
            padding: 25px;
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 90%;
            max-width: 550px;
            box-shadow: 0 5px 15px var(--shadow-color);
            position: relative;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .modal-header {
            margin-bottom: 18px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.4em;
            color: var(--text);
            margin: 0;
            transition: color 0.3s ease;
        }

        .close-button {
            font-size: 26px;
            color: var(--secondary-text);
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--text);
        }

        .modal-body label {
            margin-bottom: 6px;
            font-size: 0.9em;
            color: var(--text);
            display: block;
            transition: color 0.3s ease;
        }

        .modal-body input[type="text"],
        .modal-body input[type="email"],
        .modal-body input[type="number"],
        .modal-body input[type="date"],
        .modal-body input[type="time"],
        .modal-body textarea,
        .modal-body select {
            width: calc(100% - 16px);
            padding: 8px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9em;
            transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
            box-sizing: border-box;
            color: var(--text);
            background-color: var(--bg);
        }

        .modal-body input[type="text"]:focus,
        .modal-body input[type="email"]:focus,
        .modal-body input[type="number"]:focus,
        .modal-body input[type="date"]:focus,
        .modal-body input[type="time"]:focus,
        .modal-body textarea:focus,
        .modal-body select:focus {
            border-color: var(--primary-button-bg);
            outline: none;
        }

        .modal-body textarea {
            min-height: 70px;
        }

        .form-check {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-check-input {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-button-bg);
            transition: accent-color 0.3s ease;
        }

        .form-check-label {
            font-size: 0.9em;
            color: var(--text);
            transition: color 0.3s ease;
        }

        .datetime-group {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .datetime-group .form-group {
            flex: 1;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 18px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            transition: border-color 0.3s ease;
        }

        .modal-footer .save-button {
            background-color: var(--primary-button-bg);
            color: var(--primary-button-text);
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .modal-footer .save-button:hover {
            opacity: 0.9;
        }

        .modal-footer .cancel-button {
            background-color: var(--secondary-button-bg);
            color: var(--secondary-button-text);
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .modal-footer .cancel-button:hover {
            opacity: 0.9;
        }

        /* Message Box Styles */
        #messageBox {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card-bg);
            color: var(--text);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px var(--shadow-color);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, background-color 0.3s ease, color 0.3s ease;
            z-index: 1001;
        }
        #messageBox.show {
            opacity: 1;
            visibility: visible;
        }
        #messageBox.success { background-color: var(--status-success-bg); color: var(--status-success-text); }
        #messageBox.error { background-color: var(--status-error-bg); color: var(--status-error-text); }
        #messageBox.warning { background-color: var(--status-warning-bg); color: var(--status-warning-text); }
        #messageBox.info { background-color: var(--status-info-bg); color: var(--status-info-text); }


        /* Request Details Modal Specific Styles */
        .request-details-modal .modal-body .detail-row {
            margin-bottom: 8px;
            padding-bottom: 4px;
            font-size: 0.9em;
            border-bottom: 1px dashed var(--border);
            transition: border-color 0.3s ease;
        }
        .request-details-modal .modal-body .detail-row:last-of-type {
            border-bottom: none;
        }

        .request-details-modal .modal-body .detail-row strong {
            flex: 0 0 100px;
            color: var(--text);
            display: inline-block;
            transition: color 0.3s ease;
        }

        .request-details-modal .modal-body .detail-row span {
            color: var(--secondary-text);
            transition: color 0.3s ease;
        }

        .request-details-modal .chat-history-section {
            margin-top: 18px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            transition: border-color 0.3s ease;
        }

        .request-details-modal .chat-history-section h4 {
            margin-bottom: 8px;
            font-size: 1.1em;
            color: var(--text);
            transition: color 0.3s ease;
        }

        .request-details-modal .chat-messages {
            max-height: 180px;
            padding: 8px;
            font-size: 0.85em;
            background-color: var(--bg);
            border-radius: 8px;
            overflow-y: auto;
            border: 1px solid var(--border);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .request-details-modal .chat-message {
            margin-bottom: 6px;
            padding: 4px 8px;
            border-radius: 6px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .request-details-modal .chat-message.user {
            background-color: var(--card-bg);
            text-align: left;
        }

        .request-details-modal .chat-message.model {
            background-color: var(--bg);
            text-align: left;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: none;
                border-bottom: 2px solid var(--border);
                transform: translateX(0);
            }
            .sidebar.collapsed {
                width: 100%;
            }
            .sidebar.collapsed .sidebar-header h2,
            .sidebar.collapsed ul li a span,
            .sidebar.collapsed .logout-section a span {
                display: block;
                opacity: 1;
            }
            .sidebar.collapsed .sidebar-header .toggle-btn i {
                display: inline-block;
            }
            .sidebar-header .toggle-btn {
                display: none;
            }
            .main-content {
                margin-left: 0;
                padding-top: 20px;
            }
            .main-content.sidebar-collapsed {
                margin-left: 0;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .header .user-info {
                width: 100%;
                justify-content: flex-end;
            }
            .dashboard-grid, .chart-grid, .request-list {
                grid-template-columns: 1fr;
            }
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            .datetime-group {
                flex-direction: column;
                gap: 0;
            }
            .datetime-group .form-group {
                width: 100%;
                margin-bottom: 15px;
            }
            .request-tabs {
                flex-direction: column;
            }
            .request-tabs button {
                border-radius: 0;
                margin-bottom: 1px;
            }
            .request-tabs button:first-child {
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
            }
            .request-tabs button:last-child {
                border-bottom-left-radius: 8px;
                border-bottom-right-radius: 8px;
            }
        }

        /* Table styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 4px var(--shadow-color);
            font-size: 0.9em;
            border: 1px solid var(--border);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .data-table thead {
            background-color: var(--bg);
            color: var(--text);
        }

        .data-table th, .data-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            color: var(--text);
            transition: color 0.3s ease, border-color 0.3s ease;
        }

        .data-table tbody tr:hover {
            background-color: var(--border);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .table-responsive {
            overflow-x: auto;
            border-radius: 12px;
        }

        /* Form control styling for filter forms */
        .filter-card form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .filter-card .form-group {
            margin-bottom: 0;
        }

        .filter-card .form-group label {
            font-size: 0.85em;
            margin-bottom: 4px;
            color: var(--text);
            transition: color 0.3s ease;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            margin-bottom: 0;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9em;
            transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
            box-sizing: border-box;
            color: var(--text);
            background-color: var(--bg);
        }

        .form-control:focus {
            border-color: var(--primary-button-bg);
            outline: none;
        }

        .button-primary {
            background-color: var(--primary-button-bg);
            color: var(--primary-button-text);
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .button-primary:hover {
            opacity: 0.9;
        }

        .button-secondary {
            background-color: var(--secondary-button-bg);
            color: var(--secondary-button-text);
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .button-secondary:hover {
            opacity: 0.9;
        }

        .error-message {
            color: var(--status-error-text);
            font-size: 0.8em;
            margin-top: 2px;
            margin-bottom: 5px;
            transition: color 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>ConciAI</h2>
                <button class="toggle-btn" id="sidebarToggle">
                    <i class="fas fa-chevron-left"></i> <!-- Default to left chevron -->
                </button>
            </div>
            <ul>
                <li><a href="{% url 'main:home_dashboard' %}" class="{% if current_main_tab == 'home' %}active{% endif %}"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
                <li><a href="{% url 'main:guest_requests_dashboard' %}" class="{% if current_main_tab == 'requests' %}active{% endif %}"><i class="fas fa-bell"></i> <span>Guest Requests</span></a></li>
                <li><a href="{% url 'main:guest_management' %}" class="{% if current_main_tab == 'guest_management' %}active{% endif %}"><i class="fas fa-users"></i> <span>Guest Management</span></a></li>
                <li><a href="{% url 'main:amenity_management' %}" class="{% if current_main_tab == 'amenities' %}active{% endif %}"><i class="fas fa-spa"></i> <span>Amenity Management</span></a></li>
            </ul>
            <div class="logout-section">
                <a href="{% url 'logout' %}"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a>
            </div>
        </aside>

        <main class="main-content" id="mainContent">
            <header class="header">
                <h1>{{ page_title }}</h1>
                <div class="user-info">
                    <button class="theme-toggle-button" id="themeToggleButton">
                        <i class="fas fa-moon"></i> <!-- Default to moon icon for light mode -->
                    </button>
                    <div class="notification-bell" id="notificationBell">
                        <i class="fas fa-bell"></i>
                        <span class="badge" id="notificationBadge">0</span>
                    </div>
                    <span>Hello, {{ user.username }}!</span>
                </div>
            </header>

            {% if current_main_tab == 'home' %}
                <div class="dashboard-grid">
                    <div class="card summary-card occupied">
                        <div class="icon-wrapper"><i class="fas fa-door-open"></i></div>
                        <div class="text-content">
                            <h3>Occupied Rooms</h3>
                            <p>{{ occupied_rooms }} / {{ total_rooms }}</p>
                        </div>
                    </div>
                    <div class="card summary-card reserved">
                        <div class="icon-wrapper"><i class="fas fa-calendar-check"></i></div>
                        <div class="text-content">
                            <h3>Reserved Rooms</h3>
                            <p>{{ reserved_rooms }}</p>
                        </div>
                    </div>
                    <div class="card summary-card available">
                        <div class="icon-wrapper"><i class="fas fa-bed"></i></div>
                        <div class="text-content">
                            <h3>Available Rooms</h3>
                            <p>{{ available_rooms }}</p>
                        </div>
                    </div>
                    <div class="card summary-card not-ready">
                        <div class="icon-wrapper"><i class="fas fa-tools"></i></div>
                        <div class="text-content">
                            <h3>Rooms Not Ready</h3>
                            <p>{{ not_ready_rooms }}</p>
                        </div>
                    </div>
                    <div class="card summary-card">
                        <div class="icon-wrapper"><i class="fas fa-book-open"></i></div>
                        <div class="text-content">
                            <h3>New Bookings Today</h3>
                            <p>{{ new_bookings_count }}</p>
                        </div>
                    </div>
                    <div class="card summary-card">
                        <div class="icon-wrapper"><i class="fas fa-sign-in-alt"></i></div>
                        <div class="text-content">
                            <h3>Check-ins Today</h3>
                            <p>{{ check_ins_today_count }}</p>
                        </div>
                    </div>
                    <div class="card summary-card">
                        <div class="icon-wrapper"><i class="fas fa-sign-out-alt"></i></div>
                        <div class="text-content">
                            <h3>Check-outs Today</h3>
                            <p>{{ check_outs_today_count }}</p>
                        </div>
                    </div>
                    <div class="card summary-card">
                        <div class="icon-wrapper"><i class="fas fa-concierge-bell"></i></div>
                        <div class="text-content">
                            <h3>Total Requests</h3>
                            <p>{{ total_requests_count }}</p>
                        </div>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>Reservations (Last 7 Days)</h3>
                        <svg id="reservationsChart" class="chart-placeholder"></svg>
                    </div>
                    <div class="chart-container">
                        <h3>Bookings by Platform</h3>
                        <svg id="bookingPlatformChart" class="chart-placeholder"></svg>
                    </div>
                </div>

            {% elif current_main_tab == 'requests' %}
                <div class="request-tabs">
                    <button class="tab-button {% if current_sub_tab == 'active' %}active{% endif %}" onclick="location.href='{% url 'main:active_requests' %}'">Active Requests</button>
                    <button class="tab-button {% if current_sub_tab == 'archive' %}active{% endif %}" onclick="location.href='{% url 'main:archive_requests' %}'">Archive</button>
                    <button class="tab-button {% if current_sub_tab == 'all' %}active{% endif %}" onclick="location.href='{% url 'main:all_requests' %}'">All Requests</button>
                </div>

                {% if has_any_requests %}
                    {% for category in grouped_requests %}
                        <div class="request-category">
                            <h3>{{ category.display_name }} ({{ category.requests|length }})</h3>
                            <div class="request-list">
                                {% for item in category.requests %}
                                    <div class="request-item" data-request-id="{{ item.request.id }}">
                                        <div>
                                            <p><strong>Room:</strong> {{ item.request.room_number }}</p>
                                            <p><strong>Guest:</strong> {{ item.assignment.guest_names|default:"N/A" }}</p>
                                            <p><strong>Request:</strong> {{ item.request.raw_text|truncatechars:70 }}</p>
                                            {% if item.request.request_type == 'amenity_request' and item.request.amenity_requested %}
                                                <p><strong>Amenity:</strong> {{ item.request.amenity_requested.name }} (x{{ item.request.amenity_quantity }})</p>
                                                <p><strong>Cost:</strong> ${{ item.request.amenity_requested.price|floatformat:2 }} each</p>
                                            {% endif %}
                                            <p><strong>Status:</strong> <span class="status-badge {{ item.request.status }}">{{ item.request.get_status_display }}</span></p>
                                        </div>
                                        <div class="request-actions">
                                            <button class="view-details" data-request-id="{{ item.request.id }}">View Details</button>
                                            {% if item.request.status == 'pending' %}
                                                <button class="update-status" data-request-id="{{ item.request.id }}" data-new-status="in_progress">Mark In Progress</button>
                                            {% elif item.request.status == 'in_progress' %}
                                                <button class="update-status" data-request-id="{{ item.request.id }}" data-new-status="completed">Mark Completed</button>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>No requests found for this category.</p>
                {% endif %}


            {% elif current_main_tab == 'guest_management' %}
                <div class="guest-management-section">
                    <button id="addAssignmentButton" class="button-primary" style="margin-bottom: 20px;">Add New Guest Assignment</button>

                    <!-- Filter Form -->
                    <div class="filter-card card" style="margin-bottom: 20px;">
                        <h3>Filter Assignments</h3>
                        <form id="filterForm" method="GET" action="{% url 'main:guest_management' %}">
                            <div class="form-group">
                                <label for="room_number_filter">Room Number:</label>
                                <input type="text" id="room_number_filter" name="room_number" value="{{ filter_params.room_number|default:'' }}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="guest_names_filter">Guest Names:</label>
                                <input type="text" id="guest_names_filter" name="guest_names" value="{{ filter_params.guest_names|default:'' }}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="status_filter">Status:</label>
                                <select id="status_filter" name="status" class="form-control">
                                    <option value="">All</option>
                                    {% for value, label in assignment_status_choices %}
                                        <option value="{{ value }}" {% if filter_params.status == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="check_in_date_from_filter">Check-in Date From:</label>
                                <input type="date" id="check_in_date_from_filter" name="check_in_date_from" value="{{ filter_params.check_in_date_from|default:'' }}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="check_in_date_to_filter">Check-in Date To:</label>
                                <input type="date" id="check_in_date_to_filter" name="check_in_date_to" value="{{ filter_params.check_in_date_to|default:'' }}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="check_out_date_from_filter">Check-out Date From:</label>
                                <input type="date" id="check_out_date_from_filter" name="check_out_date_from" value="{{ filter_params.check_out_date_from|default:'' }}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="check_out_date_to_filter">Check-out Date To:</label>
                                <input type="date" id="check_out_date_to_to_filter" name="check_out_date_to" value="{{ filter_params.check_out_date_to|default:'' }}" class="form-control">
                            </div>
                            <button type="submit" class="button-primary">Apply Filters</button>
                            <button type="button" class="button-secondary" onclick="window.location.href='{% url 'main:guest_management' %}'">Clear Filters</button>
                        </form>
                    </div>


                    <h3>All Guest Assignments</h3>
                    {% if all_assignments %}
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Room No.</th>
                                        <th>Guest Names</th>
                                        <th>Check-in</th>
                                        <th>Check-out</th>
                                        <th>Status</th>
                                        <th>Total Bill</th>
                                        <th>Amount Paid</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for assignment in all_assignments %}
                                        <tr>
                                            <td>{{ assignment.room_number }}</td>
                                            <td>{{ assignment.guest_names }}</td>
                                            <td>{{ assignment.check_in_time|date:"M d, Y H:i" }}</td>
                                            <td>{{ assignment.check_out_time|date:"M d, Y H:i" }}</td>
                                            <td><span class="status-badge {{ assignment.status }}">{{ assignment.get_status_display }}</span></td>
                                            <td>${{ assignment.total_bill_amount|floatformat:2 }}</td>
                                            <td>${{ assignment.amount_paid|floatformat:2 }}</td>
                                            <td>
                                                <button class="edit-assignment-button" data-assignment-id="{{ assignment.id }}">Edit</button>
                                                <button class="delete-assignment-button" data-assignment-id="{{ assignment.id }}">Delete</button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p>No guest assignments found.</p>
                    {% endif %}
                </div>

            {% elif current_main_tab == 'amenities' %}
                <div class="amenity-management-section">
                    <button id="addAmenityButton" class="button-primary" style="margin-bottom: 20px;">Add New Amenity</button>

                    <h3>Current Amenities</h3>
                    {% if amenities %}
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Price</th>
                                        <th>Available</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for amenity in amenities %}
                                        <tr>
                                            <td>{{ amenity.name }}</td>
                                            <td>{{ amenity.description|default:"-" }}</td>
                                            <td>${{ amenity.price|floatformat:2 }}</td>
                                            <td>
                                                {% if amenity.is_available %}
                                                    <i class="fas fa-check-circle" style="color: var(--status-success-text);"></i> Yes
                                                {% else %}
                                                    <i class="fas fa-times-circle" style="color: var(--status-error-text);"></i> No
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button class="edit-amenity-button" data-amenity-id="{{ amenity.id }}">Edit</button>
                                                <button class="delete-amenity-button" data-amenity-id="{{ amenity.id }}">Delete</button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p>No amenities found.</p>
                    {% endif %}
                </div>
            {% endif %}
        </main>
    </div>

    <!-- Add/Edit Guest Assignment Modal -->
    <div id="assignmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="assignmentModalTitle">Add New Guest Assignment</h2>
                <span class="close-button">&times;</span>
            </div>
            <form id="assignmentForm" class="modal-body">
                {% csrf_token %}
                <input type="hidden" id="assignmentId" name="assignment_id">

                <!-- Room Number Input -->
                <div class="form-group">
                    <label for="{{ form.room_number_input.id_for_label }}">{{ form.room_number_input.label }}:</label>
                    {{ form.room_number_input }}
                    <div id="roomNumberInputErrors" class="error-message"></div>
                </div>

                <!-- Guest Names -->
                <div class="form-group">
                    <label for="{{ form.guest_names.id_for_label }}">{{ form.guest_names.label }}:</label>
                    {{ form.guest_names }}
                    <div id="guestNamesErrors" class="error-message"></div>
                </div>

                <!-- Check-in Date and Time -->
                <div class="datetime-group">
                    <div class="form-group">
                        <label for="{{ form.check_in_date.id_for_label }}">{{ form.check_in_date.label }}:</label>
                        {{ form.check_in_date }}
                        <div id="checkInDateErrors" class="error-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="{{ form.check_in_time_input.id_for_label }}">{{ form.check_in_time_input.label }}:</label>
                        {{ form.check_in_time_input }}
                        <div id="checkInTimeInputErrors" class="error-message"></div>
                    </div>
                </div>

                <!-- Check-out Date and Time -->
                <div class="datetime-group">
                    <div class="form-group">
                        <label for="{{ form.check_out_date.id_for_label }}">{{ form.check_out_date.label }}:</label>
                        {{ form.check_out_date }}
                        <div id="checkOutDateErrors" class="error-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="{{ form.check_out_time_input.id_for_label }}">{{ form.check_out_time_input.label }}:</label>
                        {{ form.check_out_time_input }}
                        <div id="checkOutTimeInputErrors" class="error-message"></div>
                    </div>
                </div>

                <!-- Total Bill Amount -->
                <div class="form-group">
                    <label for="{{ form.total_bill_amount.id_for_label }}">{{ form.total_bill_amount.label }}:</label>
                    {{ form.total_bill_amount }}
                    <div id="totalBillAmountErrors" class="error-message"></div>
                </div>

                <!-- Amount Paid - Explicitly setting label text -->
                <div class="form-group">
                    <label for="{{ form.amount_paid.id_for_label }}">Amount Paid:</label> {# Explicitly set label text #}
                    {{ form.amount_paid }}
                    <div id="amountPaidErrors" class="error-message"></div>
                </div>

                <!-- Status -->
                <div class="form-group">
                    <label for="{{ form.status.id_for_label }}">{{ form.status.label }}:</label>
                    {{ form.status }}
                    <div id="statusErrors" class="error-message"></div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="save-button">Add Assignment</button>
                    <button type="button" class="cancel-button">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Request Details Modal -->
    <div id="requestDetailsModal" class="modal request-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Request Details</h2>
                <span class="close-button" id="closeRequestDetailsModalButton">&times;</span>
            </div>
            <div class="modal-body">
                <div class="detail-row"><strong>Room:</strong> <span id="detailRoomNumber"></span></div>
                <div class="detail-row"><strong>Guest:</strong> <span id="detailGuestNames"></span></div>
                <div class="detail-row"><strong>Status:</strong> <span id="detailStatus"></span></div>
                <div class="detail-row"><strong>Type:</strong> <span id="detailRequestType"></span></div>
                <div class="detail-row"><strong>Timestamp:</strong> <span id="detailTimestamp"></span></div>
                <div class="detail-row"><strong>Raw Text:</strong> <span id="detailRawText"></span></div>
                <div class="detail-row"><strong>Conci Response:</strong> <span id="detailConciResponse"></span></div>
                <div class="detail-row"><strong>AI Intent:</strong> <span id="detailAiIntent"></span></div>
                <div class="detail-row"><strong>AI Entities:</strong> <span id="detailAiEntities"></span></div>
                <div class="detail-row"><strong>Staff Notes:</strong> <span id="detailStaffNotes"></span></div>
                <div id="amenityDetailsSection" style="display:none;">
                    <div class="detail-row"><strong>Amenity Name:</strong> <span id="detailAmenityName"></span></div>
                    <div class="detail-row"><strong>Amenity Quantity:</strong> <span id="detailAmenityQuantity"></span></div>
                    <div class="detail-row"><strong>Price per Unit:</strong> <span id="detailPricePerUnit"></span></div>
                    <div class="detail-row"><strong>Total Amenity Cost:</strong> <span id="detailTotalAmenityCost"></span></div>
                    <div class="detail-row"><strong>Bill Added:</strong> <span id="detailBillAdded"></span></div>
                </div>
                <div class="chat-history-section">
                    <h4>Conversation History</h4>
                    <div class="chat-messages" id="detailChatHistory">
                        <!-- Chat messages will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="cancel-button" id="closeRequestDetailsModalButtonFooter">Close</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Amenity Modal -->
    <div id="amenityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="amenityModalTitle">Add New Amenity</h2>
                <span class="close-button">&times;</span>
            </div>
            <form id="amenityForm" class="modal-body">
                {% csrf_token %}
                <input type="hidden" id="amenityId" name="amenity_id">

                <div class="form-group">
                    <label for="id_name">Name:</label>
                    <input type="text" id="id_name" name="name" class="form-control" required>
                    <div id="amenityNameErrors" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="id_description">Description:</label>
                    <textarea id="id_description" name="description" class="form-control" rows="3"></textarea>
                    <div id="amenityDescriptionErrors" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="id_price">Price:</label>
                    <input type="number" step="0.01" id="id_price" name="price" class="form-control" required>
                    <div id="amenityPriceErrors" class="error-message"></div>
                </div>
                <div class="form-group form-check">
                    <input type="checkbox" id="id_is_available" name="is_available" class="form-check-input">
                    <label class="form-check-label" for="id_is_available">Is Available</label>
                    <div id="amenityIsAvailableErrors" class="error-message"></div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="save-button">Save Amenity</button>
                    <button type="button" class="cancel-button">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Confirmation Modal for Status Updates -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="confirmationModalTitle">Confirm Action</h2>
                <span class="close-button confirmation-close-button">&times;</span>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="button-secondary confirmation-cancel-button">No</button>
                <button type="button" class="button-primary" id="confirmationYesButton">Yes</button>
            </div>
        </div>
    </div>


    <div id="messageBox"></div>

    <script>
        // Global utility function to show messages
        function showMessage(message, type) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = ''; // Clear existing classes
            messageBox.classList.add('show', type);
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000); // Hide after 3 seconds
        }

        // Theme Toggle Logic
        const themeToggleButton = document.getElementById('themeToggleButton');
        const htmlElement = document.documentElement;

        // Function to set the theme based on localStorage or default
        function setInitialTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            htmlElement.setAttribute('data-theme', savedTheme);
            updateThemeToggleButton(savedTheme);
        }

        // Function to update the theme toggle button icon
        function updateThemeToggleButton(theme) {
            const icon = themeToggleButton.querySelector('i');
            if (theme === 'dark') {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        }

        // Event listener for theme toggle button
        themeToggleButton.addEventListener('click', () => {
            let currentTheme = htmlElement.getAttribute('data-theme');
            let newTheme = currentTheme === 'light' ? 'dark' : 'light';
            htmlElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeToggleButton(newTheme);
        });

        // Set initial theme on page load
        document.addEventListener('DOMContentLoaded', setInitialTheme);


        // Sidebar Toggle Logic
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarToggleIcon = sidebarToggle.querySelector('i');

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('sidebar-collapsed');
            if (sidebar.classList.contains('collapsed')) {
                sidebarToggleIcon.classList.remove('fa-chevron-left');
                sidebarToggleIcon.classList.add('fa-chevron-right');
            } else {
                sidebarToggleIcon.classList.remove('fa-chevron-right');
                sidebarToggleIcon.classList.add('fa-chevron-left');
            }
        });


        // Notification Bell Logic
        const notificationBell = document.getElementById('notificationBell');
        const notificationBadge = document.getElementById('notificationBadge');
        let lastCheckTimestamp = new Date().toISOString(); // Initialize with current time

        async function fetchNewRequests() {
            try {
                const response = await fetch(`/api/check_new_requests/?last_check=${encodeURIComponent(lastCheckTimestamp)}`);
                const data = await response.json();

                if (data.success) {
                    notificationBadge.textContent = data.new_requests_count;
                    if (data.new_requests_count > 0) {
                        notificationBadge.style.display = 'block'; // Show badge
                    } else {
                        notificationBadge.style.display = 'none'; // Hide badge
                    }
                    lastCheckTimestamp = data.current_timestamp; // Update timestamp for next check
                } else {
                    console.error('Failed to fetch new requests:', data.error);
                }
            } catch (error) {
                console.error('Network error fetching new requests:', error);
            }
        }

        // Fetch new requests every 30 seconds
        setInterval(fetchNewRequests, 30000);
        fetchNewRequests(); // Initial fetch on page load

        // D3.js Chart for Reservations (Last 7 Days)
        {% if current_main_tab == 'home' %}
            const reservationsData = {{ reservations_chart_data|safe }};
            const bookingPlatformData = {{ booking_platform_data|safe }};

            function drawReservationsChart() {
                const svg = d3.select("#reservationsChart");
                const margin = {top: 20, right: 30, bottom: 40, left: 40};
                const width = parseFloat(svg.style("width")) - margin.left - margin.right;
                const height = parseFloat(svg.style("height")) - margin.top - margin.bottom;

                svg.selectAll("*").remove(); // Clear previous chart

                const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                const x = d3.scaleBand()
                    .domain(reservationsData.map(d => d.date))
                    .range([0, width])
                    .padding(0.2);

                const y = d3.scaleLinear()
                    .domain([0, d3.max(reservationsData, d => Math.max(d.booked, d.cancelled)) + 5])
                    .range([height, 0]);

                g.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x).tickSizeOuter(0))
                    .selectAll("text")
                    .style("fill", "var(--chart-axis-text)");

                g.append("g")
                    .call(d3.axisLeft(y).tickSizeOuter(0))
                    .selectAll("text")
                    .style("fill", "var(--chart-axis-text)");

                // Add grid lines
                g.append("g")
                    .attr("class", "grid")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x)
                        .tickSize(-height)
                        .tickFormat("")
                    )
                    .select(".domain").remove();

                g.append("g")
                    .attr("class", "grid")
                    .call(d3.axisLeft(y)
                        .tickSize(-width)
                        .tickFormat("")
                    )
                    .select(".domain").remove();

                // Booked bars
                g.selectAll(".bar-booked")
                    .data(reservationsData)
                    .enter().append("rect")
                    .attr("class", "bar-booked")
                    .attr("x", d => x(d.date))
                    .attr("y", d => y(d.booked))
                    .attr("width", x.bandwidth() / 2)
                    .attr("height", d => height - y(d.booked))
                    .attr("fill", "var(--chart-color-booked)");

                // Cancelled bars
                g.selectAll(".bar-cancelled")
                    .data(reservationsData)
                    .enter().append("rect")
                    .attr("class", "bar-cancelled")
                    .attr("x", d => x(d.date) + x.bandwidth() / 2)
                    .attr("y", d => y(d.cancelled))
                    .attr("width", x.bandwidth() / 2)
                    .attr("height", d => height - y(d.cancelled))
                    .attr("fill", "var(--chart-color-cancelled)");
            }

            function drawBookingPlatformChart() {
                const svg = d3.select("#bookingPlatformChart");
                const width = parseFloat(svg.style("width"));
                const height = parseFloat(svg.style("height"));
                const radius = Math.min(width, height) / 2 - 20;

                svg.selectAll("*").remove(); // Clear previous chart

                const g = svg.append("g")
                    .attr("transform", `translate(${width / 2},${height / 2})`);

                const color = d3.scaleOrdinal()
                    .range([
                        "var(--chart-color-platform1)",
                        "var(--chart-color-platform2)",
                        "var(--chart-color-platform3)",
                        "var(--chart-color-platform4)",
                        "var(--chart-color-platform5)",
                        "var(--chart-color-platform6)"
                    ]);

                const pie = d3.pie()
                    .value(d => d.value);

                const path = d3.arc()
                    .outerRadius(radius - 10)
                    .innerRadius(0);

                const label = d3.arc()
                    .outerRadius(radius)
                    .innerRadius(radius - 80);

                const arc = g.selectAll(".arc")
                    .data(pie(bookingPlatformData))
                    .enter().append("g")
                    .attr("class", "arc");

                arc.append("path")
                    .attr("d", path)
                    .attr("fill", d => color(d.data.platform));

                arc.append("text")
                    .attr("transform", d => `translate(${label.centroid(d)})`)
                    .attr("text-anchor", "middle")
                    .text(d => `${d.data.platform} (${d.data.value}%)`)
                    .style("fill", "var(--text)")
                    .style("font-size", "0.8em");
            }

            // Initial chart drawing
            window.addEventListener('load', () => {
                drawReservationsChart();
                drawBookingPlatformChart();
            });

            // Redraw charts on window resize
            window.addEventListener('resize', () => {
                drawReservationsChart();
                drawBookingPlatformChart();
            });
        {% endif %}

        // Request Details Modal Logic
        const requestDetailsModal = document.getElementById('requestDetailsModal');
        const closeRequestDetailsModalButton = document.getElementById('closeRequestDetailsModalButton');
        const closeRequestDetailsModalButtonFooter = document.getElementById('closeRequestDetailsModalButtonFooter');
        const viewDetailsButtons = document.querySelectorAll('.view-details');

        viewDetailsButtons.forEach(button => {
            button.addEventListener('click', async () => {
                const requestId = button.dataset.requestId;
                try {
                    const response = await fetch(`/api/requests/${requestId}/details/`);
                    const result = await response.json();

                    if (result.success) {
                        document.getElementById('detailRoomNumber').textContent = result.room_number;
                        document.getElementById('detailGuestNames').textContent = result.guest_names;
                        document.getElementById('detailStatus').textContent = result.status;
                        document.getElementById('detailRequestType').textContent = result.request_type;
                        document.getElementById('detailTimestamp').textContent = new Date(result.timestamp).toLocaleString();
                        document.getElementById('detailRawText').textContent = result.raw_text;
                        document.getElementById('detailConciResponse').textContent = result.conci_response_text;
                        document.getElementById('detailAiIntent').textContent = result.ai_intent;
                        document.getElementById('detailAiEntities').textContent = JSON.stringify(result.ai_entities, null, 2);
                        document.getElementById('detailStaffNotes').textContent = result.staff_notes;

                        // Amenity details section
                        const amenityDetailsSection = document.getElementById('amenityDetailsSection');
                        if (result.amenity_details) {
                            amenityDetailsSection.style.display = 'block';
                            document.getElementById('detailAmenityName').textContent = result.amenity_details.name;
                            document.getElementById('detailAmenityQuantity').textContent = result.amenity_details.quantity;
                            document.getElementById('detailPricePerUnit').textContent = `$${result.amenity_details.price_per_unit.toFixed(2)}`;
                            document.getElementById('detailTotalAmenityCost').textContent = `$${result.amenity_details.total_amenity_cost.toFixed(2)}`;
                            document.getElementById('detailBillAdded').textContent = result.amenity_details.bill_added ? 'Yes' : 'No';
                        } else {
                            amenityDetailsSection.style.display = 'none';
                        }


                        const detailChatHistory = document.getElementById('detailChatHistory');
                        detailChatHistory.innerHTML = ''; // Clear previous history
                        if (result.chat_history && result.chat_history.length > 0) {
                            result.chat_history.forEach(message => {
                                const msgDiv = document.createElement('div');
                                msgDiv.classList.add('chat-message', message.role);
                                msgDiv.innerHTML = `<strong>${message.role === 'user' ? 'Guest' : 'Conci'}:</strong> ${message.parts[0].text}`;
                                detailChatHistory.appendChild(msgDiv);
                            });
                        } else {
                            detailChatHistory.innerHTML = '<p>No detailed conversation history available.</p>';
                        }

                        requestDetailsModal.classList.add('show'); // Show the modal
                    } else {
                        console.error('Backend reported error for Request Details:', result.error);
                        showMessage(result.error || 'Failed to load request details.', 'error');
                    }
                }
                catch (error) {
                    console.error('Error fetching request details:', error);
                    showMessage('Network error or server issue fetching request details.', 'error');
                }
            });
        });

        // Close Request Details Modal
        if (closeRequestDetailsModalButton) {
            closeRequestDetailsModalButton.addEventListener('click', () => {
                requestDetailsModal.classList.remove('show');
            });
        }
        if (closeRequestDetailsModalButtonFooter) {
            closeRequestDetailsModalButtonFooter.addEventListener('click', () => {
                requestDetailsModal.classList.remove('show');
            });
        }

        // Custom Confirmation Modal Logic for Status Updates
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmationYesButton = document.getElementById('confirmationYesButton');
        const confirmationCloseButtons = confirmationModal.querySelectorAll('.confirmation-close-button, .confirmation-cancel-button');

        let currentRequestId = null;
        let currentNewStatus = null;

        // Function to show the custom confirmation modal
        function showConfirmationModal(message, requestId, newStatus) {
            confirmationMessage.textContent = message;
            currentRequestId = requestId;
            currentNewStatus = newStatus;
            confirmationModal.classList.add('show');
        }

        // Event listener for the "Yes" button in the custom confirmation modal
        confirmationYesButton.addEventListener('click', async () => {
            confirmationModal.classList.remove('show'); // Hide modal immediately

            // Determine which action to take based on currentNewStatus (which now holds the action type)
            if (currentNewStatus === 'delete_assignment') {
                try {
                    const response = await fetch(`/api/assignments/${currentRequestId}/delete/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    });
                    const result = await response.json();
                    if (result.success) {
                        showMessage('Assignment deleted successfully!', 'success');
                        const deletedRow = document.querySelector(`.data-table tbody tr [data-assignment-id="${currentRequestId}"]`).closest('tr');
                        if (deletedRow) {
                            deletedRow.remove();
                        }
                    } else {
                        showMessage(result.error || 'Failed to delete assignment.', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting assignment:', error);
                    showMessage('Network error or server issue deleting assignment.', 'error');
                }
            } else if (currentNewStatus === 'delete_amenity') {
                try {
                    const response = await fetch(`/api/amenities/${currentRequestId}/delete/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    });
                    const result = await response.json();
                    if (result.success) {
                        showMessage('Amenity deleted successfully!', 'success');
                        const deletedRow = document.querySelector(`.data-table tbody tr [data-amenity-id="${currentRequestId}"]`).closest('tr');
                        if (deletedRow) {
                            deletedRow.remove();
                        }
                    } else {
                        showMessage(result.error || 'Failed to delete amenity.', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting amenity:', error);
                    showMessage('Network error or server issue deleting amenity.', 'error');
                }
            } else {
                // This is the original status update logic for Guest Requests
                try {
                    const response = await fetch(`/request/${currentRequestId}/update_status/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: `new_status=${currentNewStatus}`
                    });
                    const result = await response.json();
                    if (result.success) {
                        showMessage('Status updated successfully!', 'success');
                        const requestItem = document.querySelector(`.request-item[data-request-id="${currentRequestId}"]`);
                        if (requestItem) {
                            const statusBadge = requestItem.querySelector('.status-badge');
                            if (statusBadge) {
                                statusBadge.classList.remove('pending', 'in_progress', 'completed', 'cancelled', 'casual_chat', 'general_inquiry');
                                statusBadge.classList.add(currentNewStatus);
                                statusBadge.textContent = currentNewStatus.replace(/_/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

                                const clickedButton = requestItem.querySelector(`button[data-request-id="${currentRequestId}"][data-new-status="${currentNewStatus}"]`);
                                if (clickedButton) {
                                    clickedButton.style.display = 'none';
                                    if (currentNewStatus === 'in_progress') {
                                        const markCompletedButton = requestItem.querySelector(`button[data-new-status="completed"]`);
                                        if (markCompletedButton) markCompletedButton.style.display = 'inline-block';
                                    } else if (currentNewStatus === 'completed') {
                                        requestItem.querySelectorAll('.update-status').forEach(btn => btn.style.display = 'none');
                                    }
                                }
                            }
                        }
                    } else {
                        showMessage(result.error || 'Failed to update status.', 'error');
                    }
                } catch (error) {
                    console.error('Error updating status:', error);
                    showMessage('Network error or server issue updating status.', 'error');
                }
            }
        });

        // Event listeners to close the custom confirmation modal
        confirmationCloseButtons.forEach(button => {
            button.addEventListener('click', () => {
                confirmationModal.classList.remove('show');
            });
        });

        // Update Request Status Logic (now uses custom confirmation modal)
        document.querySelectorAll('.update-status').forEach(button => {
            button.addEventListener('click', () => {
                const requestId = button.dataset.requestId;
                const newStatus = button.dataset.newStatus;
                const statusDisplayName = newStatus.replace(/_/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                showConfirmationModal(`Are you sure you want to change status to "${statusDisplayName}"?`, requestId, newStatus);
            });
        });

        // Add/Edit Guest Assignment Modal Logic
        const assignmentModal = document.getElementById('assignmentModal');
        const addAssignmentButton = document.getElementById('addAssignmentButton');
        const assignmentForm = document.getElementById('assignmentForm');
        const closeAssignmentModalButtons = assignmentModal.querySelectorAll('.close-button, .cancel-button');
        const assignmentModalTitle = document.getElementById('assignmentModalTitle');

        // Function to clear form errors
        function clearFormErrors() {
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
        }

        // Open Add Assignment Modal
        if (addAssignmentButton) {
            addAssignmentButton.addEventListener('click', () => {
                assignmentModalTitle.textContent = 'Add New Guest Assignment';
                assignmentForm.reset(); // Clear form fields
                document.getElementById('assignmentId').value = ''; // Clear hidden ID
                clearFormErrors();
                assignmentModal.classList.add('show');
            });
        }

        // Open Edit Assignment Modal
        document.querySelectorAll('.edit-assignment-button').forEach(button => {
            button.addEventListener('click', async () => {
                const assignmentId = button.dataset.assignmentId;
                assignmentModalTitle.textContent = 'Edit Guest Assignment';
                assignmentForm.reset(); // Clear form fields
                document.getElementById('assignmentId').value = assignmentId; // Set hidden ID
                clearFormErrors();

                try {
                    const response = await fetch(`/api/assignments/${assignmentId}/edit/`); // Assuming GET request for initial data
                    const data = await response.json();
                    if (data.success) {
                        // Populate form fields with existing data
                        if (data.assignment.check_in_time) {
                            const checkInDateTime = new Date(data.assignment.check_in_time);
                            assignmentForm.querySelector('[name="check_in_date"]').value = checkInDateTime.toISOString().split('T')[0];
                            assignmentForm.querySelector('[name="check_in_time_input"]').value = checkInDateTime.toTimeString().slice(0, 5);
                        }
                        if (data.assignment.check_out_time) {
                            const checkOutDateTime = new Date(data.assignment.check_out_time);
                            assignmentForm.querySelector('[name="check_out_date"]').value = checkOutDateTime.toISOString().split('T')[0];
                            assignmentForm.querySelector('[name="check_out_time_input"]').value = checkOutDateTime.toTimeString().slice(0, 5);
                        }
                        
                        if (data.assignment.room_number && data.assignment.room_number.room_number) {
                            assignmentForm.querySelector('[name="room_number_input"]').value = data.assignment.room_number.room_number;
                        }

                        assignmentForm.querySelector('[name="guest_names"]').value = data.assignment.guest_names;
                        assignmentForm.querySelector('[name="status"]').value = data.assignment.status;
                        assignmentForm.querySelector('[name="total_bill_amount"]').value = data.assignment.total_bill_amount;
                        assignmentForm.querySelector('[name="amount_paid"]').value = data.assignment.amount_paid;


                        assignmentModal.classList.add('show');
                    } else {
                        showMessage(data.error || 'Failed to load assignment details.', 'error');
                    }
                } catch (error) {
                    console.error('Error fetching assignment details:', error);
                    showMessage('Network error or server issue fetching assignment details.', 'error');
                }
            });
        });


        // Close Assignment Modal
        closeAssignmentModalButtons.forEach(button => {
            button.addEventListener('click', () => {
                assignmentModal.classList.remove('show');
                clearFormErrors();
            });
        });

        // Submit Assignment Form
        assignmentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearFormErrors();

            const formData = new FormData(assignmentForm);
            const assignmentId = document.getElementById('assignmentId').value;
            const url = assignmentId ? `/api/assignments/${assignmentId}/edit/` : `/dashboard/guests/`;
            const method = assignmentId ? 'POST' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(result.message, 'success');
                    assignmentModal.classList.remove('show');
                    location.reload();
                } else {
                    // Display general error message first if available
                    let generalErrorMessage = result.error || 'Failed to save assignment due to validation errors.';
                    showMessage(generalErrorMessage, 'error');

                    if (result.errors) {
                        const errors = JSON.parse(result.errors);
                        for (const field in errors) {
                            const errorDiv = document.getElementById(`${field}Errors`);
                            if (errorDiv) {
                                errorDiv.textContent = errors[field][0].message;
                            } else if (field === '__all__') {
                                // For non-field errors, append to the general message or show separately
                                showMessage(`${generalErrorMessage} (Details: ${errors[field][0].message})`, 'error');
                            } else {
                                // Fallback for any other unexpected field errors
                                console.error(`Unhandled form error for field ${field}:`, errors[field][0].message);
                                showMessage(`Error in ${field}: ${errors[field][0].message}`, 'error');
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error submitting assignment form:', error);
                showMessage('Network error or server issue saving assignment.', 'error');
            }
        });

        // Add/Edit Amenity Modal Logic
        const amenityModal = document.getElementById('amenityModal');
        const addAmenityButton = document.getElementById('addAmenityButton');
        const amenityForm = document.getElementById('amenityForm');
        const closeAmenityModalButtons = amenityModal.querySelectorAll('.close-button, .cancel-button');
        const amenityModalTitle = document.getElementById('amenityModalTitle');

        // Function to clear amenity form errors
        function clearAmenityFormErrors() {
            document.querySelectorAll('#amenityForm .error-message').forEach(el => el.textContent = '');
        }

        // Open Add Amenity Modal
        if (addAmenityButton) {
            addAmenityButton.addEventListener('click', () => {
                amenityModalTitle.textContent = 'Add New Amenity';
                amenityForm.reset();
                document.getElementById('amenityId').value = '';
                clearAmenityFormErrors();
                amenityModal.classList.add('show');
            });
        }

        // Open Edit Amenity Modal
        document.querySelectorAll('.edit-amenity-button').forEach(button => {
            button.addEventListener('click', async () => {
                const amenityId = button.dataset.amenityId;
                amenityModalTitle.textContent = 'Edit Amenity';
                amenityForm.reset();
                document.getElementById('amenityId').value = amenityId;
                clearAmenityFormErrors();

                try {
                    const response = await fetch(`/api/amenities/${amenityId}/`);
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('id_name').value = data.name;
                        document.getElementById('id_description').value = data.description;
                        document.getElementById('id_price').value = data.price;
                        document.getElementById('id_is_available').checked = data.is_available;
                        amenityModal.classList.add('show');
                    } else {
                        showMessage(data.error || 'Failed to load amenity details.', 'error');
                    }
                } catch (error) {
                    console.error('Error fetching amenity details:', error);
                    showMessage('Network error or server issue fetching amenity details.', 'error');
                }
            });
        });

        // Close Amenity Modal
        closeAmenityModalButtons.forEach(button => {
            button.addEventListener('click', () => {
                amenityModal.classList.remove('show');
                clearAmenityFormErrors();
            });
        });

        // Submit Amenity Form
        amenityForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearAmenityFormErrors();

            const formData = new FormData(amenityForm);
            const amenityId = document.getElementById('amenityId').value;
            const url = amenityId ? `/amenities/${amenityId}/` : `/amenities/`;
            const method = 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(result.message, 'success');
                    amenityModal.classList.remove('show');
                    location.reload();
                } else {
                    showMessage(result.error || 'Failed to save amenity.', 'error');
                    if (result.errors) {
                        const errors = JSON.parse(result.errors);
                        for (const field in errors) {
                            const errorDiv = document.getElementById(`amenity${field.charAt(0).toUpperCase() + field.slice(1)}Errors`);
                            if (errorDiv) {
                                errorDiv.textContent = errors[field][0].message;
                            } else {
                                showMessage(errors[field][0].message, 'error');
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error submitting amenity form:', error);
                showMessage('Network error or server issue saving amenity.', 'error');
            }
        });

        // Delete Assignment Logic
        document.querySelectorAll('.delete-assignment-button').forEach(button => {
            button.addEventListener('click', async () => {
                const assignmentId = button.dataset.assignmentId;
                showConfirmationModal('Are you sure you want to delete this guest assignment?', assignmentId, 'delete_assignment');
            });
        });

        // Delete Amenity Logic
        document.querySelectorAll('.delete-amenity-button').forEach(button => {
            button.addEventListener('click', async () => {
                const amenityId = button.dataset.amenityId;
                showConfirmationModal('Are you sure you want to delete this amenity? This cannot be undone.', amenityId, 'delete_amenity');
            });
        });

    </script>
</body>
</html>
