<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conci Guest Interface - Room {{ room_number }}</title>
    <!-- Google Fonts - Inter for a modern, clean look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f3f4f6; /* Light gray background */
            padding: 1rem; /* Padding around the content */
            margin: 0;
            box-sizing: border-box; /* Include padding in element's total width and height */
        }
        .card {
            background-color: #ffffff; /* White background for the card */
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Soft shadow */
            padding: 2rem; /* Inner padding */
            max-width: 28rem; /* Max width for responsiveness */
            width: 100%; /* Full width on smaller screens */
            text-align: center;
        }
        .title {
            font-size: 1.875rem; /* Large title font size */
            font-weight: 700; /* Bold font */
            color: #1f2937; /* Dark gray text */
            margin-bottom: 0.5rem; /* Space below title */
        }
        .subtitle {
            font-size: 1.125rem; /* Subtitle font size */
            color: #4b5563; /* Medium gray text */
            margin-bottom: 1.5rem; /* Space below subtitle */
        }
        .sun-icon {
            color: #f59e0b; /* Yellow color for sun icon */
            font-size: 3.75rem; /* Large icon size */
            margin-bottom: 2rem; /* Space below icon */
            display: block; /* Ensures it's centered if parent is text-align: center */
        }
        .input-group {
            display: flex;
            gap: 0.75rem; /* Space between input and buttons */
            margin-bottom: 1rem; /* Space below input group */
        }
        .input-group input {
            flex-grow: 1; /* Input takes available space */
            padding: 0.75rem; /* Padding inside input */
            border: 1px solid #d1d5db; /* Light gray border */
            border-radius: 0.5rem; /* Rounded corners for input */
            outline: none; /* Remove default outline */
            transition: border-color 0.2s ease, box-shadow 0.2s ease; /* Smooth transition on focus */
        }
        .input-group input:focus {
            border-color: #3b82f6; /* Blue border on focus */
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.5); /* Blue glow on focus */
        }
        .input-group button {
            padding: 0.75rem 1.5rem; /* Padding for buttons */
            border-radius: 0.5rem; /* Rounded corners for buttons */
            font-weight: 600; /* Semi-bold font */
            transition: background-color 0.2s ease, box-shadow 0.2s ease; /* Smooth transition on hover */
            cursor: pointer;
            border: none; /* Remove default button border */
        }
        .input-group .btn-listen {
            background-color: #22c55e; /* Green background */
            color: #ffffff; /* White text */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Shadow */
        }
        .input-group .btn-listen:hover {
            background-color: #16a34a; /* Darker green on hover */
        }
        .input-group .btn-listen.listening {
            background-color: #f59e0b; /* Orange when listening */
        }
        .input-group .btn-send {
            background-color: #2563eb; /* Blue background */
            color: #ffffff; /* White text */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Shadow */
        }
        .input-group .btn-send:hover {
            background-color: #1d4ed8; /* Darker blue on hover */
        }
        .message-box {
            background-color: #f3f4f6; /* Light gray background */
            color: #374151; /* Dark gray text */
            padding: 1rem; /* Padding */
            border-radius: 0.5rem; /* Rounded corners */
            margin-bottom: 1rem; /* Space below */
            font-size: 0.875rem; /* Small font size */
            text-align: left;
        }
        .pending-requests-section {
            text-align: left;
            margin-bottom: 1.5rem; /* Space below */
        }
        .pending-requests-section h3 {
            font-size: 1.125rem; /* Medium title font size */
            font-weight: 600; /* Semi-bold */
            color: #1f2937; /* Dark gray text */
            margin-bottom: 0.5rem; /* Space below heading */
        }
        .pending-requests-section ul {
            list-style: disc; /* Bullet points */
            list-style-position: inside; /* Bullets inside content flow */
            color: #374151; /* Dark gray text */
            padding-left: 0; /* Remove default padding for list */
        }
        .pending-requests-section li {
            margin-bottom: 0.25rem; /* Small space between list items */
        }
        .btn-confirm-all {
            width: 100%; /* Full width button */
            padding: 0.75rem 1.5rem; /* Padding */
            border-radius: 0.5rem; /* Rounded corners */
            font-weight: 600; /* Semi-bold */
            background-color: #9333ea; /* Purple background */
            color: #ffffff; /* White text */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Shadow */
            transition: background-color 0.2s ease, box-shadow 0.2s ease; /* Smooth transition */
            cursor: pointer;
            border: none; /* Remove default button border */
        }
        .btn-confirm-all:hover {
            background-color: #7e22ce; /* Darker purple on hover */
        }

        /* Message Box for Feedback (for success/error notifications) */
        .feedback-message-box {
            position: fixed;
            top: 1rem; /* Distance from top */
            right: 1rem; /* Distance from right */
            background-color: #22c55e; /* Green background */
            color: #ffffff; /* White text */
            padding: 0.75rem 1.5rem; /* Padding */
            border-radius: 0.5rem; /* Rounded corners */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Larger shadow */
            z-index: 50; /* Ensure it's on top */
            display: none; /* Hidden by default */
            opacity: 0; /* Start invisible */
            transform: translateY(-20px); /* Start slightly above */
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; /* Smooth animation */
        }
        .feedback-message-box.error {
            background-color: #ef4444; /* Red background for errors */
        }
        .feedback-message-box.show {
            display: block; /* Show when 'show' class is added */
            opacity: 1; /* Fully visible */
            transform: translateY(0); /* Slide into place */
        }
    </style>
</head>
<body>
    <div class="card">
        <h1 class="title">Welcome to Conci</h1>
        <p class="subtitle">Your intelligent assistant for Hotel{{ hotel.id }} - Room {{ room_number }}</p>
        
        <div class="sun-icon">☀️</div> {# Simple sun icon using emoji #}

        <div class="input-group">
            <input type="text" id="userRequestInput" placeholder="Type your request or click Listen">
            <button id="listenButton" class="btn-listen"><i class="fas fa-microphone"></i> Listen</button>
            <button id="sendButton" class="btn-send">Send</button>
        </div>

        <div id="responseMessageBox" class="message-box">
            <!-- Initial message or latest Conci response -->
            Welcome! How can I assist you today?
        </div>

        <div class="pending-requests-section">
            <h3>Your Pending Requests:</h3>
            <ul id="pendingRequestsList">
                <!-- Pending requests will be dynamically loaded here by JavaScript -->
            </ul>
        </div>

        <button id="confirmSendAllButton" class="btn-confirm-all">Confirm & Send All Requests</button>
    </div>

    <!-- Message Box for Feedback -->
    <div id="feedbackMessageBox" class="feedback-message-box"></div>

    {# Django CSRF token for AJAX POST requests #}
    {% csrf_token %}

    <script>
        const userRequestInput = document.getElementById('userRequestInput');
        const listenButton = document.getElementById('listenButton');
        const sendButton = document.getElementById('sendButton');
        const responseMessageBox = document.getElementById('responseMessageBox');
        const pendingRequestsList = document.getElementById('pendingRequestsList');
        const confirmSendAllButton = document.getElementById('confirmSendAllButton');
        const feedbackMessageBox = document.getElementById('feedbackMessageBox');

        const hotelId = "{{ hotel.id }}";
        const roomNumber = "{{ room_number }}";
        let latestRequestId = "{{ latest_request_id|default:'' }}"; // Used for polling updates
        let localPendingRequests = []; // Stores requests locally before confirming

        // Get CSRF token from the hidden input generated by {% csrf_token %}
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Function to show feedback messages (success/error)
        function showFeedbackMessage(message, type = 'success') {
            feedbackMessageBox.innerHTML = message;
            feedbackMessageBox.className = `feedback-message-box show ${type}`;
            setTimeout(() => {
                feedbackMessageBox.classList.remove('show');
                setTimeout(() => {
                    feedbackMessageBox.style.display = 'none';
                }, 500);
            }, 3000);
        }

        // Function to update the main response message box
        function updateResponseMessage(message, isError = false) {
            responseMessageBox.textContent = message;
            if (isError) {
                responseMessageBox.classList.add('bg-red-100', 'text-red-800');
                responseMessageBox.classList.remove('bg-gray-100', 'text-gray-700');
            } else {
                responseMessageBox.classList.remove('bg-red-100', 'text-red-800');
                responseMessageBox.classList.add('bg-gray-100', 'text-gray-700');
            }
        }

        // Function to render pending requests list from localPendingRequests array
        function renderPendingRequestsList() {
            pendingRequestsList.innerHTML = ''; // Clear existing
            if (localPendingRequests.length > 0) {
                localPendingRequests.forEach(requestText => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `Request: ${requestText}`;
                    pendingRequestsList.appendChild(listItem);
                });
            } else {
                const listItem = document.createElement('li');
                listItem.textContent = 'No pending requests.';
                pendingRequestsList.appendChild(listItem);
            }
        }

        // Initial load of pending requests (if any were in the Django context)
        document.addEventListener('DOMContentLoaded', () => {
            const initialChatHistory = JSON.parse('{{ chat_history|escapejs }}');
            if (initialChatHistory && initialChatHistory.length > 0) {
                // Filter for user messages that represent pending requests
                initialChatHistory.forEach(msg => {
                    if (msg.role === 'user') {
                        localPendingRequests.push(msg.parts[0].text);
                    }
                });
                // Display the latest Conci response in the main message box
                const latestConciResponse = initialChatHistory.slice().reverse().find(msg => msg.role === 'model');
                if (latestConciResponse) {
                    updateResponseMessage(latestConciResponse.parts[0].text);
                } else {
                    updateResponseMessage("Welcome! How can I assist you today?");
                }
            } else {
                updateResponseMessage("Welcome! How can I assist you today?");
            }
            renderPendingRequestsList(); // Render initial state of pending requests
        });

        // "Send" button functionality (adds request to local list)
        sendButton.addEventListener('click', () => {
            const userRequest = userRequestInput.value.trim();
            if (userRequest === '') {
                showFeedbackMessage("Please type your request.", "error");
                return;
            }

            localPendingRequests.push(userRequest);
            renderPendingRequestsList(); // Update the displayed list
            userRequestInput.value = ''; // Clear input
            showFeedbackMessage("Request added to pending list!", "success");
        });

        // "Confirm & Send All Requests" button functionality (sends all local pending requests to backend)
        confirmSendAllButton.addEventListener('click', async () => {
            if (localPendingRequests.length === 0) {
                showFeedbackMessage("No pending requests to confirm.", "info");
                return;
            }

            updateResponseMessage("Confirming and sending all requests...", false);
            const combinedRequestText = localPendingRequests.join('; '); // Combine all requests

            try {
                const response = await fetch('/api/submit_draft_requests/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: JSON.stringify({
                        request_text: combinedRequestText,
                        hotel_id: hotelId,
                        room_number: roomNumber
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    latestRequestId = result.request_id;
                    updateResponseMessage(result.message); // This will be "Your request has been submitted..."
                    localPendingRequests = []; // Clear local list after successful submission
                    renderPendingRequestsList(); // Update UI to show no pending requests

                    // Also clear the AI output box to its default message
                    updateResponseMessage("Welcome! How can I assist you today?", false); 
                    showFeedbackMessage("All requests confirmed and sent!", "success");
                } else {
                    updateResponseMessage(result.error || 'Failed to confirm requests.', true);
                    showFeedbackMessage(result.error || 'Failed to confirm requests.', 'error');
                }
            } catch (error) {
                console.error('Error confirming requests:', error);
                updateResponseMessage('Network error or server issue.', true);
                showFeedbackMessage('Network error or server issue.', 'error');
            }
        });

        // --- Listen Button Functionality (Web Speech API) ---
        let recognition;
        let isListening = false;

        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false; // Listen for a single utterance
            recognition.interimResults = false; // Only return final results
            recognition.lang = 'en-US'; // Set language

            recognition.onstart = () => {
                isListening = true;
                listenButton.classList.add('listening');
                listenButton.innerHTML = '<i class="fas fa-microphone-alt"></i> Listening...';
                userRequestInput.placeholder = "Listening...";
                userRequestInput.disabled = true; // Disable input while listening
                sendButton.disabled = true; // Disable send button
                confirmSendAllButton.disabled = true; // Disable confirm button
                updateResponseMessage("Conci is listening for your request...", false);
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userRequestInput.value = transcript;
                showFeedbackMessage("Speech recognized. Click Send to add.", "info");
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                showFeedbackMessage(`Speech recognition error: ${event.error}`, "error");
                updateResponseMessage("Speech recognition failed. Please type your request.", true);
                resetListenState();
            };

            recognition.onend = () => {
                resetListenState();
            };

            listenButton.addEventListener('click', () => {
                if (isListening) {
                    recognition.stop();
                } else {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error("Error starting speech recognition:", e);
                        showFeedbackMessage("Could not start listening. Please check microphone permissions.", "error");
                        updateResponseMessage("Microphone access denied or not supported.", true);
                        resetListenState();
                    }
                }
            });

            function resetListenState() {
                isListening = false;
                listenButton.classList.remove('listening');
                listenButton.innerHTML = '<i class="fas fa-microphone"></i> Listen';
                userRequestInput.placeholder = "Type your request or click Listen";
                userRequestInput.disabled = false; // Re-enable input
                sendButton.disabled = false; // Re-enable send button
                confirmSendAllButton.disabled = false; // Re-enable confirm button
            }

        } else {
            // Browser does not support Web Speech API
            listenButton.disabled = true;
            listenButton.innerHTML = '<i class="fas fa-microphone-slash"></i> Not Supported';
            showFeedbackMessage("Your browser does not support Web Speech API.", "error");
            console.warn("Web Speech API (webkitSpeechRecognition) not supported in this browser.");
        }

        // Polling for new updates from staff (Conci's responses)
        async function checkForNewUpdates() {
            try {
                const response = await fetch(`/api/guest/${hotelId}/room/${roomNumber}/check_updates/?last_request_id=${latestRequestId}`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    }
                });
                const result = await response.json();

                if (result.has_new_updates) {
                    // Update latestRequestId from the backend's latest request ID
                    latestRequestId = result.updated_request_id; 
                    
                    // Update the main message box with the latest Conci response
                    const latestConciResponse = result.new_messages.slice().reverse().find(msg => msg.role === 'model');
                    if (latestConciResponse) {
                        updateResponseMessage(latestConciResponse.parts[0].text);
                    } else {
                        // If no model response, revert to default message
                        updateResponseMessage("Welcome! How can I assist you today?", false);
                    }

                    // Re-populate localPendingRequests based on the *current* chat_history from the backend
                    localPendingRequests = []; 
                    result.new_messages.forEach(msg => {
                        if (msg.role === 'user') { 
                            localPendingRequests.push(msg.parts[0].text);
                        }
                    });
                    renderPendingRequestsList(); 
                }
            } catch (error) {
                console.error('Error checking for new updates:', error);
            }
        }

        // Poll every 5 seconds (adjust as needed)
        setInterval(checkForNewUpdates, 5000);
    </script>
</body>
</html>
